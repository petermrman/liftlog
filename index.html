<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="LiftLog">
    <meta name="theme-color" content="#0a0a0a">
    <title>LiftLog</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        :root {
            --bg: #0a0a0a; --bg2: #141414; --bg3: #1e1e1e;
            --text: #f5f5f5; --text2: #a0a0a0; --text3: #606060;
            --border: #2a2a2a; --accent: #f59e0b; --success: #22c55e; --danger: #ef4444;
            --blue: #3b82f6; --red: #ef4444; --green: #22c55e; --purple: #a855f7;
            --skip: #6b7280;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; }
        
        /* Header */
        .header { position: sticky; top: 0; z-index: 100; background: var(--bg); border-bottom: 1px solid var(--border); padding: 1rem; }
        .header-content { display: flex; justify-content: space-between; align-items: center; max-width: 500px; margin: 0 auto; }
        .logo { font-size: 1.25rem; font-weight: 700; }
        .logo span { color: var(--accent); }
        .nav { display: flex; gap: 0.25rem; background: var(--bg2); padding: 0.25rem; border-radius: 0.5rem; }
        .nav button { padding: 0.5rem 0.75rem; border: none; background: transparent; color: var(--text2); font-size: 0.875rem; border-radius: 0.375rem; cursor: pointer; }
        .nav button.active { background: var(--bg3); color: var(--text); }
        
        /* Main */
        .main { max-width: 500px; margin: 0 auto; padding: 1rem; }
        .screen { display: none; }
        .screen.active { display: block; }
        
        /* Week & Day */
        .week-bar { text-align: center; padding: 0.75rem; margin-bottom: 1rem; background: var(--bg2); border-radius: 0.5rem; font-size: 0.875rem; }
        .week-bar span { color: var(--accent); font-weight: 600; }
        .days { display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.5rem; margin-bottom: 1rem; }
        .day-btn { padding: 0.75rem 0.5rem; border: 2px solid var(--border); background: var(--bg2); color: var(--text2); font-size: 0.75rem; font-weight: 600; border-radius: 0.75rem; cursor: pointer; text-align: center; }
        .day-btn span { font-size: 1.25rem; display: block; margin-bottom: 0.125rem; }
        .day-btn.active { border-color: var(--accent); color: var(--text); }
        .day-btn.has-data { border-color: var(--success); }
        
        /* Date */
        .date-row { margin-bottom: 1rem; }
        .date-row label { display: block; font-size: 0.75rem; color: var(--text2); margin-bottom: 0.375rem; }
        .date-input { width: 100%; padding: 0.75rem; background: var(--bg2); border: 1px solid var(--border); border-radius: 0.5rem; color: var(--text); font-size: 1rem; }
        .date-input.invalid { border-color: var(--danger); }
        
        /* Exercise Card */
        .ex-card { background: var(--bg2); border: 1px solid var(--border); border-radius: 0.75rem; padding: 1rem; margin-bottom: 0.75rem; }
        .ex-card.done { border-color: var(--success); }
        .ex-card.skipped { border-color: var(--skip); opacity: 0.6; }
        .ex-card.collapsed { padding: 0.75rem 1rem; }
        .ex-card.collapsed .ex-body { display: none; }
        .ex-card.collapsed .ex-head { margin-bottom: 0; }
        .ex-card.collapsed .ex-summary { display: flex; }
        .ex-head { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem; }
        .ex-summary { display: none; font-size: 0.75rem; color: var(--text2); margin-top: 0.25rem; }
        .ex-card.done .ex-summary { color: var(--success); }
        .collapse-btn { padding: 0.25rem 0.5rem; font-size: 0.625rem; background: transparent; border: 1px solid var(--border); border-radius: 0.25rem; color: var(--text3); cursor: pointer; min-width: 1.5rem; }
        .collapse-btn:hover { background: var(--bg3); }
        .ex-card.done .collapse-btn { border-color: var(--success); color: var(--success); }
        .ex-card.done .collapse-btn:hover { background: rgba(34,197,94,0.1); }
        .collapse-all-row { display: flex; justify-content: flex-end; margin-bottom: 0.5rem; }
        .collapse-all-btn { padding: 0.375rem 0.75rem; font-size: 0.75rem; background: var(--bg2); border: 1px solid var(--border); border-radius: 0.375rem; color: var(--text2); cursor: pointer; }
        .collapse-all-btn:hover { background: var(--bg3); }
        .ex-name { font-weight: 600; font-size: 0.9375rem; }
        .ex-rx { font-size: 0.75rem; color: var(--text2); background: var(--bg3); padding: 0.25rem 0.5rem; border-radius: 0.25rem; }
        .ex-hint { font-size: 0.75rem; color: var(--text3); margin-bottom: 0.5rem; }
        .ex-prev { font-size: 0.7rem; color: var(--text2); background: var(--bg3); padding: 0.375rem 0.5rem; border-radius: 0.375rem; margin-bottom: 0.75rem; }
        .ex-prev-date { color: var(--accent); font-weight: 500; }
        
        /* Skip & Swap buttons */
        .ex-btns { display: flex; gap: 0.25rem; margin-left: 0.5rem; }
        .skip-btn, .swap-btn { padding: 0.25rem 0.5rem; font-size: 0.625rem; background: transparent; border: 1px solid var(--border); border-radius: 0.25rem; color: var(--text3); cursor: pointer; }
        .skip-btn.active { border-color: var(--skip); color: var(--skip); background: rgba(107,114,128,0.2); }
        .swap-btn { border-color: var(--blue); color: var(--blue); }
        .swap-menu { position: absolute; top: 100%; right: 0; background: var(--bg2); border: 1px solid var(--border); border-radius: 0.5rem; padding: 0.25rem; z-index: 50; min-width: 10rem; box-shadow: 0 4px 12px rgba(0,0,0,0.5); }
        .swap-menu button { display: block; width: 100%; padding: 0.5rem 0.75rem; border: none; background: transparent; color: var(--text); font-size: 0.75rem; text-align: left; cursor: pointer; border-radius: 0.25rem; }
        .swap-menu button:hover { background: var(--bg3); }
        .ex-head { position: relative; }
        
        /* Equipment selector */
        .equip-row { display: flex; gap: 0.25rem; margin-bottom: 0.75rem; }
        .equip-btn { padding: 0.25rem 0.5rem; font-size: 0.625rem; background: var(--bg3); border: 1px solid var(--border); border-radius: 0.25rem; color: var(--text3); cursor: pointer; }
        .equip-btn.active { border-color: var(--accent); color: var(--accent); }
        
        /* Set Row */
        .set-row { display: flex; align-items: center; gap: 0.375rem; margin-bottom: 0.5rem; flex-wrap: wrap; }
        .set-num { width: 1.5rem; font-size: 0.75rem; color: var(--text3); }
        .set-input { width: 3.5rem; padding: 0.5rem 0.25rem; background: var(--bg3); border: 1px solid var(--border); border-radius: 0.375rem; color: var(--text); font-size: 0.875rem; text-align: center; }
        .set-input:focus { outline: none; border-color: var(--accent); }
        .set-input.warmup { border-style: dashed; opacity: 0.7; }
        .set-unit { font-size: 0.625rem; color: var(--text3); width: 1.5rem; }
        .warmup-btn { padding: 0.25rem 0.5rem; font-size: 0.625rem; background: transparent; border: 1px solid var(--border); border-radius: 0.25rem; color: var(--text3); cursor: pointer; }
        .warmup-btn.active { border-color: var(--accent); color: var(--accent); }
        .add-btn { width: 2.5rem; height: 2rem; border: 1px dashed var(--border); background: transparent; color: var(--text3); border-radius: 0.375rem; cursor: pointer; font-size: 1.25rem; margin-top: 0.25rem; }
        
        /* Notes */
        .notes-input { width: 100%; margin-top: 0.5rem; padding: 0.5rem; background: var(--bg3); border: 1px solid var(--border); border-radius: 0.375rem; color: var(--text); font-size: 0.75rem; resize: none; min-height: 2.5rem; }
        .notes-input::placeholder { color: var(--text3); }
        
        /* Check */
        .check-row { display: flex; align-items: center; gap: 0.75rem; }
        .check-btn { width: 2.5rem; height: 2.5rem; border: 2px solid var(--border); background: var(--bg3); border-radius: 0.5rem; cursor: pointer; font-size: 1.25rem; color: var(--text3); }
        .check-btn.checked { border-color: var(--success); background: rgba(34,197,94,0.2); color: var(--success); }
        
        /* Buttons */
        .save-btn { width: 100%; padding: 1rem; margin-top: 1rem; background: var(--accent); border: none; border-radius: 0.75rem; color: #000; font-size: 1rem; font-weight: 600; cursor: pointer; }
        .save-btn:disabled { opacity: 0.4; cursor: not-allowed; }
        .actions { display: flex; gap: 0.5rem; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border); }
        .action-btn { flex: 1; padding: 0.75rem; background: var(--bg2); border: 1px solid var(--border); border-radius: 0.5rem; color: var(--text2); font-size: 0.875rem; cursor: pointer; }
        .week-select { flex: 1; padding: 0.75rem; background: var(--bg2); border: 1px solid var(--border); border-radius: 0.5rem; color: var(--text); font-size: 0.875rem; }
        
        /* History */
        .hist-card { background: var(--bg2); border: 1px solid var(--border); border-radius: 0.75rem; padding: 1rem; margin-bottom: 0.75rem; cursor: pointer; }
        .hist-top { display: flex; justify-content: space-between; margin-bottom: 0.5rem; }
        .hist-date { font-size: 0.875rem; }
        .hist-day { font-size: 0.75rem; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-weight: 600; }
        .hist-day.A { background: rgba(59,130,246,0.2); color: var(--blue); }
        .hist-day.B { background: rgba(239,68,68,0.2); color: var(--red); }
        .hist-day.C { background: rgba(34,197,94,0.2); color: var(--green); }
        .hist-day.D { background: rgba(168,85,247,0.2); color: var(--purple); }
        .hist-lift { font-weight: 600; margin-bottom: 0.25rem; }
        .hist-summary { font-size: 0.75rem; color: var(--text2); }
        
        /* Progress */
        .prog-btns { display: flex; gap: 0.5rem; margin-bottom: 1rem; overflow-x: auto; }
        .prog-btn { padding: 0.5rem 0.75rem; background: var(--bg2); border: 1px solid var(--border); border-radius: 0.5rem; color: var(--text2); font-size: 0.875rem; cursor: pointer; white-space: nowrap; }
        .prog-btn.active { border-color: var(--accent); color: var(--text); }
        .prog-chart { background: var(--bg2); border: 1px solid var(--border); border-radius: 0.75rem; padding: 1rem; }
        .prog-title { font-size: 0.75rem; color: var(--text2); margin-bottom: 1rem; }
        .prog-row { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; }
        .prog-date { font-size: 0.625rem; color: var(--text3); width: 3rem; }
        .prog-bar-bg { flex: 1; height: 1.25rem; background: var(--bg3); border-radius: 0.25rem; overflow: hidden; }
        .prog-bar { height: 100%; background: var(--accent); border-radius: 0.25rem; }
        .prog-val { font-size: 0.75rem; width: 2.5rem; text-align: right; }
        
        /* Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.95); z-index: 200; overflow-y: auto; }
        .modal.show { display: block; }
        .modal-inner { max-width: 500px; margin: 1rem auto; padding: 1rem; }
        .modal-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border); }
        .modal-title { font-size: 1.125rem; font-weight: 600; }
        .modal-close { width: 2.5rem; height: 2.5rem; border: none; background: var(--bg2); color: var(--text); font-size: 1.25rem; border-radius: 0.5rem; cursor: pointer; }
        .modal-date { font-size: 0.875rem; color: var(--text2); margin-bottom: 1rem; }
        .modal-btns { display: flex; gap: 0.5rem; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border); }
        .modal-btn { flex: 1; padding: 0.75rem; border: none; border-radius: 0.5rem; font-size: 0.875rem; font-weight: 600; cursor: pointer; }
        .modal-btn.save { background: var(--accent); color: #000; }
        .modal-btn.delete { background: var(--danger); color: #fff; }
        .modal-btn.cancel { background: var(--bg2); color: var(--text2); border: 1px solid var(--border); }
        
        /* Empty & Toast */
        .empty { text-align: center; padding: 3rem 1rem; color: var(--text2); }
        .toast { position: fixed; bottom: 2rem; left: 50%; transform: translateX(-50%) translateY(100px); background: var(--success); color: #000; padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-weight: 600; opacity: 0; transition: all 0.3s; z-index: 300; }
        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
        .file-input { display: none; }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="logo">LIFT<span>LOG</span></div>
            <nav class="nav">
                <button data-screen="dashboard">Home</button>
                <button class="active" data-screen="new">Nieuw</button>
                <button data-screen="history">Log</button>
                <button data-screen="progress">Stats</button>
            </nav>
        </div>
    </header>

    <main class="main">
        <section id="screen-new" class="screen active">
            <div class="week-bar">Week <span id="week-num">1</span> | RPE 6-7</div>
            <div class="days" id="day-btns">
                <button class="day-btn" data-day="A"><span>A</span>Squat</button>
                <button class="day-btn" data-day="B"><span>B</span>Bench</button>
                <button class="day-btn" data-day="C"><span>C</span>Deadlift</button>
                <button class="day-btn" data-day="D"><span>D</span>Push Press</button>
            </div>
            <div class="date-row">
                <label>Datum (DD-MM-YYYY)</label>
                <input type="text" class="date-input" id="date-input" placeholder="29-12-2025" inputmode="numeric">
            </div>
            <div class="collapse-all-row" id="collapse-all-row" style="display:none;">
                <button class="collapse-all-btn" id="collapse-all-btn">‚ñº Alles inklappen</button>
            </div>
            <div id="exercises"></div>
            <button class="save-btn" id="save-btn" disabled>Training Opslaan</button>
            <div class="actions">
                <select class="week-select" id="week-select"><option value="all">Alle weken</option></select>
                <button class="action-btn" id="export-btn">üì§ Export</button>
                <button class="action-btn" id="import-btn">üì• Import</button>
            </div>
            <input type="file" class="file-input" id="file-input" accept=".csv">
        </section>

        <section id="screen-history" class="screen">
            <div id="history"></div>
        </section>

        <section id="screen-progress" class="screen">
            <div class="prog-btns">
                <button class="prog-btn active" data-lift="Back Squat">Squat</button>
                <button class="prog-btn" data-lift="Bench Press">Bench</button>
                <button class="prog-btn" data-lift="Conventional Deadlift">Deadlift</button>
                <button class="prog-btn" data-lift="Push Press">Push Press</button>
            </div>
            <div class="prog-chart">
                <div class="prog-title">Topset Progressie (kg)</div>
                <div id="progress"></div>
            </div>
        </section>
    </main>

    <div class="modal" id="modal">
        <div class="modal-inner">
            <div class="modal-head">
                <span class="modal-title" id="modal-title"></span>
                <button class="modal-close" id="modal-close">‚úï</button>
            </div>
            <div class="modal-date" id="modal-date"></div>
            <div id="modal-body"></div>
            <div class="modal-btns">
                <button class="modal-btn cancel" id="btn-cancel">Annuleren</button>
                <button class="modal-btn delete" id="btn-delete">Verwijder</button>
                <button class="modal-btn save" id="btn-save">Opslaan</button>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
    (function() {
        'use strict';

        // ===========================================
        // EXERCISES DATABASE
        // ===========================================
        const EXERCISES = {
            // SQUAT PATTERN
            back_squat: { id: 'back_squat', name: 'Back Squat', pattern: 'squat', equipment: ['barbell'], muscles: { primary: ['quads', 'glutes'], secondary: ['core'] }, isMainLift: true, hint: 'Diepte boven gewicht' },
            front_squat: { id: 'front_squat', name: 'Front Squat', pattern: 'squat', equipment: ['barbell'], muscles: { primary: ['quads'], secondary: ['core', 'upper_back'] }, hint: 'Ellebogen hoog' },
            goblet_squat: { id: 'goblet_squat', name: 'Goblet Squat', pattern: 'squat', equipment: ['dumbbell', 'kettlebell'], muscles: { primary: ['quads', 'glutes'], secondary: ['core'] }, hint: 'Core aan' },
            bulgarian_split_squat: { id: 'bulgarian_split_squat', name: 'Bulgarian Split Squat', pattern: 'squat', equipment: ['dumbbell', 'kettlebell', 'bodyweight'], muscles: { primary: ['quads', 'glutes'], secondary: ['core'] }, unilateral: true, hint: 'Per been' },
            leg_press: { id: 'leg_press', name: 'Leg Press', pattern: 'squat', equipment: ['machine'], muscles: { primary: ['quads', 'glutes'], secondary: [] }, hint: 'Voeten hoog voor glutes' },
            leg_press_uni: { id: 'leg_press_uni', name: 'Leg Press uni', pattern: 'squat', equipment: ['machine'], muscles: { primary: ['quads', 'glutes'], secondary: [] }, unilateral: true, hint: 'Voet hoog' },
            hack_squat: { id: 'hack_squat', name: 'Hack Squat', pattern: 'squat', equipment: ['machine'], muscles: { primary: ['quads'], secondary: ['glutes'] }, hint: 'Lage voetplaatsing' },
            lunges: { id: 'lunges', name: 'Lunges', pattern: 'squat', equipment: ['dumbbell', 'bodyweight'], muscles: { primary: ['quads', 'glutes'], secondary: ['core'] }, unilateral: true, hint: 'Stap ver genoeg' },

            // HINGE PATTERN
            conventional_deadlift: { id: 'conventional_deadlift', name: 'Conventional Deadlift', pattern: 'hinge', equipment: ['barbell'], muscles: { primary: ['hamstrings', 'glutes', 'lower_back'], secondary: ['lats', 'traps', 'grip'] }, isMainLift: true, hint: 'Rug neutraal!' },
            romanian_deadlift: { id: 'romanian_deadlift', name: 'Romanian Deadlift', pattern: 'hinge', equipment: ['barbell', 'dumbbell'], muscles: { primary: ['hamstrings', 'glutes'], secondary: ['lower_back'] }, hint: 'Hamstrings voelen' },
            stiff_leg_deadlift: { id: 'stiff_leg_deadlift', name: 'Stiff Leg Deadlift', pattern: 'hinge', equipment: ['barbell', 'dumbbell'], muscles: { primary: ['hamstrings'], secondary: ['glutes', 'lower_back'] }, hint: 'Benen bijna gestrekt' },
            good_morning: { id: 'good_morning', name: 'Good Morning', pattern: 'hinge', equipment: ['barbell'], muscles: { primary: ['hamstrings', 'lower_back'], secondary: ['glutes'] }, hint: 'Licht gewicht' },
            hip_thrust: { id: 'hip_thrust', name: 'Hip Thrust', pattern: 'hinge', equipment: ['barbell', 'machine'], muscles: { primary: ['glutes'], secondary: ['hamstrings'] }, hint: 'Squeeze bovenaan' },
            hip_hinge_stick: { id: 'hip_hinge_stick', name: 'Hip Hinge met stok', pattern: 'activation', equipment: ['bodyweight'], muscles: { primary: ['hamstrings'], secondary: [] }, isActivation: true, isCheck: true, hint: 'Techniek check' },

            // PUSH HORIZONTAL
            bench_press: { id: 'bench_press', name: 'Bench Press', pattern: 'push_horizontal', equipment: ['barbell'], muscles: { primary: ['chest', 'triceps'], secondary: ['front_delts'] }, isMainLift: true, hint: 'Schouderbladen gepind' },
            incline_db_press: { id: 'incline_db_press', name: 'Incline DB Press', pattern: 'push_horizontal', equipment: ['dumbbell'], muscles: { primary: ['upper_chest', 'triceps'], secondary: ['front_delts'] }, angle: 'incline', hint: 'Bank 30-45¬∞' },
            incline_barbell_press: { id: 'incline_barbell_press', name: 'Incline Barbell Press', pattern: 'push_horizontal', equipment: ['barbell'], muscles: { primary: ['upper_chest', 'triceps'], secondary: ['front_delts'] }, angle: 'incline', hint: 'Bank 30¬∞' },
            dumbbell_bench_press: { id: 'dumbbell_bench_press', name: 'Dumbbell Bench Press', pattern: 'push_horizontal', equipment: ['dumbbell'], muscles: { primary: ['chest', 'triceps'], secondary: ['front_delts'] }, hint: 'Volle ROM' },
            dips: { id: 'dips', name: 'Dips', pattern: 'push_horizontal', equipment: ['bodyweight'], muscles: { primary: ['chest', 'triceps'], secondary: ['front_delts'] }, hint: 'BW = bodyweight' },
            machine_chest_press: { id: 'machine_chest_press', name: 'Machine Chest Press', pattern: 'push_horizontal', equipment: ['machine'], muscles: { primary: ['chest', 'triceps'], secondary: ['front_delts'] }, hint: 'Squeeze bovenaan' },

            // PUSH VERTICAL
            push_press: { id: 'push_press', name: 'Push Press', pattern: 'push_vertical', equipment: ['barbell'], muscles: { primary: ['shoulders', 'triceps'], secondary: ['upper_chest', 'core'] }, isMainLift: true, hint: 'Explosief uit dip' },
            overhead_press: { id: 'overhead_press', name: 'Overhead Press', pattern: 'push_vertical', equipment: ['barbell'], muscles: { primary: ['shoulders', 'triceps'], secondary: ['core'] }, hint: 'Strict form' },
            dumbbell_shoulder_press: { id: 'dumbbell_shoulder_press', name: 'DB Shoulder Press', pattern: 'push_vertical', equipment: ['dumbbell'], muscles: { primary: ['shoulders', 'triceps'], secondary: [] }, hint: 'Neutrale grip optie' },
            landmine_press: { id: 'landmine_press', name: 'Landmine Press', pattern: 'push_vertical', equipment: ['barbell'], muscles: { primary: ['shoulders', 'chest'], secondary: ['core'] }, hint: 'Schouder-vriendelijk' },

            // PULL HORIZONTAL
            cable_row: { id: 'cable_row', name: 'Cable Row', pattern: 'pull_horizontal', equipment: ['cable'], muscles: { primary: ['lats', 'rhomboids'], secondary: ['biceps', 'rear_delts'] }, hint: 'Scapula squeeze' },
            seated_cable_row: { id: 'seated_cable_row', name: 'Seated Cable Row', pattern: 'pull_horizontal', equipment: ['cable'], muscles: { primary: ['lats', 'rhomboids'], secondary: ['biceps', 'rear_delts'] }, hint: 'Scapula squeeze' },
            chest_supported_row: { id: 'chest_supported_row', name: 'Chest Supported Row', pattern: 'pull_horizontal', equipment: ['machine', 'dumbbell'], muscles: { primary: ['lats', 'rhomboids'], secondary: ['biceps', 'rear_delts'] }, hint: 'Scapula focus' },
            dumbbell_row: { id: 'dumbbell_row', name: 'Dumbbell Row', pattern: 'pull_horizontal', equipment: ['dumbbell'], muscles: { primary: ['lats', 'rhomboids'], secondary: ['biceps', 'rear_delts'] }, unilateral: true, hint: 'Per arm' },
            barbell_row: { id: 'barbell_row', name: 'Barbell Row', pattern: 'pull_horizontal', equipment: ['barbell'], muscles: { primary: ['lats', 'rhomboids'], secondary: ['biceps', 'lower_back'] }, hint: '45¬∞ torso' },
            t_bar_row: { id: 't_bar_row', name: 'T-Bar Row', pattern: 'pull_horizontal', equipment: ['barbell'], muscles: { primary: ['lats', 'rhomboids'], secondary: ['biceps'] }, hint: 'Borst op pad' },
            face_pulls: { id: 'face_pulls', name: 'Face Pulls', pattern: 'pull_horizontal', equipment: ['cable'], muscles: { primary: ['rear_delts', 'rhomboids'], secondary: ['external_rotators'] }, isAccessory: true, hint: 'Ellebogen hoog' },

            // PULL VERTICAL
            lat_pulldown: { id: 'lat_pulldown', name: 'Lat Pulldown', pattern: 'pull_vertical', equipment: ['cable'], muscles: { primary: ['lats'], secondary: ['biceps', 'rear_delts'] }, hint: 'Voorzichtig lat!' },
            pull_ups: { id: 'pull_ups', name: 'Pull Ups', pattern: 'pull_vertical', equipment: ['bodyweight'], muscles: { primary: ['lats'], secondary: ['biceps', 'rear_delts'] }, hint: 'Volle ROM' },
            chin_ups: { id: 'chin_ups', name: 'Chin Ups', pattern: 'pull_vertical', equipment: ['bodyweight'], muscles: { primary: ['lats', 'biceps'], secondary: ['rear_delts'] }, hint: 'Onderhandse grip' },
            neutral_grip_pulldown: { id: 'neutral_grip_pulldown', name: 'Neutral Grip Pulldown', pattern: 'pull_vertical', equipment: ['cable'], muscles: { primary: ['lats'], secondary: ['biceps'] }, hint: 'Schouder-vriendelijk' },

            // CARRY / GRIP
            dead_hang: { id: 'dead_hang', name: 'Dead Hang', pattern: 'carry', equipment: ['bodyweight'], muscles: { primary: ['grip', 'lats'], secondary: ['core'] }, isTimed: true, hint: 'Max hold' },
            btbbh: { id: 'btbbh', name: 'BTBBH', pattern: 'carry', equipment: ['barbell'], muscles: { primary: ['grip', 'traps'], secondary: ['core'] }, isTimed: true, hint: '2x max hold' },
            farmer_walk: { id: 'farmer_walk', name: 'Farmer Walk', pattern: 'carry', equipment: ['dumbbell', 'kettlebell'], muscles: { primary: ['grip', 'traps', 'core'], secondary: [] }, isTimed: true, hint: 'Schouders laag' },

            // ACTIVATION
            scapula_retractions: { id: 'scapula_retractions', name: 'Scapula Retractions', pattern: 'activation', equipment: ['bodyweight'], muscles: { primary: ['rhomboids', 'mid_traps'], secondary: [] }, isActivation: true, isCheck: true, hint: 'Activatie' },
            band_pull_aparts: { id: 'band_pull_aparts', name: 'Band Pull Aparts', pattern: 'activation', equipment: ['band'], muscles: { primary: ['rear_delts', 'rhomboids'], secondary: [] }, isActivation: true, hint: 'Lichte band' }
        };

        // ===========================================
        // TRAINING TEMPLATES (slot-based)
        // ===========================================
        const SLOT_TEMPLATES = {
            A: {
                name: 'Squat',
                mainLift: 'back_squat',
                slots: [
                    { order: 1, role: 'main', exerciseId: 'back_squat', sets: 4, reps: 5 },
                    { order: 2, role: 'accessory', pattern: 'hinge', sets: 3, reps: 10, exclude: ['conventional_deadlift'] },
                    { order: 3, role: 'accessory', pattern: 'push_horizontal', angle: 'incline', sets: 3, reps: 10 },
                    { order: 4, role: 'accessory', pattern: 'pull_horizontal', sets: 3, reps: 10 },
                    { order: 5, role: 'finisher', pattern: 'carry', sets: 1, isTimed: true }
                ]
            },
            B: {
                name: 'Bench Press',
                mainLift: 'bench_press',
                slots: [
                    { order: 1, role: 'activation', exerciseId: 'scapula_retractions', sets: 2, reps: 15 },
                    { order: 2, role: 'main', exerciseId: 'bench_press', sets: 4, reps: 5 },
                    { order: 3, role: 'accessory', pattern: 'pull_horizontal', sets: 3, reps: 10 },
                    { order: 4, role: 'accessory', pattern: 'squat', prefer: 'unilateral', sets: 3, reps: 10 },
                    { order: 5, role: 'accessory', exerciseId: 'face_pulls', sets: 2, reps: 15 },
                    { order: 6, role: 'finisher', exerciseId: 'btbbh', sets: 2, isTimed: true }
                ]
            },
            C: {
                name: 'Deadlift',
                mainLift: 'conventional_deadlift',
                slots: [
                    { order: 1, role: 'activation', exerciseId: 'hip_hinge_stick', sets: 2, reps: 8 },
                    { order: 2, role: 'main', exerciseId: 'conventional_deadlift', sets: 4, reps: 5 },
                    { order: 3, role: 'accessory', pattern: 'squat', prefer: 'unilateral', sets: 3, reps: 10 },
                    { order: 4, role: 'accessory', pattern: 'pull_horizontal', prefer: 'unilateral', sets: 3, reps: 10 },
                    { order: 5, role: 'accessory', pattern: 'push_horizontal', sets: 3, reps: 10 },
                    { order: 6, role: 'finisher', exerciseId: 'dead_hang', sets: 1, isTimed: true }
                ]
            },
            D: {
                name: 'Push Press',
                mainLift: 'push_press',
                slots: [
                    { order: 1, role: 'activation', exerciseId: 'scapula_retractions', sets: 2, reps: 15 },
                    { order: 2, role: 'main', exerciseId: 'push_press', sets: 4, reps: 5 },
                    { order: 3, role: 'accessory', pattern: 'pull_vertical', sets: 3, reps: 10 },
                    { order: 4, role: 'accessory', pattern: 'squat', exclude: ['back_squat', 'front_squat'], sets: 3, reps: 10 },
                    { order: 5, role: 'accessory', pattern: 'pull_horizontal', sets: 3, reps: 10 },
                    { order: 6, role: 'finisher', exerciseId: 'btbbh', sets: 2, isTimed: true }
                ]
            }
        };

        // Initial data
        const INIT = [
            { id: 1, date: '2025-12-22', day: 'D', lift: 'Push Press', week: 2, exercises: [
                { name: 'Scapula Retractions', type: 'check', done: true },
                { name: 'Push Press', type: 'weight', sets: [{w:'20',r:'10',warmup:true},{w:'30',r:'10',warmup:true},{w:'40',r:'5'},{w:'45',r:'5'},{w:'50',r:'5'}]},
                { name: 'Lat Pulldown', type: 'weight', sets: [{w:'75',r:'10'},{w:'85',r:'10'},{w:'95',r:'10'}]},
                { name: 'Goblet Squat', type: 'weight', sets: [{w:'20',r:'10'},{w:'28',r:'10'},{w:'32',r:'10'}], equip: 'KB'},
                { name: 'Seated Cable Row', type: 'weight', sets: [{w:'75',r:'10'},{w:'85',r:'10'},{w:'95',r:'10'}]},
                { name: 'BTBBH', type: 'timed', sets: [], skipped: true, skipReason: 'Geen mogelijkheid in gym'}
            ]},
            { id: 2, date: '2025-12-20', day: 'C', lift: 'Deadlift', week: 1, exercises: [
                { name: 'Hip Hinge met stok', type: 'check', done: true },
                { name: 'Conventional Deadlift', type: 'weight', sets: [{w:'70',r:'5',warmup:true},{w:'90',r:'5'},{w:'100',r:'5'},{w:'110',r:'5'}]},
                { name: 'Leg Press uni', type: 'weight', sets: [{w:'40',r:'10'},{w:'60',r:'10'},{w:'70',r:'10'}]},
                { name: 'Dumbbell Row', type: 'weight', sets: [{w:'24',r:'10'},{w:'26',r:'10'},{w:'28',r:'10'}]},
                { name: 'Dips', type: 'weight', sets: [{w:'BW',r:'10'},{w:'BW',r:'10'},{w:'BW',r:'10'}]},
                { name: 'Dead Hang', type: 'timed', sets: [{w:'BW',t:'50'}]}
            ]},
            { id: 3, date: '2025-12-17', day: 'B', lift: 'Bench Press', week: 1, exercises: [
                { name: 'Scapula Retractions', type: 'check', done: true },
                { name: 'Bench Press', type: 'weight', sets: [{w:'20',r:'5',warmup:true},{w:'50',r:'5'},{w:'70',r:'5'},{w:'80',r:'5'},{w:'85',r:'5'},{w:'90',r:'5'}]},
                { name: 'Chest Supported Row', type: 'weight', sets: [{w:'30',r:'10'},{w:'40',r:'10'},{w:'50',r:'10'}]},
                { name: 'Bulgarian Split Squat', type: 'weight', sets: [{w:'20',r:'10'},{w:'20',r:'10'},{w:'20',r:'10'}]},
                { name: 'Face Pulls', type: 'weight', sets: [{w:'40',r:'15'},{w:'45',r:'15'}]},
                { name: 'BTBBH', type: 'timed', sets: [{w:'60',t:'60'},{w:'60',t:'40'}]}
            ]},
            { id: 4, date: '2025-12-15', day: 'A', lift: 'Squat', week: 1, exercises: [
                { name: 'Back Squat', type: 'weight', sets: [{w:'20',r:'5',warmup:true},{w:'40',r:'5'},{w:'50',r:'5'},{w:'60',r:'5'}]},
                { name: 'Romanian Deadlift', type: 'weight', sets: [{w:'20',r:'10',warmup:true},{w:'50',r:'10'},{w:'70',r:'10'},{w:'80',r:'10'}]},
                { name: 'Incline DB Press', type: 'weight', sets: [{w:'48',r:'10'},{w:'56',r:'10'},{w:'60',r:'10'}]},
                { name: 'Cable Row', type: 'weight', sets: [{w:'75',r:'10'},{w:'85',r:'10'},{w:'95',r:'10'}]},
                { name: 'Dead Hang', type: 'timed', sets: [{w:'BW',t:'20'}]}
            ]}
        ];

        // State
        let data = JSON.parse(localStorage.getItem('liftlog3')) || INIT;
        if (!localStorage.getItem('liftlog3')) localStorage.setItem('liftlog3', JSON.stringify(INIT));
        let selectedDay = null;
        let current = null;
        let editIdx = null;
        let editData = null;
        let globalCollapsed = false; // Onthoudt of alles ingeklapt moet zijn

        // DOM
        const $ = id => document.getElementById(id);
        const exEl = $('exercises');
        const saveBtn = $('save-btn');
        const dateInput = $('date-input');
        const modal = $('modal');
        const modalBody = $('modal-body');
        const toast = $('toast');
        const collapseAllRow = $('collapse-all-row');
        const collapseAllBtn = $('collapse-all-btn');

        // Date helpers
        const toDisplayDate = d => { const p = d.split('-'); return p[2] + '-' + p[1] + '-' + p[0]; }; // YYYY-MM-DD -> DD-MM-YYYY
        const toISODate = d => { const p = d.split('-'); return p[2] + '-' + p[1] + '-' + p[0]; }; // DD-MM-YYYY -> YYYY-MM-DD
        const isValidDate = d => { const p = d.split('-'); if (p.length !== 3) return false; const [dd,mm,yyyy] = p.map(Number); if (!dd||!mm||!yyyy) return false; const dt = new Date(yyyy,mm-1,dd); return dt.getDate()===dd && dt.getMonth()===mm-1 && dt.getFullYear()===yyyy; };

        // Init
        const today = new Date();
        dateInput.value = today.getDate().toString().padStart(2,'0') + '-' + (today.getMonth()+1).toString().padStart(2,'0') + '-' + today.getFullYear();
        const wk = Math.max(1, Math.ceil((new Date() - new Date('2025-12-15')) / 604800000));
        $('week-num').textContent = wk;

        // Date input validation
        dateInput.oninput = () => {
            let v = dateInput.value.replace(/[^\d-]/g, '');
            // Auto-insert dashes
            if (v.length === 2 && !v.includes('-')) v += '-';
            if (v.length === 5 && v.split('-').length === 2) v += '-';
            dateInput.value = v;
            dateInput.classList.toggle('invalid', v.length >= 10 && !isValidDate(v));
        };

        // Helpers
        const showToast = msg => { toast.textContent = msg; toast.classList.add('show'); setTimeout(() => toast.classList.remove('show'), 2000); };
        const fmtDate = d => { const dt = new Date(d); return ['Zo','Ma','Di','Wo','Do','Vr','Za'][dt.getDay()] + ' ' + dt.getDate() + '-' + (dt.getMonth()+1); };
        const getPrev = (day, name) => { const t = data.find(x => x.day === day); return t ? t.exercises.find(e => e.name === name) : null; };
        const getPrevWithDate = name => {
            for (const t of data) {
                const ex = t.exercises.find(e => e.name === name && !e.skipped);
                if (ex && (ex.done || (ex.sets && ex.sets.length))) return { date: t.date, ex };
            }
            return null;
        };
        const save = () => localStorage.setItem('liftlog3', JSON.stringify(data));

        // ===========================================
        // SMART SELECTION LOGIC
        // ===========================================
        function getRecentExerciseIds(days = 3) {
            const cutoff = new Date();
            cutoff.setDate(cutoff.getDate() - days);
            return data
                .filter(t => new Date(t.date) >= cutoff)
                .flatMap(t => t.exercises.map(ex => ex.id || ex.name))
                .filter(Boolean);
        }

        function selectExerciseForSlot(slot) {
            // 1. Als slot een vast exerciseId heeft, gebruik die
            if (slot.exerciseId) {
                return EXERCISES[slot.exerciseId];
            }

            // 2. Filter oefeningen op pattern
            let candidates = Object.values(EXERCISES)
                .filter(ex => ex.pattern === slot.pattern);

            // 3. Filter op angle indien gespecificeerd
            if (slot.angle) {
                const withAngle = candidates.filter(ex => ex.angle === slot.angle);
                if (withAngle.length > 0) candidates = withAngle;
            }

            // 4. Filter op unilateral indien preferred
            if (slot.prefer === 'unilateral') {
                const unilateral = candidates.filter(ex => ex.unilateral);
                if (unilateral.length > 0) candidates = unilateral;
            }

            // 5. Exclude specifieke oefeningen
            if (slot.exclude) {
                candidates = candidates.filter(ex => !slot.exclude.includes(ex.id));
            }

            // 6. Exclude main lifts voor accessory slots
            if (slot.role === 'accessory') {
                candidates = candidates.filter(ex => !ex.isMainLift);
            }

            // 7. Exclude recent gedane oefeningen (laatste 3 trainingen)
            const recentIds = getRecentExerciseIds(7);
            const notRecent = candidates.filter(ex => !recentIds.includes(ex.id) && !recentIds.includes(ex.name));

            // 8. Als er niet-recente opties zijn, gebruik die
            if (notRecent.length > 0) {
                candidates = notRecent;
            }

            // 9. Return random uit overgebleven candidates
            if (candidates.length === 0) return null;
            return candidates[Math.floor(Math.random() * candidates.length)];
        }

        function getAlternativesForExercise(exercise) {
            // Vind alternatieven met hetzelfde pattern
            return Object.values(EXERCISES)
                .filter(ex => ex.pattern === exercise.pattern && ex.id !== exercise.id && !ex.isMainLift && !ex.isActivation)
                .sort((a, b) => a.name.localeCompare(b.name));
        }

        // Update day buttons to show which have data
        function updateDayButtons() {
            const daysWithData = new Set(data.map(t => t.day));
            document.querySelectorAll('.day-btn').forEach(btn => {
                btn.classList.toggle('has-data', daysWithData.has(btn.dataset.day));
            });
        }
        updateDayButtons();

        // Nav
        document.querySelectorAll('.nav button').forEach(btn => {
            btn.onclick = () => {
                document.querySelectorAll('.nav button').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                $('screen-' + btn.dataset.screen).classList.add('active');
                if (btn.dataset.screen === 'history') renderHistory();
                if (btn.dataset.screen === 'progress') renderProgress();
            };
        });

        // Day selection
        document.querySelectorAll('.day-btn').forEach(btn => {
            btn.onclick = () => {
                document.querySelectorAll('.day-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                selectedDay = btn.dataset.day;
                buildForm();
            };
        });

        // Build form using smart selection
        function buildForm() {
            if (!selectedDay) { exEl.innerHTML = ''; return; }
            const tmpl = SLOT_TEMPLATES[selectedDay];

            current = {
                day: selectedDay,
                lift: tmpl.name,
                exercises: tmpl.slots.map(slot => {
                    // Selecteer oefening voor deze slot
                    const exercise = selectExerciseForSlot(slot);
                    if (!exercise) return null;

                    // Bepaal type
                    const type = exercise.isCheck || exercise.isActivation && exercise.isCheck ? 'check' :
                                 exercise.isTimed || slot.isTimed ? 'timed' : 'weight';

                    // Zoek vorige data voor deze oefening
                    const prev = getPrev(selectedDay, exercise.name);

                    // Basis exercise object
                    const ex = {
                        id: exercise.id,
                        name: exercise.name,
                        pattern: exercise.pattern,
                        sets: slot.sets,
                        reps: slot.reps || null,
                        type: type,
                        hint: exercise.hint || '',
                        role: slot.role,
                        canSwap: slot.role === 'accessory' || slot.role === 'finisher',
                        skipped: false,
                        collapsed: globalCollapsed, // Gebruik globale collapsed state
                        notes: ''
                    };

                    // Equipment opties
                    if (exercise.equipment && exercise.equipment.length > 1) {
                        ex.hasEquip = true;
                        ex.equipOptions = exercise.equipment;
                        ex.equip = prev?.equip || '';
                    }

                    // Sets data
                    if (type === 'check') {
                        ex.done = false;
                    } else if (type === 'timed') {
                        ex.setsData = prev?.sets?.length
                            ? prev.sets.map(s => ({w: s.w||'', t: s.t||''}))
                            : Array(slot.sets).fill().map(() => ({w:'',t:''}));
                    } else {
                        ex.setsData = prev?.sets?.length
                            ? prev.sets.map(s => ({w: s.w||'', r: s.r||slot.reps, warmup: s.warmup||false}))
                            : Array(slot.sets).fill().map(() => ({w:'',r:slot.reps,warmup:false}));
                        while (ex.setsData.length < slot.sets) {
                            ex.setsData.push({w:'',r:slot.reps,warmup:false});
                        }
                    }

                    return ex;
                }).filter(Boolean)
            };
            renderForm();
        }

        // Swap exercise
        function swapExercise(ei, newExerciseId, isOriginal) {
            const ex = current.exercises[ei];
            const newExercise = EXERCISES[newExerciseId];
            if (!newExercise) return;

            if (isOriginal) {
                // Terug naar origineel
                ex.id = ex.originalId;
                ex.name = ex.originalName;
                ex.pattern = ex.originalPattern;
                ex.hint = EXERCISES[ex.originalId]?.hint || '';
                delete ex.originalId;
                delete ex.originalName;
                delete ex.originalPattern;
            } else {
                // Sla origineel op als nog niet gedaan
                if (!ex.originalId) {
                    ex.originalId = ex.id;
                    ex.originalName = ex.name;
                    ex.originalPattern = ex.pattern;
                }
                // Wissel naar nieuwe oefening
                ex.id = newExercise.id;
                ex.name = newExercise.name;
                ex.pattern = newExercise.pattern;
                ex.hint = newExercise.hint || '';
            }

            // Update equipment opties
            const exercise = EXERCISES[ex.id];
            if (exercise?.equipment?.length > 1) {
                ex.hasEquip = true;
                ex.equipOptions = exercise.equipment;
            } else {
                ex.hasEquip = false;
                delete ex.equipOptions;
            }
            ex.equip = '';

            // Reset sets data
            ex.setsData = Array(ex.sets).fill().map(() => ex.type === 'timed' ? {w:'',t:''} : {w:'',r:ex.reps||'',warmup:false});
            renderForm();
        }

        // Render form
        function renderForm() {
            let html = '';
            current.exercises.forEach((ex, ei) => {
                const done = ex.skipped ? false : (ex.type === 'check' ? ex.done : ex.setsData?.some(s => s.w || s.t));
                const isCollapsed = ex.collapsed && !ex.skipped;
                const cardClass = (ex.skipped ? 'skipped' : (done ? 'done' : '')) + (isCollapsed ? ' collapsed' : '');

                // Summary voor ingeklapte weergave
                let summaryText = '';
                if (!ex.skipped) {
                    if (ex.type === 'check') {
                        summaryText = ex.done ? '‚úì' : '‚óã';
                    } else if (ex.setsData) {
                        const filledSets = ex.setsData.filter(s => s.w || s.t);
                        if (filledSets.length > 0) {
                            if (ex.type === 'timed') {
                                summaryText = filledSets.map(s => `${s.w}√ó${s.t}s`).join(' / ');
                            } else {
                                summaryText = filledSets.filter(s => !s.warmup).map(s => `${s.w}√ó${s.r}`).join(' / ');
                            }
                        } else {
                            summaryText = `${ex.sets}√ó${ex.reps || 'max'} (leeg)`;
                        }
                    }
                }

                const prev = getPrevWithDate(ex.name);
                let prevHtml = '';
                if (prev) {
                    if (prev.ex.type === 'check') {
                        prevHtml = `<div class="ex-prev"><span class="ex-prev-date">${fmtDate(prev.date)}</span> ‚úì</div>`;
                    } else if (prev.ex.sets && prev.ex.sets.length) {
                        const setsStr = prev.ex.sets.map(s => s.warmup ? '' : (prev.ex.type === 'timed' ? `${s.w}√ó${s.t}s` : `${s.w}√ó${s.r}`)).filter(Boolean).join(' / ');
                        prevHtml = `<div class="ex-prev"><span class="ex-prev-date">${fmtDate(prev.date)}</span> ${setsStr}</div>`;
                    }
                }

                const swapHtml = ex.canSwap ? `<button class="swap-btn" data-ei="${ei}">‚áÑ</button>` : '';
                const collapseBtn = !ex.skipped ? `<button class="collapse-btn" data-ei="${ei}">${ex.collapsed ? '‚ñ∂' : '‚ñº'}</button>` : '';

                html += `<div class="ex-card ${cardClass}" data-ei="${ei}">`;
                html += `<div class="ex-head"><div><span class="ex-name">${ex.name}</span><span class="ex-btns"><button class="skip-btn ${ex.skipped?'active':''}" data-ei="${ei}">${ex.skipped?'‚è≠Ô∏è Overgeslagen':'Skip'}</button>${swapHtml}${collapseBtn}</span></div><span class="ex-rx">${ex.sets}x${ex.reps||'max'}</span></div>`;
                html += `<div class="ex-summary">${summaryText}</div>`;

                // Body wrapper voor collapse
                html += `<div class="ex-body">`;
                html += `<div class="ex-hint">${ex.hint}</div>${prevHtml}`;

                if (!ex.skipped) {
                    // Equipment selector for applicable exercises
                    if (ex.hasEquip && ex.equipOptions) {
                        html += `<div class="equip-row">`;
                        ex.equipOptions.forEach(eq => {
                            const eqLabel = eq === 'dumbbell' ? 'DB' : eq === 'kettlebell' ? 'KB' : eq === 'barbell' ? 'BB' : eq;
                            html += `<button class="equip-btn ${ex.equip===eq?'active':''}" data-ei="${ei}" data-eq="${eq}">${eqLabel}</button>`;
                        });
                        html += `</div>`;
                    }

                    if (ex.type === 'check') {
                        html += `<div class="check-row"><button class="check-btn ${ex.done?'checked':''}" data-ei="${ei}">${ex.done?'‚úì':''}</button><span>Tik als gedaan</span></div>`;
                    } else if (ex.type === 'timed') {
                        ex.setsData.forEach((s, si) => {
                            html += `<div class="set-row"><span class="set-num">${si+1}:</span><input type="text" inputmode="decimal" class="set-input" data-ei="${ei}" data-si="${si}" data-f="w" placeholder="${ex.phW||'BW'}" value="${s.w||''}"><span class="set-unit">kg</span><input type="text" inputmode="numeric" class="set-input" data-ei="${ei}" data-si="${si}" data-f="t" placeholder="${ex.phT||''}" value="${s.t||''}"><span class="set-unit">sec</span></div>`;
                        });
                    } else {
                        ex.setsData.forEach((s, si) => {
                            html += `<div class="set-row"><span class="set-num">${si+1}:</span><input type="text" inputmode="decimal" class="set-input ${s.warmup?'warmup':''}" data-ei="${ei}" data-si="${si}" data-f="w" placeholder="${ex.ph||''}" value="${s.w||''}"><span class="set-unit">kg</span><input type="text" inputmode="numeric" class="set-input ${s.warmup?'warmup':''}" data-ei="${ei}" data-si="${si}" data-f="r" placeholder="${ex.reps||''}" value="${s.r||''}"><span class="set-unit">reps</span><button class="warmup-btn ${s.warmup?'active':''}" data-ei="${ei}" data-si="${si}">w-up</button></div>`;
                        });
                        html += `<button class="add-btn" data-ei="${ei}">+</button>`;
                    }
                }

                // Notes field
                html += `<textarea class="notes-input" data-ei="${ei}" placeholder="Notities...">${ex.notes||''}</textarea>`;
                html += '</div></div>'; // close ex-body and ex-card
            });
            exEl.innerHTML = html;
            
            // Listeners
            exEl.querySelectorAll('.set-input').forEach(inp => {
                inp.oninput = () => { 
                    // Only allow numbers, decimal point, and BW
                    let val = inp.value.toUpperCase();
                    if (val !== 'BW' && val !== 'B') {
                        val = val.replace(/[^0-9.,]/g, '').replace(',', '.');
                    }
                    inp.value = val;
                    current.exercises[+inp.dataset.ei].setsData[+inp.dataset.si][inp.dataset.f] = val; 
                    updateSave(); 
                };
                inp.onfocus = () => inp.select();
            });
            exEl.querySelectorAll('.check-btn').forEach(btn => {
                btn.onclick = () => { current.exercises[+btn.dataset.ei].done = !current.exercises[+btn.dataset.ei].done; renderForm(); };
            });
            exEl.querySelectorAll('.warmup-btn').forEach(btn => {
                btn.onclick = () => { current.exercises[+btn.dataset.ei].setsData[+btn.dataset.si].warmup = !current.exercises[+btn.dataset.ei].setsData[+btn.dataset.si].warmup; renderForm(); };
            });
            exEl.querySelectorAll('.add-btn').forEach(btn => {
                btn.onclick = () => { const ex = current.exercises[+btn.dataset.ei]; ex.setsData.push({w:'',r:ex.reps||'',warmup:false}); renderForm(); };
            });
            exEl.querySelectorAll('.skip-btn').forEach(btn => {
                btn.onclick = () => { current.exercises[+btn.dataset.ei].skipped = !current.exercises[+btn.dataset.ei].skipped; renderForm(); };
            });
            exEl.querySelectorAll('.swap-btn').forEach(btn => {
                btn.onclick = e => {
                    e.stopPropagation();
                    document.querySelectorAll('.swap-menu').forEach(m => m.remove());
                    const ei = +btn.dataset.ei;
                    const ex = current.exercises[ei];
                    const currentExercise = EXERCISES[ex.id];
                    const alts = getAlternativesForExercise(currentExercise);
                    const recentIds = getRecentExerciseIds(7);

                    const menu = document.createElement('div');
                    menu.className = 'swap-menu';

                    // Add original option if swapped
                    if (ex.originalId) {
                        const origBtn = document.createElement('button');
                        origBtn.textContent = `‚Ü© ${ex.originalName}`;
                        origBtn.onclick = () => { swapExercise(ei, ex.originalId, true); menu.remove(); };
                        menu.appendChild(origBtn);
                    }

                    // Add alternatives
                    alts.forEach(alt => {
                        if (alt.id === ex.id) return;
                        const altBtn = document.createElement('button');
                        const isRecent = recentIds.includes(alt.id) || recentIds.includes(alt.name);
                        altBtn.textContent = alt.name;
                        altBtn.style.color = isRecent ? 'var(--text3)' : '';
                        altBtn.onclick = () => { swapExercise(ei, alt.id, false); menu.remove(); };
                        menu.appendChild(altBtn);
                    });

                    btn.closest('.ex-head').appendChild(menu);
                    const closeMenu = e2 => { if (!menu.contains(e2.target)) { menu.remove(); document.removeEventListener('click', closeMenu); } };
                    setTimeout(() => document.addEventListener('click', closeMenu), 0);
                };
            });
            exEl.querySelectorAll('.equip-btn').forEach(btn => {
                btn.onclick = () => { current.exercises[+btn.dataset.ei].equip = btn.dataset.eq; renderForm(); };
            });
            exEl.querySelectorAll('.notes-input').forEach(inp => {
                inp.oninput = () => { current.exercises[+inp.dataset.ei].notes = inp.value; };
            });
            // Collapse/expand knop handler
            exEl.querySelectorAll('.collapse-btn').forEach(btn => {
                btn.onclick = () => {
                    const ei = +btn.dataset.ei;
                    current.exercises[ei].collapsed = !current.exercises[ei].collapsed;
                    renderForm();
                };
            });

            // Update collapse-all knop
            updateCollapseAllBtn();
            updateSave();
        }

        function updateCollapseAllBtn() {
            if (!current) { collapseAllRow.style.display = 'none'; return; }
            // Toon knop als er oefeningen zijn (behalve overgeslagen)
            const collapsableExercises = current.exercises.filter(ex => !ex.skipped);
            if (collapsableExercises.length === 0) {
                collapseAllRow.style.display = 'none';
                return;
            }
            collapseAllRow.style.display = 'flex';
            const allCollapsed = collapsableExercises.every(ex => ex.collapsed);
            collapseAllBtn.textContent = allCollapsed ? '‚ñ∂ Alles uitklappen' : '‚ñº Alles inklappen';
        }

        collapseAllBtn.onclick = () => {
            if (!current) return;
            const collapsableExercises = current.exercises.filter(ex => !ex.skipped);
            const allCollapsed = collapsableExercises.every(ex => ex.collapsed);
            // Toggle: als alles ingeklapt is, klap uit. Anders klap in.
            globalCollapsed = !allCollapsed; // Onthoudt voor nieuwe dagen
            current.exercises.forEach(ex => {
                if (!ex.skipped) ex.collapsed = globalCollapsed;
            });
            renderForm();
        };

        function updateSave() {
            if (!current) { saveBtn.disabled = true; return; }
            const hasData = current.exercises.some(ex => {
                if (ex.skipped) return true;
                if (ex.type === 'check') return ex.done;
                return ex.setsData?.some(s => s.w || s.t);
            });
            saveBtn.disabled = !hasData;
        }

        // Save
        saveBtn.onclick = () => {
            if (!current) return;
            if (!isValidDate(dateInput.value)) { showToast('Ongeldige datum'); return; }
            const training = {
                id: Date.now(),
                date: toISODate(dateInput.value),
                day: current.day,
                lift: current.lift,
                week: +$('week-num').textContent,
                exercises: current.exercises.map(ex => {
                    if (ex.type === 'check') return { id: ex.id, name: ex.name, type: 'check', done: ex.done, skipped: ex.skipped, notes: ex.notes };
                    const result = {
                        id: ex.id,
                        name: ex.name,
                        type: ex.type,
                        sets: ex.skipped ? [] : ex.setsData.filter(s => s.w || s.t).map(s => ex.type === 'timed' ? {w:s.w,t:s.t} : {w:s.w,r:s.r,warmup:s.warmup}),
                        skipped: ex.skipped,
                        notes: ex.notes
                    };
                    if (ex.equip) result.equip = ex.equip;
                    return result;
                }).filter(ex => ex.skipped || (ex.type === 'check' ? ex.done : ex.sets?.length))
            };
            data.unshift(training);
            save();
            showToast('Opgeslagen!');
            updateWeekSelect();
            updateDayButtons();
            document.querySelectorAll('.day-btn').forEach(b => b.classList.remove('active'));
            selectedDay = null; current = null; exEl.innerHTML = ''; saveBtn.disabled = true;
        };

        // History
        function renderHistory() {
            const el = $('history');
            if (!data.length) { el.innerHTML = '<div class="empty">Nog geen trainingen</div>'; return; }
            el.innerHTML = data.map((t, i) => {
                const main = t.exercises.find(e => ['Back Squat','Bench Press','Conventional Deadlift','Push Press'].includes(e.name));
                let top = '-';
                if (main?.sets && main.sets.length) { 
                    const ws = main.sets.filter(s => !s.warmup); 
                    const last = ws[ws.length-1]; 
                    if (last) top = last.w + 'kg' + (last.r ? ' x '+last.r : ''); 
                }
                return `<div class="hist-card" data-idx="${i}"><div class="hist-top"><span class="hist-date">${fmtDate(t.date)}</span><span class="hist-day ${t.day}">Dag ${t.day}</span></div><div class="hist-lift">${t.lift}</div><div class="hist-summary">Topset: ${top}</div></div>`;
            }).join('');
            el.querySelectorAll('.hist-card').forEach(c => { c.onclick = () => openModal(+c.dataset.idx); });
        }

        // Modal
        function openModal(idx) {
            editIdx = idx;
            editData = JSON.parse(JSON.stringify(data[idx]));
            $('modal-title').textContent = editData.lift + ' ‚Äî Dag ' + editData.day;
            $('modal-date').textContent = fmtDate(editData.date) + ' | Week ' + editData.week;
            renderModal();
            modal.classList.add('show');
        }

        function renderModal() {
            let html = '';
            editData.exercises.forEach((ex, ei) => {
                const cardClass = ex.skipped ? 'skipped' : '';
                html += `<div class="ex-card ${cardClass}"><div class="ex-head"><span class="ex-name">${ex.name}</span>${ex.equip ? `<span class="ex-rx">${ex.equip}</span>` : ''}</div>`;
                if (ex.skipped) {
                    html += `<div style="color:var(--skip);font-size:0.75rem;">‚è≠Ô∏è Overgeslagen</div>`;
                } else if (ex.type === 'check') {
                    html += `<div class="check-row"><button class="check-btn ${ex.done?'checked':''}" data-mei="${ei}">${ex.done?'‚úì':''}</button><span>${ex.done?'Gedaan':'Niet gedaan'}</span></div>`;
                } else if (ex.sets && ex.sets.length) {
                    ex.sets.forEach((s, si) => {
                        if (ex.type === 'timed') {
                            html += `<div class="set-row"><span class="set-num">${si+1}:</span><input type="text" inputmode="decimal" class="set-input" data-mei="${ei}" data-msi="${si}" data-mf="w" value="${s.w||''}"><span class="set-unit">kg</span><input type="text" inputmode="numeric" class="set-input" data-mei="${ei}" data-msi="${si}" data-mf="t" value="${s.t||''}"><span class="set-unit">sec</span></div>`;
                        } else {
                            html += `<div class="set-row"><span class="set-num">${si+1}:</span><input type="text" inputmode="decimal" class="set-input ${s.warmup?'warmup':''}" data-mei="${ei}" data-msi="${si}" data-mf="w" value="${s.w||''}"><span class="set-unit">kg</span><input type="text" inputmode="numeric" class="set-input ${s.warmup?'warmup':''}" data-mei="${ei}" data-msi="${si}" data-mf="r" value="${s.r||''}"><span class="set-unit">reps</span><button class="warmup-btn ${s.warmup?'active':''}" data-mei="${ei}" data-msi="${si}">w-up</button></div>`;
                        }
                    });
                }
                if (ex.notes) {
                    html += `<div style="font-size:0.75rem;color:var(--text2);margin-top:0.5rem;font-style:italic;">${ex.notes}</div>`;
                }
                html += '</div>';
            });
            modalBody.innerHTML = html;
            
            modalBody.querySelectorAll('.set-input').forEach(inp => {
                inp.oninput = () => { 
                    // Only allow numbers, decimal point, and BW
                    let val = inp.value.toUpperCase();
                    if (val !== 'BW' && val !== 'B') {
                        val = val.replace(/[^0-9.,]/g, '').replace(',', '.');
                    }
                    inp.value = val;
                    editData.exercises[+inp.dataset.mei].sets[+inp.dataset.msi][inp.dataset.mf] = val; 
                };
                inp.onfocus = () => inp.select();
            });
            modalBody.querySelectorAll('.check-btn').forEach(btn => {
                btn.onclick = () => { editData.exercises[+btn.dataset.mei].done = !editData.exercises[+btn.dataset.mei].done; renderModal(); };
            });
            modalBody.querySelectorAll('.warmup-btn').forEach(btn => {
                btn.onclick = () => { editData.exercises[+btn.dataset.mei].sets[+btn.dataset.msi].warmup = !editData.exercises[+btn.dataset.mei].sets[+btn.dataset.msi].warmup; renderModal(); };
            });
        }

        function closeModal() { modal.classList.remove('show'); editIdx = null; editData = null; }
        $('modal-close').onclick = closeModal;
        $('btn-cancel').onclick = closeModal;
        $('btn-save').onclick = () => { data[editIdx] = editData; save(); showToast('Gewijzigd!'); closeModal(); renderHistory(); };
        $('btn-delete').onclick = () => {
            if (confirm('Training verwijderen?\n\n' + editData.lift + ' ‚Äî ' + fmtDate(editData.date))) {
                data.splice(editIdx, 1);
                save();
                showToast('Verwijderd!');
                closeModal();
                renderHistory();
                updateWeekSelect();
                updateDayButtons();
            }
        };
        modal.onclick = e => { if (e.target === modal) closeModal(); };

        // Progress
        document.querySelectorAll('.prog-btn').forEach(btn => {
            btn.onclick = () => { document.querySelectorAll('.prog-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active'); renderProgress(btn.dataset.lift); };
        });

        function renderProgress(lift = 'Back Squat') {
            const el = $('progress');
            const rows = data.filter(t => t.exercises.some(e => e.name === lift && !e.skipped)).map(t => {
                const ex = t.exercises.find(e => e.name === lift);
                const ws = ex.sets?.filter(s => !s.warmup) || [];
                const max = ws.length ? Math.max(...ws.map(s => parseFloat(s.w)||0)) : 0;
                return { date: t.date, val: max };
            }).reverse().slice(-8);
            if (!rows.length) { el.innerHTML = '<div class="empty">Geen data</div>'; return; }
            const max = Math.max(...rows.map(r => r.val));
            el.innerHTML = rows.map(r => `<div class="prog-row"><span class="prog-date">${r.date.slice(5)}</span><div class="prog-bar-bg"><div class="prog-bar" style="width:${(r.val/max)*100}%"></div></div><span class="prog-val">${r.val}</span></div>`).join('');
        }

        // Export
        function updateWeekSelect() {
            const weeks = [...new Set(data.map(t => t.week))].sort((a,b) => a-b);
            $('week-select').innerHTML = '<option value="all">Alle weken</option>' + weeks.map(w => `<option value="${w}">Week ${w}</option>`).join('');
        }
        updateWeekSelect();

        $('export-btn').onclick = () => {
            if (!data.length) { showToast('Geen data'); return; }
            const wk = $('week-select').value;
            const exp = wk === 'all' ? data : data.filter(t => t.week == wk);
            if (!exp.length) { showToast('Geen data'); return; }
            let csv = 'Datum,Dag,Lift,Week,Oefening,Type,Set,Gewicht,Reps,Tijd,Warmup,Equipment,Skipped,Notes\n';
            exp.forEach(t => {
                t.exercises.forEach(ex => {
                    if (ex.type === 'check') csv += `${t.date},${t.day},${t.lift},${t.week},${ex.name},check,,,,,,${ex.skipped||false},"${(ex.notes||'').replace(/"/g,'""')}"\n`;
                    else if (ex.skipped) csv += `${t.date},${t.day},${t.lift},${t.week},${ex.name},${ex.type},,,,,,true,"${(ex.notes||'').replace(/"/g,'""')}"\n`;
                    else ex.sets?.forEach((s,i) => { csv += `${t.date},${t.day},${t.lift},${t.week},${ex.name},${ex.type},${i+1},${s.w||''},${s.r||''},${s.t||''},${s.warmup?'ja':'nee'},${ex.equip||''},false,"${(ex.notes||'').replace(/"/g,'""')}"\n`; });
                });
            });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(new Blob([csv], {type:'text/csv'}));
            a.download = `liftlog_${wk==='all'?'all':'week'+wk}_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            showToast('Ge√´xporteerd!');
        };

        // Import
        $('import-btn').onclick = () => $('file-input').click();
        $('file-input').onchange = e => {
            const file = e.target.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = ev => {
                try {
                    const lines = ev.target.result.split('\n').filter(l => l.trim());
                    if (lines.length < 2) { showToast('Leeg'); return; }
                    const imp = {};
                    for (let i = 1; i < lines.length; i++) {
                        const parts = lines[i].match(/(".*?"|[^,]+)/g) || [];
                        const [date,day,lift,week,exName,type,setNum,w,r,t,warmup,equip,skipped,notes] = parts.map(p => p.replace(/^"|"$/g, '').replace(/""/g, '"'));
                        const key = date+'_'+day;
                        if (!imp[key]) imp[key] = {id:Date.now()+i,date,day,lift,week:+week||1,exercises:[]};
                        let ex = imp[key].exercises.find(e => e.name === exName);
                        if (!ex) { ex = {name:exName,type,sets:[],done:false,skipped:skipped==='true',notes:notes||''}; if (equip) ex.equip = equip; imp[key].exercises.push(ex); }
                        if (type === 'check') ex.done = warmup==='true'||warmup==='ja';
                        else if (setNum && skipped !== 'true') ex.sets.push({w:w||'',r:r||'',t:t||'',warmup:warmup==='ja'});
                    }
                    const arr = Object.values(imp).sort((a,b) => new Date(b.date)-new Date(a.date));
                    if (!arr.length) { showToast('Geen data'); return; }
                    if (confirm(`${arr.length} trainingen.\n\nOK = Toevoegen\nAnnuleren = Vervangen`)) {
                        const keys = new Set(data.map(t => t.date+'_'+t.day));
                        data = [...data, ...arr.filter(t => !keys.has(t.date+'_'+t.day))].sort((a,b) => new Date(b.date)-new Date(a.date));
                    } else data = arr;
                    save(); showToast('Ge√Ømporteerd!'); updateWeekSelect(); updateDayButtons(); renderHistory();
                } catch(err) { console.error(err); showToast('Fout'); }
            };
            reader.readAsText(file);
            e.target.value = '';
        };

        // Init
        renderHistory();
    })();
    </script>
</body>
</html>
