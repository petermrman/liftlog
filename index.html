<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="LiftLog">
    <meta name="theme-color" content="#0a0a0a">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%230a0a0a' width='100' height='100' rx='20'/><text x='50' y='68' font-family='system-ui,sans-serif' font-size='48' font-weight='700' fill='%23f59e0b' text-anchor='middle'>LL</text></svg>">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%230a0a0a' width='100' height='100' rx='20'/><text x='50' y='68' font-family='system-ui,sans-serif' font-size='48' font-weight='700' fill='%23f59e0b' text-anchor='middle'>LL</text></svg>">
    <title>LiftLog</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        :root {
            --bg: #0a0a0a; --bg2: #141414; --bg3: #1e1e1e;
            --text: #f5f5f5; --text2: #a0a0a0; --text3: #606060;
            --border: #2a2a2a; --accent: #f59e0b; --success: #22c55e; --danger: #ef4444;
            --blue: #3b82f6; --red: #ef4444; --green: #22c55e; --purple: #a855f7;
            --skip: #6b7280;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; }
        
        /* Header */
        .header { position: sticky; top: 0; z-index: 100; background: var(--bg); border-bottom: 1px solid var(--border); padding: 1rem; }
        .header-content { display: flex; justify-content: space-between; align-items: center; max-width: 500px; margin: 0 auto; }
        .logo { font-size: 1.25rem; font-weight: 700; }
        .logo span { color: var(--accent); }
        .nav { display: flex; gap: 0.25rem; background: var(--bg2); padding: 0.25rem; border-radius: 0.5rem; }
        .nav button { padding: 0.5rem 0.75rem; border: none; background: transparent; color: var(--text2); font-size: 0.875rem; border-radius: 0.375rem; cursor: pointer; }
        .nav button.active { background: var(--bg3); color: var(--text); }
        
        /* Main */
        .main { max-width: 500px; margin: 0 auto; padding: 1rem; }
        .screen { display: none; }
        .screen.active { display: block; }
        
        /* Week & Day */
        .week-bar { text-align: center; padding: 0.75rem; margin-bottom: 1rem; background: var(--bg2); border-radius: 0.5rem; font-size: 0.875rem; }
        .week-bar span { color: var(--accent); font-weight: 600; }
        .days { display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.5rem; margin-bottom: 1rem; }
        .day-btn { padding: 0.75rem 0.5rem; border: 2px solid var(--border); background: var(--bg2); color: var(--text2); font-size: 0.75rem; font-weight: 600; border-radius: 0.75rem; cursor: pointer; text-align: center; }
        .day-btn span { font-size: 1.25rem; display: block; margin-bottom: 0.125rem; }
        .day-btn.active { border-color: var(--accent); color: var(--text); }
        .day-btn.has-data { border-color: var(--success); }
        
        /* Date */
        .date-row { margin-bottom: 1rem; }
        .date-row label { display: block; font-size: 0.75rem; color: var(--text2); margin-bottom: 0.375rem; }
        .date-input { width: 100%; padding: 0.75rem; background: var(--bg2); border: 1px solid var(--border); border-radius: 0.5rem; color: var(--text); font-size: 1rem; }
        .date-input.invalid { border-color: var(--danger); }
        
        /* Exercise Card */
        .ex-card { background: var(--bg2); border: 1px solid var(--border); border-radius: 0.75rem; padding: 1rem; margin-bottom: 0.75rem; }
        .ex-card.done { border-color: var(--success); }
        .ex-card.skipped { border-color: var(--skip); opacity: 0.6; }
        .ex-card.collapsed { padding: 0.75rem 1rem; }
        .ex-card.collapsed .ex-body { display: none; }
        .ex-card.collapsed .ex-head { margin-bottom: 0; }
        .ex-card.collapsed .ex-summary { display: flex; }
        .ex-head { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem; }
        .ex-summary { display: none; font-size: 0.75rem; color: var(--text2); margin-top: 0.25rem; }
        .ex-card.done .ex-summary { color: var(--success); }
        .collapse-btn { padding: 0.25rem 0.5rem; font-size: 0.625rem; background: transparent; border: 1px solid var(--border); border-radius: 0.25rem; color: var(--text3); cursor: pointer; min-width: 1.5rem; }
        .collapse-btn:hover { background: var(--bg3); }
        .ex-card.done .collapse-btn { border-color: var(--success); color: var(--success); }
        .ex-card.done .collapse-btn:hover { background: rgba(34,197,94,0.1); }
        .collapse-all-row { display: flex; justify-content: flex-end; margin-bottom: 0.5rem; }
        .collapse-all-btn { padding: 0.375rem 0.75rem; font-size: 0.75rem; background: var(--bg2); border: 1px solid var(--border); border-radius: 0.375rem; color: var(--text2); cursor: pointer; }
        .collapse-all-btn:hover { background: var(--bg3); }
        .ex-name { font-weight: 600; font-size: 0.9375rem; }
        .ex-rx { font-size: 0.75rem; color: var(--text2); background: var(--bg3); padding: 0.25rem 0.5rem; border-radius: 0.25rem; }
        .ex-hint { font-size: 0.75rem; color: var(--text3); margin-bottom: 0.5rem; }
        .ex-prev { font-size: 0.7rem; color: var(--text2); background: var(--bg3); padding: 0.375rem 0.5rem; border-radius: 0.375rem; margin-bottom: 0.75rem; }
        .ex-prev-date { color: var(--accent); font-weight: 500; }
        
        /* Skip & Swap buttons */
        .ex-btns { display: flex; gap: 0.25rem; margin-left: 0.5rem; }
        .skip-btn, .swap-btn { padding: 0.25rem 0.5rem; font-size: 0.625rem; background: transparent; border: 1px solid var(--border); border-radius: 0.25rem; color: var(--text3); cursor: pointer; }
        .yt-btn { display: inline-flex; align-items: center; justify-content: center; width: 1.25rem; height: 1.25rem; margin-left: 0.375rem; background: #ff0000; color: #fff; font-size: 0.5rem; border-radius: 0.25rem; text-decoration: none; vertical-align: middle; }
        .skip-btn.active { border-color: var(--skip); color: var(--skip); background: rgba(107,114,128,0.2); }
        .swap-btn { border-color: var(--blue); color: var(--blue); }
        .swap-menu { position: absolute; top: 100%; right: 0; background: var(--bg2); border: 1px solid var(--border); border-radius: 0.5rem; padding: 0.25rem; z-index: 50; min-width: 10rem; box-shadow: 0 4px 12px rgba(0,0,0,0.5); }
        .swap-menu button { display: block; width: 100%; padding: 0.5rem 0.75rem; border: none; background: transparent; color: var(--text); font-size: 0.75rem; text-align: left; cursor: pointer; border-radius: 0.25rem; }
        .swap-menu button:hover { background: var(--bg3); }
        .ex-head { position: relative; }
        
        /* Equipment selector */
        .equip-row { display: flex; gap: 0.25rem; margin-bottom: 0.75rem; }
        .equip-btn { padding: 0.25rem 0.5rem; font-size: 0.625rem; background: var(--bg3); border: 1px solid var(--border); border-radius: 0.25rem; color: var(--text3); cursor: pointer; }
        .equip-btn.active { border-color: var(--accent); color: var(--accent); }
        
        /* Set Row */
        .set-row { display: flex; align-items: center; gap: 0.375rem; margin-bottom: 0.5rem; flex-wrap: wrap; }
        .set-num { width: 1.5rem; font-size: 0.75rem; color: var(--text3); }
        .set-input { width: 3.5rem; padding: 0.5rem 0.25rem; background: var(--bg3); border: 1px solid var(--border); border-radius: 0.375rem; color: var(--text); font-size: 0.875rem; text-align: center; }
        .set-input:focus { outline: none; border-color: var(--accent); }
        .set-input.warmup { border-style: dashed; opacity: 0.7; }
        .set-unit { font-size: 0.625rem; color: var(--text3); width: 1.5rem; }
        .warmup-btn { padding: 0.25rem 0.5rem; font-size: 0.625rem; background: transparent; border: 1px solid var(--border); border-radius: 0.25rem; color: var(--text3); cursor: pointer; }
        .warmup-btn.active { border-color: var(--accent); color: var(--accent); }
        .add-btn { width: 2.5rem; height: 2rem; border: 1px dashed var(--border); background: transparent; color: var(--text3); border-radius: 0.375rem; cursor: pointer; font-size: 1.25rem; margin-top: 0.25rem; }
        
        /* Notes */
        .notes-input { width: 100%; margin-top: 0.5rem; padding: 0.5rem; background: var(--bg3); border: 1px solid var(--border); border-radius: 0.375rem; color: var(--text); font-size: 0.75rem; resize: none; min-height: 2.5rem; }
        .notes-input::placeholder { color: var(--text3); }
        
        /* Check */
        .check-row { display: flex; align-items: center; gap: 0.75rem; }
        .check-btn { width: 2.5rem; height: 2.5rem; border: 2px solid var(--border); background: var(--bg3); border-radius: 0.5rem; cursor: pointer; font-size: 1.25rem; color: var(--text3); }
        .check-btn.checked { border-color: var(--success); background: rgba(34,197,94,0.2); color: var(--success); }
        
        /* Buttons */
        .save-btn { width: 100%; padding: 1rem; margin-top: 1rem; background: var(--accent); border: none; border-radius: 0.75rem; color: #000; font-size: 1rem; font-weight: 600; cursor: pointer; }
        .save-btn:disabled { opacity: 0.4; cursor: not-allowed; }
        .actions { display: flex; gap: 0.5rem; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border); }
        .action-btn { flex: 1; padding: 0.75rem; background: var(--bg2); border: 1px solid var(--border); border-radius: 0.5rem; color: var(--text2); font-size: 0.875rem; cursor: pointer; }
        .week-select { flex: 1; padding: 0.75rem; background: var(--bg2); border: 1px solid var(--border); border-radius: 0.5rem; color: var(--text); font-size: 0.875rem; }
        
        /* History */
        .hist-card { background: var(--bg2); border: 1px solid var(--border); border-radius: 0.75rem; padding: 1rem; margin-bottom: 0.75rem; cursor: pointer; }
        .hist-top { display: flex; justify-content: space-between; margin-bottom: 0.5rem; }
        .hist-date { font-size: 0.875rem; }
        .hist-day { font-size: 0.75rem; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-weight: 600; }
        .hist-day.A { background: rgba(59,130,246,0.2); color: var(--blue); }
        .hist-day.B { background: rgba(239,68,68,0.2); color: var(--red); }
        .hist-day.C { background: rgba(34,197,94,0.2); color: var(--green); }
        .hist-day.D { background: rgba(168,85,247,0.2); color: var(--purple); }
        .hist-lift { font-weight: 600; margin-bottom: 0.25rem; }
        .hist-summary { font-size: 0.75rem; color: var(--text2); }
        
        /* Progress */
        .prog-btns { display: flex; gap: 0.5rem; margin-bottom: 1rem; overflow-x: auto; }
        .prog-btn { padding: 0.5rem 0.75rem; background: var(--bg2); border: 1px solid var(--border); border-radius: 0.5rem; color: var(--text2); font-size: 0.875rem; cursor: pointer; white-space: nowrap; }
        .prog-btn.active { border-color: var(--accent); color: var(--text); }
        .prog-chart { background: var(--bg2); border: 1px solid var(--border); border-radius: 0.75rem; padding: 1rem; }
        .prog-title { font-size: 0.75rem; color: var(--text2); margin-bottom: 1rem; }
        .prog-row { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; }
        .prog-date { font-size: 0.625rem; color: var(--text3); width: 3rem; }
        .prog-bar-bg { flex: 1; height: 1.25rem; background: var(--bg3); border-radius: 0.25rem; overflow: hidden; }
        .prog-bar { height: 100%; background: var(--accent); border-radius: 0.25rem; }
        .prog-val { font-size: 0.75rem; width: 2.5rem; text-align: right; }
        
        /* Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.95); z-index: 200; overflow-y: auto; }
        .modal.show { display: block; }
        .modal-inner { max-width: 500px; margin: 1rem auto; padding: 1rem; }
        .modal-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border); }
        .modal-title { font-size: 1.125rem; font-weight: 600; }
        .modal-close { width: 2.5rem; height: 2.5rem; border: none; background: var(--bg2); color: var(--text); font-size: 1.25rem; border-radius: 0.5rem; cursor: pointer; }
        .modal-date { font-size: 0.875rem; color: var(--text2); margin-bottom: 1rem; }
        .modal-btns { display: flex; gap: 0.5rem; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border); }
        .modal-btn { flex: 1; padding: 0.75rem; border: none; border-radius: 0.5rem; font-size: 0.875rem; font-weight: 600; cursor: pointer; }
        .modal-btn.save { background: var(--accent); color: #000; }
        .modal-btn.delete { background: var(--danger); color: #fff; }
        .modal-btn.cancel { background: var(--bg2); color: var(--text2); border: 1px solid var(--border); }
        .modal-btn.ics { background: var(--blue); color: #fff; }
        
        /* Empty & Toast */
        .empty { text-align: center; padding: 3rem 1rem; color: var(--text2); }
        .toast { position: fixed; bottom: 2rem; left: 50%; transform: translateX(-50%) translateY(100px); background: var(--success); color: #000; padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-weight: 600; opacity: 0; transition: all 0.3s; z-index: 300; }
        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
        .file-input { display: none; }

        /* Mode Toggle */
        .mode-toggle { display: flex; gap: 0.5rem; margin-bottom: 1rem; }
        .mode-btn { flex: 1; padding: 0.75rem; border: 2px solid var(--border); background: var(--bg2); color: var(--text2); font-size: 0.875rem; font-weight: 600; border-radius: 0.5rem; cursor: pointer; text-align: center; }
        .mode-btn.active { border-color: var(--accent); color: var(--text); background: rgba(245,158,11,0.1); }

        /* Cardio */
        .cardio-types { display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.5rem; margin-bottom: 1rem; }
        .cardio-btn { padding: 0.75rem 0.5rem; border: 2px solid var(--border); background: var(--bg2); color: var(--text2); font-size: 0.75rem; font-weight: 600; border-radius: 0.75rem; cursor: pointer; text-align: center; }
        .cardio-btn span { font-size: 1.5rem; display: block; margin-bottom: 0.25rem; }
        .cardio-btn.active { border-color: var(--accent); color: var(--text); }
        .cardio-form { background: var(--bg2); border: 1px solid var(--border); border-radius: 0.75rem; padding: 1rem; }
        .cardio-row { display: flex; gap: 0.5rem; margin-bottom: 0.75rem; }
        .cardio-field { flex: 1; }
        .cardio-field label { display: block; font-size: 0.7rem; color: var(--text2); margin-bottom: 0.25rem; }
        .cardio-field input { width: 100%; padding: 0.625rem; background: var(--bg3); border: 1px solid var(--border); border-radius: 0.375rem; color: var(--text); font-size: 1rem; text-align: center; }
        .cardio-field input:focus { outline: none; border-color: var(--accent); }
        .intensity-btns { display: flex; gap: 0.25rem; }
        .intensity-btn { flex: 1; padding: 0.5rem; border: 1px solid var(--border); background: var(--bg3); color: var(--text2); font-size: 0.625rem; border-radius: 0.25rem; cursor: pointer; }
        .intensity-btn.active { border-color: var(--success); color: var(--success); background: rgba(34,197,94,0.2); }
        .intensity-btn.active.medium { border-color: var(--accent); color: var(--accent); background: rgba(245,158,11,0.2); }
        .intensity-btn.active.high { border-color: var(--danger); color: var(--danger); background: rgba(239,68,68,0.2); }
        .add-cardio-btn { width: 100%; padding: 0.75rem; margin-bottom: 0.75rem; background: var(--bg2); border: 2px dashed var(--border); border-radius: 0.75rem; color: var(--text2); font-size: 0.875rem; cursor: pointer; }
        .add-cardio-btn:hover { border-color: var(--accent); color: var(--accent); }
        .training-cardio-card { background: var(--bg2); border: 2px solid var(--accent); border-radius: 0.75rem; padding: 1rem; margin-bottom: 0.75rem; }
        .training-cardio-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem; }
        .training-cardio-title { font-weight: 600; color: var(--accent); }
        .training-cardio-remove { background: transparent; border: 1px solid var(--danger); color: var(--danger); padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.625rem; cursor: pointer; }

        /* Dashboard */
        .dash-section { background: var(--bg2); border: 1px solid var(--border); border-radius: 0.75rem; padding: 1rem; margin-bottom: 1rem; }
        .dash-title { font-size: 0.875rem; font-weight: 600; margin-bottom: 0.75rem; color: var(--text); }
        .dash-week { display: grid; grid-template-columns: repeat(7, 1fr); gap: 0.25rem; }
        .dash-week-day { text-align: center; padding: 0.5rem 0.25rem; background: var(--bg3); border-radius: 0.375rem; font-size: 0.625rem; }
        .dash-week-day .day-label { color: var(--text3); margin-bottom: 0.25rem; }
        .dash-week-day .day-status { font-size: 0.875rem; }
        .dash-week-day.today { border: 1px solid var(--accent); }
        .dash-week-day.trained { background: rgba(34,197,94,0.2); }
        .dash-week-day.trained .day-status { color: var(--success); }
        .dash-next { display: flex; flex-direction: column; gap: 0.5rem; }
        .dash-next-main { font-size: 1.125rem; font-weight: 600; color: var(--accent); }
        .dash-next-sub { font-size: 0.75rem; color: var(--text2); }
        .dash-next-btn { margin-top: 0.5rem; padding: 0.75rem; background: var(--accent); border: none; border-radius: 0.5rem; color: #000; font-weight: 600; cursor: pointer; }
        .dash-streak { display: flex; flex-direction: column; gap: 0.5rem; }
        .dash-streak-bar { height: 1.5rem; background: var(--bg3); border-radius: 0.5rem; overflow: hidden; position: relative; }
        .dash-streak-fill { height: 100%; background: linear-gradient(90deg, var(--accent), var(--success)); border-radius: 0.5rem; transition: width 0.5s; }
        .dash-streak-text { font-size: 0.875rem; color: var(--text2); }
        .dash-streak-text strong { color: var(--text); }
        .dash-lifts { display: flex; flex-direction: column; gap: 0.75rem; }
        .dash-lift-row { display: flex; align-items: center; gap: 0.5rem; }
        .dash-lift-name { width: 5rem; font-size: 0.75rem; color: var(--text2); }
        .dash-lift-vals { flex: 1; display: flex; gap: 0.375rem; font-size: 0.75rem; }
        .dash-lift-val { background: var(--bg3); padding: 0.25rem 0.5rem; border-radius: 0.25rem; }
        .dash-lift-val.latest { background: var(--accent); color: #000; font-weight: 600; }
        .dash-lift-trend { font-size: 0.875rem; }
        .dash-lift-trend.up { color: var(--success); }
        .dash-lift-trend.down { color: var(--danger); }
        .dash-lift-trend.same { color: var(--text3); }
        .dash-export { display: flex; flex-direction: column; gap: 0.75rem; }
        .dash-export-desc { font-size: 0.75rem; color: var(--text2); margin: 0; }
        .dash-export-btns { display: flex; gap: 0.5rem; }
        .dash-export-btn { flex: 1; padding: 0.625rem; background: var(--bg3); border: 1px solid var(--border); border-radius: 0.5rem; color: var(--text); font-size: 0.75rem; cursor: pointer; }
        .drop-zone { border: 2px dashed var(--border); border-radius: 0.75rem; padding: 1.5rem; text-align: center; cursor: pointer; transition: all 0.2s; }
        .drop-zone:hover, .drop-zone.drag-over { border-color: var(--accent); background: rgba(245,158,11,0.1); }
        .drop-zone-icon { font-size: 2rem; margin-bottom: 0.5rem; }
        .drop-zone-text { font-size: 0.75rem; color: var(--text2); }
        .dash-export-btn:hover { background: var(--accent); color: #000; border-color: var(--accent); }

        /* Exercises Browser */
        .ex-browser { padding-bottom: 1rem; }
        .ex-search-row { margin-bottom: 0.75rem; }
        .ex-search { width: 100%; padding: 0.75rem 1rem; background: var(--bg2); border: 1px solid var(--border); border-radius: 0.5rem; color: var(--text); font-size: 0.875rem; }
        .ex-search:focus { outline: none; border-color: var(--accent); }
        .ex-search::placeholder { color: var(--text3); }
        .ex-filters { display: flex; gap: 0.375rem; flex-wrap: wrap; margin-bottom: 0.75rem; }
        .ex-filter { padding: 0.375rem 0.625rem; background: var(--bg2); border: 1px solid var(--border); border-radius: 0.375rem; color: var(--text2); font-size: 0.6875rem; cursor: pointer; white-space: nowrap; }
        .ex-filter.active { background: var(--accent); color: #000; border-color: var(--accent); }
        .ex-count { font-size: 0.75rem; color: var(--text3); margin-bottom: 0.75rem; }
        .ex-grid { display: flex; flex-direction: column; gap: 0.5rem; }
        .ex-tile { background: var(--bg2); border: 1px solid var(--border); border-radius: 0.75rem; padding: 0.875rem; display: flex; align-items: flex-start; gap: 0.75rem; }
        .ex-tile-yt { flex-shrink: 0; width: 2.5rem; height: 2.5rem; background: #ff0000; border-radius: 0.5rem; display: flex; align-items: center; justify-content: center; color: #fff; font-size: 1rem; text-decoration: none; }
        .ex-tile-yt:hover { background: #cc0000; transform: scale(1.05); }
        .ex-tile-info { flex: 1; min-width: 0; }
        .ex-tile-name { font-weight: 600; font-size: 0.9375rem; margin-bottom: 0.25rem; color: var(--text); }
        .ex-tile-meta { display: flex; flex-wrap: wrap; gap: 0.375rem; margin-bottom: 0.375rem; }
        .ex-tile-tag { padding: 0.125rem 0.375rem; background: var(--bg3); border-radius: 0.25rem; font-size: 0.625rem; color: var(--text2); }
        .ex-tile-tag.pattern { background: rgba(245,158,11,0.2); color: var(--accent); }
        .ex-tile-tag.equipment { background: rgba(59,130,246,0.2); color: var(--blue); }
        .ex-tile-tag.muscle { background: rgba(34,197,94,0.2); color: var(--success); }
        .ex-tile-tag.unilateral { background: rgba(168,85,247,0.2); color: var(--purple); }
        .ex-tile-hint { font-size: 0.75rem; color: var(--text3); font-style: italic; }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="logo">LIFT<span>LOG</span> <small style="font-size:0.5rem;color:#666">v3.4</small></div>
            <nav class="nav">
                <button data-screen="dashboard">Home</button>
                <button class="active" data-screen="new">Nieuw</button>
                <button data-screen="history">Log</button>
                <button data-screen="exercises">Gym</button>
                <button data-screen="progress">Stats</button>
            </nav>
        </div>
    </header>

    <main class="main">
        <section id="screen-new" class="screen active">
            <div class="mode-toggle">
                <button class="mode-btn active" data-mode="lifting">üèãÔ∏è Lifting</button>
                <button class="mode-btn" data-mode="cardio">üèÉ Cardio</button>
            </div>
            <div id="lifting-section">
                <div class="week-bar">Week <span id="week-num">1</span> | RPE 6-7</div>
                <div class="days" id="day-btns">
                    <button class="day-btn" data-day="A"><span>A</span>Squat</button>
                    <button class="day-btn" data-day="B"><span>B</span>Bench</button>
                    <button class="day-btn" data-day="C"><span>C</span>Deadlift</button>
                    <button class="day-btn" data-day="D"><span>D</span>Push Press</button>
                </div>
            </div>
            <div id="cardio-section" style="display:none;">
                <div class="cardio-types" id="cardio-types">
                    <button class="cardio-btn" data-type="running"><span>üèÉ</span>Hardlopen</button>
                    <button class="cardio-btn" data-type="cycling"><span>üö¥</span>Fietsen</button>
                    <button class="cardio-btn" data-type="rowing"><span>üö£</span>Roeien</button>
                    <button class="cardio-btn" data-type="hiit"><span>‚ö°</span>HIIT</button>
                    <button class="cardio-btn" data-type="walking"><span>üö∂</span>Wandelen</button>
                    <button class="cardio-btn" data-type="other"><span>üí™</span>Anders</button>
                </div>
                <div id="cardio-form-container"></div>
            </div>
            <div class="date-row">
                <label>Datum & Starttijd</label>
                <div style="display:flex;gap:0.5rem;">
                    <input type="text" class="date-input" id="date-input" placeholder="30-12-2025" inputmode="numeric" style="flex:1;">
                    <input type="text" class="date-input" id="time-input" placeholder="09:00" inputmode="numeric" style="width:5rem;text-align:center;">
                </div>
            </div>
            <div class="collapse-all-row" id="collapse-all-row" style="display:none;">
                <button class="collapse-all-btn" id="collapse-all-btn">‚ñº Alles inklappen</button>
            </div>
            <div id="exercises"></div>
            <div id="training-cardio"></div>
            <button class="add-cardio-btn" id="add-cardio-btn" style="display:none;">‚ûï Cardio toevoegen</button>
            <button class="save-btn" id="save-btn" disabled>Training Opslaan</button>
            <div class="actions">
                <select class="week-select" id="week-select"><option value="all">Alle weken</option></select>
                <button class="action-btn" id="export-btn">üì§ Export</button>
                <button class="action-btn" id="import-btn">üì• Import</button>
            </div>
            <input type="file" class="file-input" id="file-input" accept=".csv">
        </section>

        <section id="screen-history" class="screen">
            <div id="history"></div>
        </section>

        <section id="screen-progress" class="screen">
            <div class="prog-btns">
                <button class="prog-btn active" data-lift="Back Squat">Squat</button>
                <button class="prog-btn" data-lift="Bench Press">Bench</button>
                <button class="prog-btn" data-lift="Conventional Deadlift">Deadlift</button>
                <button class="prog-btn" data-lift="Push Press">Push Press</button>
            </div>
            <div class="prog-chart">
                <div class="prog-title">Topset Progressie (kg)</div>
                <div id="progress"></div>
            </div>
        </section>

        <section id="screen-dashboard" class="screen">
            <div class="dash-section">
                <div class="dash-title">üìÖ Deze week</div>
                <div class="dash-week" id="dash-week"></div>
            </div>
            <div class="dash-section">
                <div class="dash-title">‚è≠Ô∏è Volgende training</div>
                <div class="dash-next" id="dash-next"></div>
            </div>
            <div class="dash-section">
                <div class="dash-title">üî• Consistentie</div>
                <div class="dash-streak" id="dash-streak"></div>
            </div>
            <div class="dash-section">
                <div class="dash-title">üìä Hoofdlifts (laatste 4)</div>
                <div class="dash-lifts" id="dash-lifts"></div>
            </div>
            <div class="dash-section">
                <div class="dash-title">üìÜ Kalender Export</div>
                <div class="dash-export">
                    <p class="dash-export-desc">Exporteer trainingen naar Apple Calendar</p>
                    <div class="dash-export-btns">
                        <button class="dash-export-btn" id="ics-export-all">Alles</button>
                        <button class="dash-export-btn" id="ics-export-month">Deze maand</button>
                        <button class="dash-export-btn" id="ics-export-week">Deze week</button>
                    </div>
                </div>
            </div>
            <div class="dash-section">
                <div class="dash-title">‚ù§Ô∏è Apple Health Import</div>
                <div class="drop-zone" id="health-drop-zone">
                    <div class="drop-zone-content">
                        <div class="drop-zone-icon">üì•</div>
                        <div class="drop-zone-text">Sleep CSV hier of klik om te selecteren</div>
                    </div>
                    <input type="file" class="file-input" id="health-file-input" accept=".csv">
                </div>
                <div id="health-import-result" style="margin-top:0.75rem;font-size:0.75rem;"></div>
            </div>
        </section>

        <section id="screen-exercises" class="screen">
            <div class="ex-browser">
                <div class="ex-search-row">
                    <input type="text" class="ex-search" id="ex-search" placeholder="üîç Zoek oefening...">
                </div>
                <div class="ex-filters" id="ex-filters">
                    <button class="ex-filter active" data-pattern="all">Alles</button>
                    <button class="ex-filter" data-pattern="squat">Squat</button>
                    <button class="ex-filter" data-pattern="hinge">Hinge</button>
                    <button class="ex-filter" data-pattern="push_horizontal">Push H</button>
                    <button class="ex-filter" data-pattern="push_vertical">Push V</button>
                    <button class="ex-filter" data-pattern="pull_horizontal">Pull H</button>
                    <button class="ex-filter" data-pattern="pull_vertical">Pull V</button>
                    <button class="ex-filter" data-pattern="carry">Carry</button>
                    <button class="ex-filter" data-pattern="activation">Activatie</button>
                    <button class="ex-filter" data-pattern="isolation">Isolatie</button>
                </div>
                <div class="ex-count" id="ex-count"></div>
                <div class="ex-grid" id="ex-grid"></div>
            </div>
        </section>
    </main>

    <div class="modal" id="modal">
        <div class="modal-inner">
            <div class="modal-head">
                <span class="modal-title" id="modal-title"></span>
                <button class="modal-close" id="modal-close">‚úï</button>
            </div>
            <div class="modal-date" id="modal-date"></div>
            <div id="modal-body"></div>
            <div class="modal-btns">
                <button class="modal-btn ics" id="btn-ics">üìÜ</button>
                <button class="modal-btn cancel" id="btn-cancel">Annuleren</button>
                <button class="modal-btn delete" id="btn-delete">Verwijder</button>
                <button class="modal-btn save" id="btn-save">Opslaan</button>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
    (function() {
        'use strict';

        // ===========================================
        // EXERCISES DATABASE (met YouTube links)
        // ===========================================
        const EXERCISES = {
            // SQUAT PATTERN
            back_squat: { id: 'back_squat', name: 'Back Squat', pattern: 'squat', equipment: ['barbell'], muscles: { primary: ['quads', 'glutes'], secondary: ['core'] }, isMainLift: true, hint: 'Diepte boven gewicht', yt: 'R2dMsNhN3DE' },
            front_squat: { id: 'front_squat', name: 'Front Squat', pattern: 'squat', equipment: ['barbell'], muscles: { primary: ['quads'], secondary: ['core', 'upper_back'] }, hint: 'Ellebogen hoog', yt: '9xAkoz95IFE' },
            goblet_squat: { id: 'goblet_squat', name: 'Goblet Squat', pattern: 'squat', equipment: ['dumbbell', 'kettlebell'], muscles: { primary: ['quads', 'glutes'], secondary: ['core'] }, hint: 'Core aan', yt: '5Y3KW5rWMh4' },
            bulgarian_split_squat: { id: 'bulgarian_split_squat', name: 'Bulgarian Split Squat', pattern: 'squat', equipment: ['dumbbell', 'kettlebell', 'bodyweight'], muscles: { primary: ['quads', 'glutes'], secondary: ['core'] }, unilateral: true, hint: 'Per been', yt: 'uqI3GVwfToU' },
            leg_press: { id: 'leg_press', name: 'Leg Press', pattern: 'squat', equipment: ['machine'], muscles: { primary: ['quads', 'glutes'], secondary: [] }, hint: 'Voeten hoog voor glutes', yt: 'sEM_zo9w2ss' },
            leg_press_uni: { id: 'leg_press_uni', name: 'Leg Press uni', pattern: 'squat', equipment: ['machine'], muscles: { primary: ['quads', 'glutes'], secondary: [] }, unilateral: true, hint: 'Voet hoog', yt: 'sEM_zo9w2ss' },
            hack_squat: { id: 'hack_squat', name: 'Hack Squat', pattern: 'squat', equipment: ['machine'], muscles: { primary: ['quads'], secondary: ['glutes'] }, hint: 'Lage voetplaatsing', yt: '63tboDKQksc' },
            lunges: { id: 'lunges', name: 'Lunges', pattern: 'squat', equipment: ['dumbbell', 'bodyweight'], muscles: { primary: ['quads', 'glutes'], secondary: ['core'] }, unilateral: true, hint: 'Stap ver genoeg', yt: 'uRSsOoZG9z8' },
            step_ups: { id: 'step_ups', name: 'Step Ups', pattern: 'squat', equipment: ['dumbbell', 'bodyweight'], muscles: { primary: ['quads', 'glutes'], secondary: ['core'] }, unilateral: true, hint: 'Duw vanuit voorste been', yt: 'dQqApCGd5Ag' },
            sissy_squat: { id: 'sissy_squat', name: 'Sissy Squat', pattern: 'squat', equipment: ['bodyweight'], muscles: { primary: ['quads'], secondary: [] }, hint: 'Knie√´n naar voren', yt: 'pXYIofjmKn8' },

            // HINGE PATTERN
            conventional_deadlift: { id: 'conventional_deadlift', name: 'Conventional Deadlift', pattern: 'hinge', equipment: ['barbell'], muscles: { primary: ['hamstrings', 'glutes', 'lower_back'], secondary: ['lats', 'traps', 'grip'] }, isMainLift: true, hint: 'Rug neutraal!', yt: 'wjsu6ceEkAQ' },
            romanian_deadlift: { id: 'romanian_deadlift', name: 'Romanian Deadlift', pattern: 'hinge', equipment: ['barbell', 'dumbbell'], muscles: { primary: ['hamstrings', 'glutes'], secondary: ['lower_back'] }, hint: 'Hamstrings voelen', yt: '-m45n1_x32E' },
            stiff_leg_deadlift: { id: 'stiff_leg_deadlift', name: 'Stiff Leg Deadlift', pattern: 'hinge', equipment: ['barbell', 'dumbbell'], muscles: { primary: ['hamstrings'], secondary: ['glutes', 'lower_back'] }, hint: 'Benen bijna gestrekt', yt: 'CkrqLaDGvOA' },
            good_morning: { id: 'good_morning', name: 'Good Morning', pattern: 'hinge', equipment: ['barbell'], muscles: { primary: ['hamstrings', 'lower_back'], secondary: ['glutes'] }, hint: 'Licht gewicht', yt: '8sGgyquE1Bs' },
            hip_thrust: { id: 'hip_thrust', name: 'Hip Thrust', pattern: 'hinge', equipment: ['barbell', 'machine'], muscles: { primary: ['glutes'], secondary: ['hamstrings'] }, hint: 'Squeeze bovenaan', yt: 'lAnqN0J_p5A' },
            hip_hinge_stick: { id: 'hip_hinge_stick', name: 'Hip Hinge met stok', pattern: 'activation', equipment: ['bodyweight'], muscles: { primary: ['hamstrings'], secondary: [] }, isActivation: true, isCheck: true, hint: 'Techniek check', yt: '8sGgyquE1Bs' },
            nordic_curl: { id: 'nordic_curl', name: 'Nordic Curl', pattern: 'hinge', equipment: ['bodyweight'], muscles: { primary: ['hamstrings'], secondary: [] }, hint: 'Excentrisch focussen', yt: 'H8k-xijjXAc' },
            glute_bridge: { id: 'glute_bridge', name: 'Glute Bridge', pattern: 'hinge', equipment: ['bodyweight', 'barbell'], muscles: { primary: ['glutes'], secondary: ['hamstrings'] }, hint: 'Squeeze bovenaan', yt: 'lAnqN0J_p5A' },
            cable_pull_through: { id: 'cable_pull_through', name: 'Cable Pull Through', pattern: 'hinge', equipment: ['cable'], muscles: { primary: ['glutes', 'hamstrings'], secondary: [] }, hint: 'Heupen naar voren', yt: 'lAnqN0J_p5A' },
            leg_curl: { id: 'leg_curl', name: 'Leg Curl', pattern: 'hinge', equipment: ['machine'], muscles: { primary: ['hamstrings'], secondary: [] }, hint: 'Volledige ROM', yt: 'Orxowest56U' },

            // PUSH HORIZONTAL
            bench_press: { id: 'bench_press', name: 'Bench Press', pattern: 'push_horizontal', equipment: ['barbell'], muscles: { primary: ['chest', 'triceps'], secondary: ['front_delts'] }, isMainLift: true, hint: 'Schouderbladen gepind', yt: 'tuwHzzPdaGc' },
            incline_db_press: { id: 'incline_db_press', name: 'Incline DB Press', pattern: 'push_horizontal', equipment: ['dumbbell'], muscles: { primary: ['upper_chest', 'triceps'], secondary: ['front_delts'] }, angle: 'incline', hint: 'Bank 30-45¬∞', yt: '8nNi8jbbUPE' },
            incline_barbell_press: { id: 'incline_barbell_press', name: 'Incline Barbell Press', pattern: 'push_horizontal', equipment: ['barbell'], muscles: { primary: ['upper_chest', 'triceps'], secondary: ['front_delts'] }, angle: 'incline', hint: 'Bank 30¬∞', yt: '8nNi8jbbUPE' },
            dumbbell_bench_press: { id: 'dumbbell_bench_press', name: 'Dumbbell Bench Press', pattern: 'push_horizontal', equipment: ['dumbbell'], muscles: { primary: ['chest', 'triceps'], secondary: ['front_delts'] }, hint: 'Volle ROM', yt: 'dGqI0Z5ul4k' },
            dips: { id: 'dips', name: 'Dips', pattern: 'push_horizontal', equipment: ['bodyweight'], muscles: { primary: ['chest', 'triceps'], secondary: ['front_delts'] }, hint: 'BW = bodyweight', yt: 'FG1ENBFsdHU' },
            machine_chest_press: { id: 'machine_chest_press', name: 'Machine Chest Press', pattern: 'push_horizontal', equipment: ['machine'], muscles: { primary: ['chest', 'triceps'], secondary: ['front_delts'] }, hint: 'Squeeze bovenaan', yt: 'dGqI0Z5ul4k' },
            cable_fly: { id: 'cable_fly', name: 'Cable Fly', pattern: 'push_horizontal', equipment: ['cable'], muscles: { primary: ['chest'], secondary: [] }, hint: 'Lichte buiging elleboog', yt: 'OPYrUGZL8nU' },
            push_ups: { id: 'push_ups', name: 'Push Ups', pattern: 'push_horizontal', equipment: ['bodyweight'], muscles: { primary: ['chest', 'triceps'], secondary: ['front_delts', 'core'] }, hint: 'Core aan', yt: 'KEFQyLkDYtI' },

            // PUSH VERTICAL
            push_press: { id: 'push_press', name: 'Push Press', pattern: 'push_vertical', equipment: ['barbell'], muscles: { primary: ['shoulders', 'triceps'], secondary: ['upper_chest', 'core'] }, isMainLift: true, hint: 'Explosief uit dip', yt: 'zwy8skLFtVY' },
            overhead_press: { id: 'overhead_press', name: 'Overhead Press', pattern: 'push_vertical', equipment: ['barbell'], muscles: { primary: ['shoulders', 'triceps'], secondary: ['core'] }, hint: 'Strict form', yt: 'j7ULT6dznNc' },
            dumbbell_shoulder_press: { id: 'dumbbell_shoulder_press', name: 'DB Shoulder Press', pattern: 'push_vertical', equipment: ['dumbbell'], muscles: { primary: ['shoulders', 'triceps'], secondary: [] }, hint: 'Neutrale grip optie', yt: 'FRxZ6wr5bpA' },
            landmine_press: { id: 'landmine_press', name: 'Landmine Press', pattern: 'push_vertical', equipment: ['barbell'], muscles: { primary: ['shoulders', 'chest'], secondary: ['core'] }, hint: 'Schouder-vriendelijk', yt: 'BJ-FBP7ofSk' },
            arnold_press: { id: 'arnold_press', name: 'Arnold Press', pattern: 'push_vertical', equipment: ['dumbbell'], muscles: { primary: ['shoulders', 'triceps'], secondary: [] }, hint: 'Roteer tijdens beweging', yt: 'hmnZKRpYaV8' },
            lateral_raise: { id: 'lateral_raise', name: 'Lateral Raise', pattern: 'push_vertical', equipment: ['dumbbell', 'cable'], muscles: { primary: ['side_delts'], secondary: [] }, hint: 'Licht gewicht, hoge reps', yt: 'FeJP4E4Z-PY' },

            // PULL HORIZONTAL
            cable_row: { id: 'cable_row', name: 'Cable Row', pattern: 'pull_horizontal', equipment: ['cable'], muscles: { primary: ['lats', 'rhomboids'], secondary: ['biceps', 'rear_delts'] }, hint: 'Scapula squeeze', yt: 'UCXxvVItLoM' },
            seated_cable_row: { id: 'seated_cable_row', name: 'Seated Cable Row', pattern: 'pull_horizontal', equipment: ['cable'], muscles: { primary: ['lats', 'rhomboids'], secondary: ['biceps', 'rear_delts'] }, hint: 'Scapula squeeze', yt: 'UCXxvVItLoM' },
            chest_supported_row: { id: 'chest_supported_row', name: 'Chest Supported Row', pattern: 'pull_horizontal', equipment: ['machine', 'dumbbell'], muscles: { primary: ['lats', 'rhomboids'], secondary: ['biceps', 'rear_delts'] }, hint: 'Scapula focus', yt: 'paCfxhgW6bI' },
            dumbbell_row: { id: 'dumbbell_row', name: 'Dumbbell Row', pattern: 'pull_horizontal', equipment: ['dumbbell'], muscles: { primary: ['lats', 'rhomboids'], secondary: ['biceps', 'rear_delts'] }, unilateral: true, hint: 'Per arm', yt: 'DMo3HJoawrU' },
            barbell_row: { id: 'barbell_row', name: 'Barbell Row', pattern: 'pull_horizontal', equipment: ['barbell'], muscles: { primary: ['lats', 'rhomboids'], secondary: ['biceps', 'lower_back'] }, hint: '45¬∞ torso', yt: 'paCfxhgW6bI' },
            t_bar_row: { id: 't_bar_row', name: 'T-Bar Row', pattern: 'pull_horizontal', equipment: ['barbell'], muscles: { primary: ['lats', 'rhomboids'], secondary: ['biceps'] }, hint: 'Borst op pad', yt: 'yPis7nlbqdY' },
            face_pulls: { id: 'face_pulls', name: 'Face Pulls', pattern: 'pull_horizontal', equipment: ['cable'], muscles: { primary: ['rear_delts', 'rhomboids'], secondary: ['external_rotators'] }, isAccessory: true, hint: 'Ellebogen hoog', yt: '7ZvpXA_mFpQ' },
            seal_row: { id: 'seal_row', name: 'Seal Row', pattern: 'pull_horizontal', equipment: ['barbell', 'dumbbell'], muscles: { primary: ['lats', 'rhomboids'], secondary: ['biceps'] }, hint: 'Geen momentum', yt: 'paCfxhgW6bI' },
            meadows_row: { id: 'meadows_row', name: 'Meadows Row', pattern: 'pull_horizontal', equipment: ['barbell'], muscles: { primary: ['lats'], secondary: ['biceps', 'rear_delts'] }, unilateral: true, hint: 'Landmine setup', yt: 'BJ-FBP7ofSk' },

            // PULL VERTICAL
            lat_pulldown: { id: 'lat_pulldown', name: 'Lat Pulldown', pattern: 'pull_vertical', equipment: ['cable'], muscles: { primary: ['lats'], secondary: ['biceps', 'rear_delts'] }, hint: 'Voorzichtig lat!', yt: 'iKrKgWR9wbY' },
            pull_ups: { id: 'pull_ups', name: 'Pull Ups', pattern: 'pull_vertical', equipment: ['bodyweight'], muscles: { primary: ['lats'], secondary: ['biceps', 'rear_delts'] }, hint: 'Volle ROM', yt: 'poyr8KenUfc' },
            chin_ups: { id: 'chin_ups', name: 'Chin Ups', pattern: 'pull_vertical', equipment: ['bodyweight'], muscles: { primary: ['lats', 'biceps'], secondary: ['rear_delts'] }, hint: 'Onderhandse grip', yt: '1EJ3A3rEtlo' },
            neutral_grip_pulldown: { id: 'neutral_grip_pulldown', name: 'Neutral Grip Pulldown', pattern: 'pull_vertical', equipment: ['cable'], muscles: { primary: ['lats'], secondary: ['biceps'] }, hint: 'Schouder-vriendelijk', yt: 'iKrKgWR9wbY' },
            straight_arm_pulldown: { id: 'straight_arm_pulldown', name: 'Straight Arm Pulldown', pattern: 'pull_vertical', equipment: ['cable'], muscles: { primary: ['lats'], secondary: ['triceps'] }, hint: 'Armen gestrekt', yt: 'gDtXrJWPdlY' },

            // CARRY / GRIP
            dead_hang: { id: 'dead_hang', name: 'Dead Hang', pattern: 'carry', equipment: ['bodyweight'], muscles: { primary: ['grip', 'lats'], secondary: ['core'] }, isTimed: true, hint: 'Max hold', yt: 'QioKpkp6lvI' },
            btbbh: { id: 'btbbh', name: 'BTBBH', pattern: 'carry', equipment: ['barbell'], muscles: { primary: ['grip', 'traps'], secondary: ['core'] }, isTimed: true, hint: '2x max hold', yt: 'QioKpkp6lvI' },
            farmer_walk: { id: 'farmer_walk', name: 'Farmer Walk', pattern: 'carry', equipment: ['dumbbell', 'kettlebell'], muscles: { primary: ['grip', 'traps', 'core'], secondary: [] }, isTimed: true, hint: 'Schouders laag', yt: 'j8c9uNjr7nQ' },
            suitcase_carry: { id: 'suitcase_carry', name: 'Suitcase Carry', pattern: 'carry', equipment: ['dumbbell', 'kettlebell'], muscles: { primary: ['grip', 'obliques', 'core'], secondary: [] }, unilateral: true, isTimed: true, hint: 'Rechtop blijven', yt: 'j8c9uNjr7nQ' },

            // ACTIVATION
            scapula_retractions: { id: 'scapula_retractions', name: 'Scapula Retractions', pattern: 'activation', equipment: ['bodyweight'], muscles: { primary: ['rhomboids', 'mid_traps'], secondary: [] }, isActivation: true, isCheck: true, hint: 'Activatie', yt: 'nMB_zabRo74' },
            band_pull_aparts: { id: 'band_pull_aparts', name: 'Band Pull Aparts', pattern: 'activation', equipment: ['band'], muscles: { primary: ['rear_delts', 'rhomboids'], secondary: [] }, isActivation: true, hint: 'Lichte band', yt: 'nMB_zabRo74' },
            shoulder_dislocates: { id: 'shoulder_dislocates', name: 'Shoulder Dislocates', pattern: 'activation', equipment: ['band', 'bodyweight'], muscles: { primary: ['shoulders'], secondary: [] }, isActivation: true, hint: 'Brede grip', yt: 'nMB_zabRo74' },
            cat_cow: { id: 'cat_cow', name: 'Cat Cow', pattern: 'activation', equipment: ['bodyweight'], muscles: { primary: ['spine'], secondary: ['core'] }, isActivation: true, hint: 'Langzaam bewegen', yt: 'kqnua4rHVVA' },
            bird_dog: { id: 'bird_dog', name: 'Bird Dog', pattern: 'activation', equipment: ['bodyweight'], muscles: { primary: ['core', 'glutes'], secondary: ['shoulders'] }, isActivation: true, hint: 'Tegenovergestelde arm/been', yt: 'wiFNA3sqjCA' },

            // ARM ISOLATION
            bicep_curl: { id: 'bicep_curl', name: 'Bicep Curl', pattern: 'isolation', equipment: ['dumbbell', 'barbell', 'cable'], muscles: { primary: ['biceps'], secondary: [] }, hint: 'Ellebogen stil', yt: 'av7-8igSXTs' },
            hammer_curl: { id: 'hammer_curl', name: 'Hammer Curl', pattern: 'isolation', equipment: ['dumbbell'], muscles: { primary: ['biceps', 'brachialis'], secondary: ['forearms'] }, hint: 'Neutrale grip', yt: 'CFBZ4jN1CMI' },
            tricep_pushdown: { id: 'tricep_pushdown', name: 'Tricep Pushdown', pattern: 'isolation', equipment: ['cable'], muscles: { primary: ['triceps'], secondary: [] }, hint: 'Ellebogen langs lichaam', yt: 'mpZ9VRisAyw' },
            skull_crusher: { id: 'skull_crusher', name: 'Skull Crusher', pattern: 'isolation', equipment: ['barbell', 'dumbbell'], muscles: { primary: ['triceps'], secondary: [] }, hint: 'Ellebogen naar binnen', yt: 'K6MSN4hCDM4' },
            overhead_tricep_ext: { id: 'overhead_tricep_ext', name: 'Overhead Tricep Extension', pattern: 'isolation', equipment: ['dumbbell', 'cable'], muscles: { primary: ['triceps'], secondary: [] }, hint: 'Stretch onderaan', yt: 'mpZ9VRisAyw' }
        };

        // ===========================================
        // TRAINING TEMPLATES (slot-based)
        // ===========================================
        const SLOT_TEMPLATES = {
            A: {
                name: 'Squat',
                mainLift: 'back_squat',
                slots: [
                    { order: 1, role: 'main', exerciseId: 'back_squat', sets: 4, reps: 5 },
                    { order: 2, role: 'accessory', pattern: 'hinge', sets: 3, reps: 10, exclude: ['conventional_deadlift'] },
                    { order: 3, role: 'accessory', pattern: 'push_horizontal', angle: 'incline', sets: 3, reps: 10 },
                    { order: 4, role: 'accessory', pattern: 'pull_horizontal', sets: 3, reps: 10 },
                    { order: 5, role: 'finisher', pattern: 'carry', sets: 1, isTimed: true }
                ]
            },
            B: {
                name: 'Bench Press',
                mainLift: 'bench_press',
                slots: [
                    { order: 1, role: 'activation', exerciseId: 'scapula_retractions', sets: 2, reps: 15 },
                    { order: 2, role: 'main', exerciseId: 'bench_press', sets: 4, reps: 5 },
                    { order: 3, role: 'accessory', pattern: 'pull_horizontal', sets: 3, reps: 10 },
                    { order: 4, role: 'accessory', pattern: 'squat', prefer: 'unilateral', sets: 3, reps: 10 },
                    { order: 5, role: 'accessory', exerciseId: 'face_pulls', sets: 2, reps: 15 },
                    { order: 6, role: 'finisher', exerciseId: 'btbbh', sets: 2, isTimed: true }
                ]
            },
            C: {
                name: 'Deadlift',
                mainLift: 'conventional_deadlift',
                slots: [
                    { order: 1, role: 'activation', exerciseId: 'hip_hinge_stick', sets: 2, reps: 8 },
                    { order: 2, role: 'main', exerciseId: 'conventional_deadlift', sets: 4, reps: 5 },
                    { order: 3, role: 'accessory', pattern: 'squat', prefer: 'unilateral', sets: 3, reps: 10 },
                    { order: 4, role: 'accessory', pattern: 'pull_horizontal', prefer: 'unilateral', sets: 3, reps: 10 },
                    { order: 5, role: 'accessory', pattern: 'push_horizontal', sets: 3, reps: 10 },
                    { order: 6, role: 'finisher', exerciseId: 'dead_hang', sets: 1, isTimed: true }
                ]
            },
            D: {
                name: 'Push Press',
                mainLift: 'push_press',
                slots: [
                    { order: 1, role: 'activation', exerciseId: 'scapula_retractions', sets: 2, reps: 15 },
                    { order: 2, role: 'main', exerciseId: 'push_press', sets: 4, reps: 5 },
                    { order: 3, role: 'accessory', pattern: 'pull_vertical', sets: 3, reps: 10 },
                    { order: 4, role: 'accessory', pattern: 'squat', exclude: ['back_squat', 'front_squat'], sets: 3, reps: 10 },
                    { order: 5, role: 'accessory', pattern: 'pull_horizontal', sets: 3, reps: 10 },
                    { order: 6, role: 'finisher', exerciseId: 'btbbh', sets: 2, isTimed: true }
                ]
            }
        };

        // Initial data
        const INIT = [
            { id: 1, date: '2025-12-22', day: 'D', lift: 'Push Press', week: 2, exercises: [
                { name: 'Scapula Retractions', type: 'check', done: true },
                { name: 'Push Press', type: 'weight', sets: [{w:'20',r:'10',warmup:true},{w:'30',r:'10',warmup:true},{w:'40',r:'5'},{w:'45',r:'5'},{w:'50',r:'5'}]},
                { name: 'Lat Pulldown', type: 'weight', sets: [{w:'75',r:'10'},{w:'85',r:'10'},{w:'95',r:'10'}]},
                { name: 'Goblet Squat', type: 'weight', sets: [{w:'20',r:'10'},{w:'28',r:'10'},{w:'32',r:'10'}], equip: 'KB'},
                { name: 'Seated Cable Row', type: 'weight', sets: [{w:'75',r:'10'},{w:'85',r:'10'},{w:'95',r:'10'}]},
                { name: 'BTBBH', type: 'timed', sets: [], skipped: true, skipReason: 'Geen mogelijkheid in gym'}
            ]},
            { id: 2, date: '2025-12-20', day: 'C', lift: 'Deadlift', week: 1, exercises: [
                { name: 'Hip Hinge met stok', type: 'check', done: true },
                { name: 'Conventional Deadlift', type: 'weight', sets: [{w:'70',r:'5',warmup:true},{w:'90',r:'5'},{w:'100',r:'5'},{w:'110',r:'5'}]},
                { name: 'Leg Press uni', type: 'weight', sets: [{w:'40',r:'10'},{w:'60',r:'10'},{w:'70',r:'10'}]},
                { name: 'Dumbbell Row', type: 'weight', sets: [{w:'24',r:'10'},{w:'26',r:'10'},{w:'28',r:'10'}]},
                { name: 'Dips', type: 'weight', sets: [{w:'BW',r:'10'},{w:'BW',r:'10'},{w:'BW',r:'10'}]},
                { name: 'Dead Hang', type: 'timed', sets: [{w:'BW',t:'50'}]}
            ]},
            { id: 3, date: '2025-12-17', day: 'B', lift: 'Bench Press', week: 1, exercises: [
                { name: 'Scapula Retractions', type: 'check', done: true },
                { name: 'Bench Press', type: 'weight', sets: [{w:'20',r:'5',warmup:true},{w:'50',r:'5'},{w:'70',r:'5'},{w:'80',r:'5'},{w:'85',r:'5'},{w:'90',r:'5'}]},
                { name: 'Chest Supported Row', type: 'weight', sets: [{w:'30',r:'10'},{w:'40',r:'10'},{w:'50',r:'10'}]},
                { name: 'Bulgarian Split Squat', type: 'weight', sets: [{w:'20',r:'10'},{w:'20',r:'10'},{w:'20',r:'10'}]},
                { name: 'Face Pulls', type: 'weight', sets: [{w:'40',r:'15'},{w:'45',r:'15'}]},
                { name: 'BTBBH', type: 'timed', sets: [{w:'60',t:'60'},{w:'60',t:'40'}]}
            ]},
            { id: 4, date: '2025-12-15', day: 'A', lift: 'Squat', week: 1, exercises: [
                { name: 'Back Squat', type: 'weight', sets: [{w:'20',r:'5',warmup:true},{w:'40',r:'5'},{w:'50',r:'5'},{w:'60',r:'5'}]},
                { name: 'Romanian Deadlift', type: 'weight', sets: [{w:'20',r:'10',warmup:true},{w:'50',r:'10'},{w:'70',r:'10'},{w:'80',r:'10'}]},
                { name: 'Incline DB Press', type: 'weight', sets: [{w:'48',r:'10'},{w:'56',r:'10'},{w:'60',r:'10'}]},
                { name: 'Cable Row', type: 'weight', sets: [{w:'75',r:'10'},{w:'85',r:'10'},{w:'95',r:'10'}]},
                { name: 'Dead Hang', type: 'timed', sets: [{w:'BW',t:'20'}]}
            ]}
        ];

        // Cardio types
        const CARDIO_TYPES = {
            running: { id: 'running', name: 'Hardlopen', icon: 'üèÉ', hasDistance: true, unit: 'km' },
            cycling: { id: 'cycling', name: 'Fietsen', icon: 'üö¥', hasDistance: true, unit: 'km' },
            rowing: { id: 'rowing', name: 'Roeien', icon: 'üö£', hasDistance: true, unit: 'm' },
            hiit: { id: 'hiit', name: 'HIIT', icon: '‚ö°', hasDistance: false, hasIntervals: true },
            walking: { id: 'walking', name: 'Wandelen', icon: 'üö∂', hasDistance: true, unit: 'km' },
            other: { id: 'other', name: 'Anders', icon: 'üí™', hasDistance: false }
        };

        // State
        let data = JSON.parse(localStorage.getItem('liftlog3')) || INIT;
        if (!localStorage.getItem('liftlog3')) localStorage.setItem('liftlog3', JSON.stringify(INIT));
        let selectedDay = null;
        let current = null;
        let editIdx = null;
        let editData = null;
        let globalCollapsed = false;
        let currentMode = 'lifting';
        let selectedCardioType = null;
        let cardioData = null;
        let trainingCardio = []; // Cardio binnen een lifting training

        // DOM
        const $ = id => document.getElementById(id);
        const exEl = $('exercises');
        const saveBtn = $('save-btn');
        const dateInput = $('date-input');
        const timeInput = $('time-input');
        const modal = $('modal');
        const modalBody = $('modal-body');
        const toast = $('toast');
        const collapseAllRow = $('collapse-all-row');
        const collapseAllBtn = $('collapse-all-btn');

        // Date helpers
        const toDisplayDate = d => { const p = d.split('-'); return p[2] + '-' + p[1] + '-' + p[0]; }; // YYYY-MM-DD -> DD-MM-YYYY
        const toISODate = d => { const p = d.split('-'); return p[2] + '-' + p[1] + '-' + p[0]; }; // DD-MM-YYYY -> YYYY-MM-DD
        const isValidDate = d => { const p = d.split('-'); if (p.length !== 3) return false; const [dd,mm,yyyy] = p.map(Number); if (!dd||!mm||!yyyy) return false; const dt = new Date(yyyy,mm-1,dd); return dt.getDate()===dd && dt.getMonth()===mm-1 && dt.getFullYear()===yyyy; };
        const isValidTime = t => { const p = t.split(':'); if (p.length !== 2) return false; const [hh,mm] = p.map(Number); return !isNaN(hh) && !isNaN(mm) && hh >= 0 && hh <= 23 && mm >= 0 && mm <= 59; };
        const toISOTimestamp = (dateStr, timeStr) => { const isoDate = toISODate(dateStr); return `${isoDate}T${timeStr}:00`; };

        // Init
        const today = new Date();
        dateInput.value = today.getDate().toString().padStart(2,'0') + '-' + (today.getMonth()+1).toString().padStart(2,'0') + '-' + today.getFullYear();
        timeInput.value = today.getHours().toString().padStart(2,'0') + ':' + today.getMinutes().toString().padStart(2,'0');
        const wk = Math.max(1, Math.ceil((new Date() - new Date('2025-12-15')) / 604800000));
        $('week-num').textContent = wk;

        // Date input validation
        dateInput.oninput = () => {
            let v = dateInput.value.replace(/[^\d-]/g, '');
            // Auto-insert dashes
            if (v.length === 2 && !v.includes('-')) v += '-';
            if (v.length === 5 && v.split('-').length === 2) v += '-';
            dateInput.value = v;
            dateInput.classList.toggle('invalid', v.length >= 10 && !isValidDate(v));
        };

        // Time input validation
        timeInput.oninput = () => {
            let v = timeInput.value.replace(/[^\d:]/g, '');
            // Auto-insert colon
            if (v.length === 2 && !v.includes(':')) v += ':';
            timeInput.value = v;
            timeInput.classList.toggle('invalid', v.length >= 5 && !isValidTime(v));
        };

        // Helpers
        const showToast = msg => { toast.textContent = msg; toast.classList.add('show'); setTimeout(() => toast.classList.remove('show'), 2000); };
        const fmtDate = d => { const dt = new Date(d); return ['Zo','Ma','Di','Wo','Do','Vr','Za'][dt.getDay()] + ' ' + dt.getDate() + '-' + (dt.getMonth()+1); };
        const getPrev = (day, name) => { const t = data.find(x => x.day === day); return t ? t.exercises.find(e => e.name === name) : null; };
        const getPrevWithDate = name => {
            for (const t of data) {
                const ex = t.exercises.find(e => e.name === name && !e.skipped);
                if (ex && (ex.done || (ex.sets && ex.sets.length))) return { date: t.date, ex };
            }
            return null;
        };
        const save = () => localStorage.setItem('liftlog3', JSON.stringify(data));

        // ===========================================
        // SMART SELECTION LOGIC
        // ===========================================
        function getRecentExerciseIds(days = 3) {
            const cutoff = new Date();
            cutoff.setDate(cutoff.getDate() - days);
            return data
                .filter(t => new Date(t.date) >= cutoff)
                .flatMap(t => t.exercises.map(ex => ex.id || ex.name))
                .filter(Boolean);
        }

        function selectExerciseForSlot(slot) {
            // 1. Als slot een vast exerciseId heeft, gebruik die
            if (slot.exerciseId) {
                return EXERCISES[slot.exerciseId];
            }

            // 2. Filter oefeningen op pattern
            let candidates = Object.values(EXERCISES)
                .filter(ex => ex.pattern === slot.pattern);

            // 3. Filter op angle indien gespecificeerd
            if (slot.angle) {
                const withAngle = candidates.filter(ex => ex.angle === slot.angle);
                if (withAngle.length > 0) candidates = withAngle;
            }

            // 4. Filter op unilateral indien preferred
            if (slot.prefer === 'unilateral') {
                const unilateral = candidates.filter(ex => ex.unilateral);
                if (unilateral.length > 0) candidates = unilateral;
            }

            // 5. Exclude specifieke oefeningen
            if (slot.exclude) {
                candidates = candidates.filter(ex => !slot.exclude.includes(ex.id));
            }

            // 6. Exclude main lifts voor accessory slots
            if (slot.role === 'accessory') {
                candidates = candidates.filter(ex => !ex.isMainLift);
            }

            // 7. Exclude recent gedane oefeningen (laatste 3 trainingen)
            const recentIds = getRecentExerciseIds(7);
            const notRecent = candidates.filter(ex => !recentIds.includes(ex.id) && !recentIds.includes(ex.name));

            // 8. Als er niet-recente opties zijn, gebruik die
            if (notRecent.length > 0) {
                candidates = notRecent;
            }

            // 9. Return random uit overgebleven candidates
            if (candidates.length === 0) return null;
            return candidates[Math.floor(Math.random() * candidates.length)];
        }

        function getAlternativesForExercise(exercise) {
            // Vind alternatieven met hetzelfde pattern
            return Object.values(EXERCISES)
                .filter(ex => ex.pattern === exercise.pattern && ex.id !== exercise.id && !ex.isMainLift && !ex.isActivation)
                .sort((a, b) => a.name.localeCompare(b.name));
        }

        // Update day buttons to show which have data
        function updateDayButtons() {
            const daysWithData = new Set(data.map(t => t.day));
            document.querySelectorAll('.day-btn').forEach(btn => {
                btn.classList.toggle('has-data', daysWithData.has(btn.dataset.day));
            });
        }
        updateDayButtons();

        // Nav
        document.querySelectorAll('.nav button').forEach(btn => {
            btn.onclick = () => {
                document.querySelectorAll('.nav button').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                $('screen-' + btn.dataset.screen).classList.add('active');
                if (btn.dataset.screen === 'history') renderHistory();
                if (btn.dataset.screen === 'progress') renderProgress();
                if (btn.dataset.screen === 'dashboard') renderDashboard();
                if (btn.dataset.screen === 'exercises') renderExercises();
            };
        });

        // Mode toggle (Lifting / Cardio)
        document.querySelectorAll('.mode-btn').forEach(btn => {
            btn.onclick = () => {
                document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentMode = btn.dataset.mode;
                $('lifting-section').style.display = currentMode === 'lifting' ? 'block' : 'none';
                $('cardio-section').style.display = currentMode === 'cardio' ? 'block' : 'none';
                $('exercises').style.display = currentMode === 'lifting' ? 'block' : 'none';
                $('collapse-all-row').style.display = currentMode === 'lifting' && current ? 'flex' : 'none';
                updateSave();
            };
        });

        // Cardio type selection
        document.querySelectorAll('.cardio-btn').forEach(btn => {
            btn.onclick = () => {
                document.querySelectorAll('.cardio-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                selectedCardioType = btn.dataset.type;
                buildCardioForm();
            };
        });

        function buildCardioForm() {
            if (!selectedCardioType) { $('cardio-form-container').innerHTML = ''; return; }
            const type = CARDIO_TYPES[selectedCardioType];
            cardioData = { type: selectedCardioType, duration: '', notes: '' };

            let html = '<div class="cardio-form">';
            html += '<div class="cardio-field" style="margin-bottom:0.75rem;"><label>Duur (min)</label><input type="text" inputmode="numeric" id="cardio-duration" placeholder="30" style="font-size:1.25rem;"></div>';
            html += '<div class="cardio-field"><label>Notities (optioneel)</label><textarea class="notes-input" id="cardio-notes" placeholder=""></textarea></div>';
            html += '<div style="font-size:0.7rem;color:var(--text3);margin-top:0.5rem;">üí° Kcal en hartslag komen via Apple Health import</div>';
            html += '</div>';

            $('cardio-form-container').innerHTML = html;

            // Event listeners
            $('cardio-duration').oninput = e => { cardioData.duration = e.target.value; updateSave(); };
            $('cardio-notes').oninput = e => { cardioData.notes = e.target.value; };

            updateSave();
        }

        // Day selection
        document.querySelectorAll('.day-btn').forEach(btn => {
            btn.onclick = () => {
                document.querySelectorAll('.day-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                selectedDay = btn.dataset.day;
                buildForm();
            };
        });

        // Build form using smart selection
        function buildForm() {
            if (!selectedDay) { exEl.innerHTML = ''; return; }
            const tmpl = SLOT_TEMPLATES[selectedDay];

            current = {
                day: selectedDay,
                lift: tmpl.name,
                exercises: tmpl.slots.map(slot => {
                    // Selecteer oefening voor deze slot
                    const exercise = selectExerciseForSlot(slot);
                    if (!exercise) return null;

                    // Bepaal type
                    const type = exercise.isCheck || exercise.isActivation && exercise.isCheck ? 'check' :
                                 exercise.isTimed || slot.isTimed ? 'timed' : 'weight';

                    // Zoek vorige data voor deze oefening
                    const prev = getPrev(selectedDay, exercise.name);

                    // Basis exercise object
                    const ex = {
                        id: exercise.id,
                        name: exercise.name,
                        pattern: exercise.pattern,
                        sets: slot.sets,
                        reps: slot.reps || null,
                        type: type,
                        hint: exercise.hint || '',
                        role: slot.role,
                        canSwap: slot.role === 'accessory' || slot.role === 'finisher',
                        skipped: false,
                        collapsed: globalCollapsed, // Gebruik globale collapsed state
                        notes: ''
                    };

                    // Equipment opties
                    if (exercise.equipment && exercise.equipment.length > 1) {
                        ex.hasEquip = true;
                        ex.equipOptions = exercise.equipment;
                        ex.equip = prev?.equip || '';
                    }

                    // Sets data - altijd leeg starten (clean slate)
                    if (type === 'check') {
                        ex.done = false;
                    } else if (type === 'timed') {
                        ex.setsData = Array(slot.sets).fill().map(() => ({w:'',t:''}));
                    } else {
                        ex.setsData = Array(slot.sets).fill().map(() => ({w:'',r:'',warmup:false}));
                    }
                    console.log('buildForm:', ex.name, 'type:', type, 'setsData:', JSON.stringify(ex.setsData), 'done:', ex.done);

                    return ex;
                }).filter(Boolean)
            };
            trainingCardio = []; // Reset cardio bij nieuwe training
            renderForm();
            $('add-cardio-btn').style.display = 'block';
            $('training-cardio').innerHTML = '';
        }

        // Swap exercise
        function swapExercise(ei, newExerciseId, isOriginal) {
            const ex = current.exercises[ei];
            const newExercise = EXERCISES[newExerciseId];
            if (!newExercise) return;

            if (isOriginal) {
                // Terug naar origineel
                ex.id = ex.originalId;
                ex.name = ex.originalName;
                ex.pattern = ex.originalPattern;
                ex.hint = EXERCISES[ex.originalId]?.hint || '';
                delete ex.originalId;
                delete ex.originalName;
                delete ex.originalPattern;
            } else {
                // Sla origineel op als nog niet gedaan
                if (!ex.originalId) {
                    ex.originalId = ex.id;
                    ex.originalName = ex.name;
                    ex.originalPattern = ex.pattern;
                }
                // Wissel naar nieuwe oefening
                ex.id = newExercise.id;
                ex.name = newExercise.name;
                ex.pattern = newExercise.pattern;
                ex.hint = newExercise.hint || '';
            }

            // Update equipment opties
            const exercise = EXERCISES[ex.id];
            if (exercise?.equipment?.length > 1) {
                ex.hasEquip = true;
                ex.equipOptions = exercise.equipment;
            } else {
                ex.hasEquip = false;
                delete ex.equipOptions;
            }
            ex.equip = '';

            // Reset sets data
            ex.setsData = Array(ex.sets).fill().map(() => ex.type === 'timed' ? {w:'',t:''} : {w:'',r:ex.reps||'',warmup:false});
            renderForm();
        }

        // Render form
        function renderForm() {
            let html = '';
            current.exercises.forEach((ex, ei) => {
                const done = ex.skipped ? false : (ex.type === 'check' ? ex.done : ex.setsData?.some(s => s.w || s.t));
                const isCollapsed = ex.collapsed && !ex.skipped;
                const cardClass = (ex.skipped ? 'skipped' : (done ? 'done' : '')) + (isCollapsed ? ' collapsed' : '');
                console.log('renderForm:', ex.name, 'done:', done, 'class:', cardClass, 'setsData:', JSON.stringify(ex.setsData));

                // Summary voor ingeklapte weergave
                let summaryText = '';
                if (!ex.skipped) {
                    if (ex.type === 'check') {
                        summaryText = ex.done ? '‚úì' : '‚óã';
                    } else if (ex.setsData) {
                        const filledSets = ex.setsData.filter(s => s.w || s.t);
                        if (filledSets.length > 0) {
                            if (ex.type === 'timed') {
                                summaryText = filledSets.map(s => `${s.w}√ó${s.t}s`).join(' / ');
                            } else {
                                summaryText = filledSets.filter(s => !s.warmup).map(s => `${s.w}√ó${s.r}`).join(' / ');
                            }
                        } else {
                            summaryText = `${ex.sets}√ó${ex.reps || 'max'} (leeg)`;
                        }
                    }
                }

                const prev = getPrevWithDate(ex.name);
                let prevHtml = '';
                if (prev) {
                    if (prev.ex.type === 'check') {
                        prevHtml = `<div class="ex-prev"><span class="ex-prev-date">${fmtDate(prev.date)}</span> ‚úì</div>`;
                    } else if (prev.ex.sets && prev.ex.sets.length) {
                        const setsStr = prev.ex.sets.map(s => s.warmup ? '' : (prev.ex.type === 'timed' ? `${s.w}√ó${s.t}s` : `${s.w}√ó${s.r}`)).filter(Boolean).join(' / ');
                        prevHtml = `<div class="ex-prev"><span class="ex-prev-date">${fmtDate(prev.date)}</span> ${setsStr}</div>`;
                    }
                }

                const swapHtml = ex.canSwap ? `<button class="swap-btn" data-ei="${ei}">‚áÑ</button>` : '';
                const collapseBtn = !ex.skipped ? `<button class="collapse-btn" data-ei="${ei}">${ex.collapsed ? '‚ñ∂' : '‚ñº'}</button>` : '';
                const exercise = EXERCISES[ex.id];
                const ytBtn = exercise?.yt ? `<a href="https://youtube.com/watch?v=${exercise.yt}" target="_blank" class="yt-btn">‚ñ∂</a>` : '';

                html += `<div class="ex-card ${cardClass}" data-ei="${ei}">`;
                html += `<div class="ex-head"><div><span class="ex-name">${ex.name}</span>${ytBtn}<span class="ex-btns"><button class="skip-btn ${ex.skipped?'active':''}" data-ei="${ei}">${ex.skipped?'‚è≠Ô∏è Overgeslagen':'Skip'}</button>${swapHtml}${collapseBtn}</span></div><span class="ex-rx">${ex.sets}x${ex.reps||'max'}</span></div>`;
                html += `<div class="ex-summary">${summaryText}</div>`;

                // Body wrapper voor collapse
                html += `<div class="ex-body">`;
                html += `<div class="ex-hint">${ex.hint}</div>${prevHtml}`;

                if (!ex.skipped) {
                    // Equipment selector for applicable exercises
                    if (ex.hasEquip && ex.equipOptions) {
                        html += `<div class="equip-row">`;
                        ex.equipOptions.forEach(eq => {
                            const eqLabel = eq === 'dumbbell' ? 'DB' : eq === 'kettlebell' ? 'KB' : eq === 'barbell' ? 'BB' : eq;
                            html += `<button class="equip-btn ${ex.equip===eq?'active':''}" data-ei="${ei}" data-eq="${eq}">${eqLabel}</button>`;
                        });
                        html += `</div>`;
                    }

                    if (ex.type === 'check') {
                        html += `<div class="check-row"><button class="check-btn ${ex.done?'checked':''}" data-ei="${ei}">${ex.done?'‚úì':''}</button><span>Tik als gedaan</span></div>`;
                    } else if (ex.type === 'timed') {
                        ex.setsData.forEach((s, si) => {
                            html += `<div class="set-row"><span class="set-num">${si+1}:</span><input type="text" inputmode="decimal" class="set-input" data-ei="${ei}" data-si="${si}" data-f="w" placeholder="${ex.phW||'BW'}" value="${s.w||''}"><span class="set-unit">kg</span><input type="text" inputmode="numeric" class="set-input" data-ei="${ei}" data-si="${si}" data-f="t" placeholder="${ex.phT||''}" value="${s.t||''}"><span class="set-unit">sec</span></div>`;
                        });
                    } else {
                        ex.setsData.forEach((s, si) => {
                            html += `<div class="set-row"><span class="set-num">${si+1}:</span><input type="text" inputmode="decimal" class="set-input ${s.warmup?'warmup':''}" data-ei="${ei}" data-si="${si}" data-f="w" placeholder="${ex.ph||''}" value="${s.w||''}"><span class="set-unit">kg</span><input type="text" inputmode="numeric" class="set-input ${s.warmup?'warmup':''}" data-ei="${ei}" data-si="${si}" data-f="r" placeholder="${ex.reps||''}" value="${s.r||''}"><span class="set-unit">reps</span><button class="warmup-btn ${s.warmup?'active':''}" data-ei="${ei}" data-si="${si}">w-up</button></div>`;
                        });
                        html += `<button class="add-btn" data-ei="${ei}">+</button>`;
                    }
                }

                // Notes field
                html += `<textarea class="notes-input" data-ei="${ei}" placeholder="Notities...">${ex.notes||''}</textarea>`;
                html += '</div></div>'; // close ex-body and ex-card
            });
            exEl.innerHTML = html;
            
            // Listeners
            exEl.querySelectorAll('.set-input').forEach(inp => {
                inp.oninput = () => { 
                    // Only allow numbers, decimal point, and BW
                    let val = inp.value.toUpperCase();
                    if (val !== 'BW' && val !== 'B') {
                        val = val.replace(/[^0-9.,]/g, '').replace(',', '.');
                    }
                    inp.value = val;
                    current.exercises[+inp.dataset.ei].setsData[+inp.dataset.si][inp.dataset.f] = val; 
                    updateSave(); 
                };
                inp.onfocus = () => inp.select();
            });
            exEl.querySelectorAll('.check-btn').forEach(btn => {
                btn.onclick = () => { current.exercises[+btn.dataset.ei].done = !current.exercises[+btn.dataset.ei].done; renderForm(); };
            });
            exEl.querySelectorAll('.warmup-btn').forEach(btn => {
                btn.onclick = () => { current.exercises[+btn.dataset.ei].setsData[+btn.dataset.si].warmup = !current.exercises[+btn.dataset.ei].setsData[+btn.dataset.si].warmup; renderForm(); };
            });
            exEl.querySelectorAll('.add-btn').forEach(btn => {
                btn.onclick = () => { const ex = current.exercises[+btn.dataset.ei]; ex.setsData.push({w:'',r:ex.reps||'',warmup:false}); renderForm(); };
            });
            exEl.querySelectorAll('.skip-btn').forEach(btn => {
                btn.onclick = () => { current.exercises[+btn.dataset.ei].skipped = !current.exercises[+btn.dataset.ei].skipped; renderForm(); };
            });
            exEl.querySelectorAll('.swap-btn').forEach(btn => {
                btn.onclick = e => {
                    e.stopPropagation();
                    document.querySelectorAll('.swap-menu').forEach(m => m.remove());
                    const ei = +btn.dataset.ei;
                    const ex = current.exercises[ei];
                    const currentExercise = EXERCISES[ex.id];
                    const alts = getAlternativesForExercise(currentExercise);
                    const recentIds = getRecentExerciseIds(7);

                    const menu = document.createElement('div');
                    menu.className = 'swap-menu';

                    // Add original option if swapped
                    if (ex.originalId) {
                        const origBtn = document.createElement('button');
                        origBtn.textContent = `‚Ü© ${ex.originalName}`;
                        origBtn.onclick = () => { swapExercise(ei, ex.originalId, true); menu.remove(); };
                        menu.appendChild(origBtn);
                    }

                    // Add alternatives
                    alts.forEach(alt => {
                        if (alt.id === ex.id) return;
                        const altBtn = document.createElement('button');
                        const isRecent = recentIds.includes(alt.id) || recentIds.includes(alt.name);
                        altBtn.textContent = alt.name;
                        altBtn.style.color = isRecent ? 'var(--text3)' : '';
                        altBtn.onclick = () => { swapExercise(ei, alt.id, false); menu.remove(); };
                        menu.appendChild(altBtn);
                    });

                    btn.closest('.ex-head').appendChild(menu);
                    const closeMenu = e2 => { if (!menu.contains(e2.target)) { menu.remove(); document.removeEventListener('click', closeMenu); } };
                    setTimeout(() => document.addEventListener('click', closeMenu), 0);
                };
            });
            exEl.querySelectorAll('.equip-btn').forEach(btn => {
                btn.onclick = () => { current.exercises[+btn.dataset.ei].equip = btn.dataset.eq; renderForm(); };
            });
            exEl.querySelectorAll('.notes-input').forEach(inp => {
                inp.oninput = () => { current.exercises[+inp.dataset.ei].notes = inp.value; };
            });
            // Collapse/expand knop handler
            exEl.querySelectorAll('.collapse-btn').forEach(btn => {
                btn.onclick = () => {
                    const ei = +btn.dataset.ei;
                    current.exercises[ei].collapsed = !current.exercises[ei].collapsed;
                    renderForm();
                };
            });

            // Update collapse-all knop
            updateCollapseAllBtn();
            updateSave();
        }

        function updateCollapseAllBtn() {
            if (!current) { collapseAllRow.style.display = 'none'; return; }
            // Toon knop als er oefeningen zijn (behalve overgeslagen)
            const collapsableExercises = current.exercises.filter(ex => !ex.skipped);
            if (collapsableExercises.length === 0) {
                collapseAllRow.style.display = 'none';
                return;
            }
            collapseAllRow.style.display = 'flex';
            const allCollapsed = collapsableExercises.every(ex => ex.collapsed);
            collapseAllBtn.textContent = allCollapsed ? '‚ñ∂ Alles uitklappen' : '‚ñº Alles inklappen';
        }

        collapseAllBtn.onclick = () => {
            if (!current) return;
            const collapsableExercises = current.exercises.filter(ex => !ex.skipped);
            const allCollapsed = collapsableExercises.every(ex => ex.collapsed);
            // Toggle: als alles ingeklapt is, klap uit. Anders klap in.
            globalCollapsed = !allCollapsed; // Onthoudt voor nieuwe dagen
            current.exercises.forEach(ex => {
                if (!ex.skipped) ex.collapsed = globalCollapsed;
            });
            renderForm();
        };

        // Add cardio to training
        $('add-cardio-btn').onclick = () => {
            if (!current) return;
            trainingCardio.push({
                id: Date.now(),
                type: 'running',
                duration: ''
            });
            renderTrainingCardio();
            updateSave();
        };

        function renderTrainingCardio() {
            const el = $('training-cardio');
            if (!trainingCardio.length) { el.innerHTML = ''; return; }

            el.innerHTML = trainingCardio.map((c, ci) => {
                const type = CARDIO_TYPES[c.type];
                return `
                <div class="training-cardio-card">
                    <div class="training-cardio-head">
                        <span class="training-cardio-title">üèÉ Cardio</span>
                        <button class="training-cardio-remove" data-ci="${ci}">‚úï Verwijder</button>
                    </div>
                    <div class="cardio-types" style="margin-bottom:0.75rem;">
                        ${Object.values(CARDIO_TYPES).map(t => `
                            <button class="cardio-btn ${c.type === t.id ? 'active' : ''}" data-ci="${ci}" data-ctype="${t.id}">
                                <span>${t.icon}</span>${t.name}
                            </button>
                        `).join('')}
                    </div>
                    <div class="cardio-field">
                        <label>Duur (min)</label>
                        <input type="text" inputmode="numeric" class="tc-duration" data-ci="${ci}" value="${c.duration}" placeholder="30">
                    </div>
                </div>`;
            }).join('');

            // Event listeners
            el.querySelectorAll('.training-cardio-remove').forEach(btn => {
                btn.onclick = () => {
                    trainingCardio.splice(+btn.dataset.ci, 1);
                    renderTrainingCardio();
                    updateSave();
                };
            });
            el.querySelectorAll('.cardio-btn').forEach(btn => {
                btn.onclick = () => {
                    trainingCardio[+btn.dataset.ci].type = btn.dataset.ctype;
                    renderTrainingCardio();
                };
            });
            el.querySelectorAll('.tc-duration').forEach(inp => {
                inp.oninput = () => { trainingCardio[+inp.dataset.ci].duration = inp.value; updateSave(); };
            });
        }

        function updateSave() {
            if (currentMode === 'cardio') {
                // Cardio mode: need type selected and duration filled
                saveBtn.disabled = !selectedCardioType || !cardioData?.duration;
                saveBtn.textContent = 'Cardio Opslaan';
                return;
            }
            // Lifting mode
            saveBtn.textContent = 'Training Opslaan';
            if (!current) { saveBtn.disabled = true; return; }
            const hasData = current.exercises.some(ex => {
                if (ex.skipped) return true;
                if (ex.type === 'check') return ex.done;
                return ex.setsData?.some(s => s.w || s.t);
            });
            saveBtn.disabled = !hasData;
        }

        // Save
        saveBtn.onclick = () => {
            if (!isValidDate(dateInput.value)) { showToast('Ongeldige datum'); return; }
            if (!isValidTime(timeInput.value)) { showToast('Ongeldige tijd'); return; }

            if (currentMode === 'cardio') {
                // Save cardio session
                if (!selectedCardioType || !cardioData?.duration) return;
                const type = CARDIO_TYPES[selectedCardioType];
                const session = {
                    id: Date.now(),
                    date: toISODate(dateInput.value),
                    startTime: toISOTimestamp(dateInput.value, timeInput.value),
                    isCardio: true,
                    cardioType: selectedCardioType,
                    cardioName: type.name,
                    cardioIcon: type.icon,
                    duration: +cardioData.duration || 0,
                    notes: cardioData.notes || ''
                };
                data.unshift(session);
                save();
                showToast('Cardio opgeslagen!');
                // Reset
                document.querySelectorAll('.cardio-btn').forEach(b => b.classList.remove('active'));
                selectedCardioType = null; cardioData = null;
                $('cardio-form-container').innerHTML = '';
                saveBtn.disabled = true;
                return;
            }

            // Save lifting session
            if (!current) return;
            const training = {
                id: Date.now(),
                date: toISODate(dateInput.value),
                startTime: toISOTimestamp(dateInput.value, timeInput.value),
                day: current.day,
                lift: current.lift,
                week: +$('week-num').textContent,
                exercises: current.exercises.map(ex => {
                    if (ex.type === 'check') return { id: ex.id, name: ex.name, type: 'check', done: ex.done, skipped: ex.skipped, notes: ex.notes };
                    const result = {
                        id: ex.id,
                        name: ex.name,
                        type: ex.type,
                        sets: ex.skipped ? [] : ex.setsData.filter(s => s.w || s.t).map(s => ex.type === 'timed' ? {w:s.w,t:s.t} : {w:s.w,r:s.r,warmup:s.warmup}),
                        skipped: ex.skipped,
                        notes: ex.notes
                    };
                    if (ex.equip) result.equip = ex.equip;
                    return result;
                }).filter(ex => ex.skipped || (ex.type === 'check' ? ex.done : ex.sets?.length))
            };
            // Add cardio if present
            if (trainingCardio.length) {
                training.cardio = trainingCardio.filter(c => c.duration).map(c => ({
                    type: c.type,
                    name: CARDIO_TYPES[c.type].name,
                    icon: CARDIO_TYPES[c.type].icon,
                    duration: +c.duration
                }));
            }
            data.unshift(training);
            save();
            showToast('Opgeslagen!');
            updateWeekSelect();
            updateDayButtons();
            document.querySelectorAll('.day-btn').forEach(b => b.classList.remove('active'));
            selectedDay = null; current = null; exEl.innerHTML = ''; saveBtn.disabled = true;
            trainingCardio = []; $('training-cardio').innerHTML = ''; $('add-cardio-btn').style.display = 'none';
        };

        // History
        function renderHistory() {
            const el = $('history');
            if (!data.length) { el.innerHTML = '<div class="empty">Nog geen trainingen</div>'; return; }
            el.innerHTML = data.map((t, i) => {
                const healthBadge = t.health ? ' <span style="color:var(--accent)">‚ù§Ô∏è</span>' : '';

                // Cardio session
                if (t.isCardio) {
                    let summary = `${t.duration} min`;
                    if (t.health?.totalCal) summary += ` ¬∑ ${Math.round(t.health.totalCal)} kcal`;
                    return `<div class="hist-card" data-idx="${i}"><div class="hist-top"><span class="hist-date">${fmtDate(t.date)}${healthBadge}</span><span class="hist-day" style="background:rgba(245,158,11,0.2);color:var(--accent);">Cardio</span></div><div class="hist-lift">${t.cardioIcon} ${t.cardioName}</div><div class="hist-summary">${summary}</div></div>`;
                }

                // Lifting session
                const main = t.exercises?.find(e => ['Back Squat','Bench Press','Conventional Deadlift','Push Press'].includes(e.name));
                let top = '-';
                if (main?.sets && main.sets.length) {
                    const ws = main.sets.filter(s => !s.warmup);
                    const last = ws[ws.length-1];
                    if (last) top = last.w + 'kg' + (last.r ? ' x '+last.r : '');
                }
                const cardioBadge = t.cardio?.length ? ' üèÉ' : '';
                return `<div class="hist-card" data-idx="${i}"><div class="hist-top"><span class="hist-date">${fmtDate(t.date)}${healthBadge}${cardioBadge}</span><span class="hist-day ${t.day}">Dag ${t.day}</span></div><div class="hist-lift">${t.lift}</div><div class="hist-summary">Topset: ${top}</div></div>`;
            }).join('');
            el.querySelectorAll('.hist-card').forEach(c => { c.onclick = () => openModal(+c.dataset.idx); });
        }

        // Modal
        function openModal(idx) {
            editIdx = idx;
            editData = JSON.parse(JSON.stringify(data[idx]));

            if (editData.isCardio) {
                // Cardio modal
                $('modal-title').textContent = editData.cardioIcon + ' ' + editData.cardioName;
                let dateInfo = fmtDate(editData.date);
                if (editData.health) {
                    const h = editData.health;
                    const parts = [];
                    if (h.avgHr) parts.push(`‚ù§Ô∏è ${Math.round(h.avgHr)} bpm`);
                    if (h.totalCal) parts.push(`üî• ${Math.round(h.totalCal)} kcal`);
                    if (parts.length) dateInfo += '<br><span style="color:var(--accent)">' + parts.join(' ¬∑ ') + '</span>';
                }
                $('modal-date').innerHTML = dateInfo;
                renderCardioModal();
            } else {
                // Lifting modal
                $('modal-title').textContent = editData.lift + ' ‚Äî Dag ' + editData.day;
                let dateInfo = fmtDate(editData.date) + ' | Week ' + editData.week;
                if (editData.health) {
                    const h = editData.health;
                    const parts = [];
                    if (h.avgHr) parts.push(`‚ù§Ô∏è ${Math.round(h.avgHr)} bpm`);
                    if (h.totalCal) parts.push(`üî• ${Math.round(h.totalCal)} kcal`);
                    if (h.duration) parts.push(`‚è±Ô∏è ${Math.round(h.duration)} min`);
                    if (parts.length) dateInfo += '<br><span style="color:var(--accent)">' + parts.join(' ¬∑ ') + '</span>';
                }
                $('modal-date').innerHTML = dateInfo;
                renderModal();
            }
            modal.classList.add('show');
        }

        function renderCardioModal() {
            let html = '<div class="cardio-form">';
            html += `<div class="cardio-field" style="margin-bottom:0.75rem;"><label>Duur</label><div style="font-size:1.5rem;font-weight:600;">${editData.duration} min</div></div>`;
            if (editData.health) {
                const h = editData.health;
                html += '<div class="cardio-row">';
                if (h.totalCal) html += `<div class="cardio-field"><label>Calorie√´n</label><div style="font-size:1.25rem;font-weight:600;color:var(--accent);">${Math.round(h.totalCal)} kcal</div></div>`;
                if (h.avgHr) html += `<div class="cardio-field"><label>Gem. hartslag</label><div style="font-size:1.25rem;font-weight:600;color:var(--danger);">${Math.round(h.avgHr)} bpm</div></div>`;
                html += '</div>';
            }
            if (editData.notes) {
                html += `<div class="cardio-field"><label>Notities</label><div style="font-size:0.875rem;color:var(--text2);font-style:italic;">${editData.notes}</div></div>`;
            }
            html += '</div>';
            modalBody.innerHTML = html;
        }

        function renderModal() {
            let html = '';
            editData.exercises.forEach((ex, ei) => {
                const cardClass = ex.skipped ? 'skipped' : '';
                html += `<div class="ex-card ${cardClass}"><div class="ex-head"><span class="ex-name">${ex.name}</span>${ex.equip ? `<span class="ex-rx">${ex.equip}</span>` : ''}</div>`;
                if (ex.skipped) {
                    html += `<div style="color:var(--skip);font-size:0.75rem;">‚è≠Ô∏è Overgeslagen</div>`;
                } else if (ex.type === 'check') {
                    html += `<div class="check-row"><button class="check-btn ${ex.done?'checked':''}" data-mei="${ei}">${ex.done?'‚úì':''}</button><span>${ex.done?'Gedaan':'Niet gedaan'}</span></div>`;
                } else if (ex.sets && ex.sets.length) {
                    ex.sets.forEach((s, si) => {
                        if (ex.type === 'timed') {
                            html += `<div class="set-row"><span class="set-num">${si+1}:</span><input type="text" inputmode="decimal" class="set-input" data-mei="${ei}" data-msi="${si}" data-mf="w" value="${s.w||''}"><span class="set-unit">kg</span><input type="text" inputmode="numeric" class="set-input" data-mei="${ei}" data-msi="${si}" data-mf="t" value="${s.t||''}"><span class="set-unit">sec</span></div>`;
                        } else {
                            html += `<div class="set-row"><span class="set-num">${si+1}:</span><input type="text" inputmode="decimal" class="set-input ${s.warmup?'warmup':''}" data-mei="${ei}" data-msi="${si}" data-mf="w" value="${s.w||''}"><span class="set-unit">kg</span><input type="text" inputmode="numeric" class="set-input ${s.warmup?'warmup':''}" data-mei="${ei}" data-msi="${si}" data-mf="r" value="${s.r||''}"><span class="set-unit">reps</span><button class="warmup-btn ${s.warmup?'active':''}" data-mei="${ei}" data-msi="${si}">w-up</button></div>`;
                        }
                    });
                }
                if (ex.notes) {
                    html += `<div style="font-size:0.75rem;color:var(--text2);margin-top:0.5rem;font-style:italic;">${ex.notes}</div>`;
                }
                html += '</div>';
            });

            // Show cardio if present in training
            if (editData.cardio?.length) {
                html += '<div style="margin-top:1rem;padding-top:1rem;border-top:1px solid var(--border);">';
                html += '<div style="font-weight:600;color:var(--accent);margin-bottom:0.5rem;">üèÉ Cardio</div>';
                editData.cardio.forEach(c => {
                    html += `<div style="background:var(--bg3);padding:0.5rem;border-radius:0.375rem;margin-bottom:0.5rem;">`;
                    html += `<span style="font-weight:600;">${c.icon} ${c.name}</span> ¬∑ ${c.duration} min`;
                    html += '</div>';
                });
                html += '</div>';
            }

            modalBody.innerHTML = html;
            
            modalBody.querySelectorAll('.set-input').forEach(inp => {
                inp.oninput = () => { 
                    // Only allow numbers, decimal point, and BW
                    let val = inp.value.toUpperCase();
                    if (val !== 'BW' && val !== 'B') {
                        val = val.replace(/[^0-9.,]/g, '').replace(',', '.');
                    }
                    inp.value = val;
                    editData.exercises[+inp.dataset.mei].sets[+inp.dataset.msi][inp.dataset.mf] = val; 
                };
                inp.onfocus = () => inp.select();
            });
            modalBody.querySelectorAll('.check-btn').forEach(btn => {
                btn.onclick = () => { editData.exercises[+btn.dataset.mei].done = !editData.exercises[+btn.dataset.mei].done; renderModal(); };
            });
            modalBody.querySelectorAll('.warmup-btn').forEach(btn => {
                btn.onclick = () => { editData.exercises[+btn.dataset.mei].sets[+btn.dataset.msi].warmup = !editData.exercises[+btn.dataset.mei].sets[+btn.dataset.msi].warmup; renderModal(); };
            });
        }

        function closeModal() { modal.classList.remove('show'); editIdx = null; editData = null; }
        $('modal-close').onclick = closeModal;
        $('btn-cancel').onclick = closeModal;
        $('btn-save').onclick = () => { data[editIdx] = editData; save(); showToast('Gewijzigd!'); closeModal(); renderHistory(); };
        $('btn-delete').onclick = () => {
            if (confirm('Training verwijderen?\n\n' + editData.lift + ' ‚Äî ' + fmtDate(editData.date))) {
                data.splice(editIdx, 1);
                save();
                showToast('Verwijderd!');
                closeModal();
                renderHistory();
                updateWeekSelect();
                updateDayButtons();
            }
        };
        $('btn-ics').onclick = () => {
            if (!editData) return;
            exportICS('single', editData);
        };
        modal.onclick = e => { if (e.target === modal) closeModal(); };

        // Progress
        document.querySelectorAll('.prog-btn').forEach(btn => {
            btn.onclick = () => { document.querySelectorAll('.prog-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active'); renderProgress(btn.dataset.lift); };
        });

        function renderProgress(lift = 'Back Squat') {
            const el = $('progress');
            const rows = data.filter(t => t.exercises.some(e => e.name === lift && !e.skipped)).map(t => {
                const ex = t.exercises.find(e => e.name === lift);
                const ws = ex.sets?.filter(s => !s.warmup) || [];
                const max = ws.length ? Math.max(...ws.map(s => parseFloat(s.w)||0)) : 0;
                return { date: t.date, val: max };
            }).reverse().slice(-8);
            if (!rows.length) { el.innerHTML = '<div class="empty">Geen data</div>'; return; }
            const max = Math.max(...rows.map(r => r.val));
            el.innerHTML = rows.map(r => `<div class="prog-row"><span class="prog-date">${r.date.slice(5)}</span><div class="prog-bar-bg"><div class="prog-bar" style="width:${(r.val/max)*100}%"></div></div><span class="prog-val">${r.val}</span></div>`).join('');
        }

        // Dashboard
        function renderDashboard() {
            renderDashWeek();
            renderDashNext();
            renderDashStreak();
            renderDashLifts();
        }

        function renderDashWeek() {
            const el = $('dash-week');
            const now = new Date();
            const dayOfWeek = now.getDay(); // 0 = zondag
            const monday = new Date(now);
            monday.setDate(now.getDate() - (dayOfWeek === 0 ? 6 : dayOfWeek - 1));
            monday.setHours(0,0,0,0);

            const days = ['Ma','Di','Wo','Do','Vr','Za','Zo'];
            let html = '';

            for (let i = 0; i < 7; i++) {
                const d = new Date(monday);
                d.setDate(monday.getDate() + i);
                const dateStr = d.toISOString().split('T')[0];
                const isToday = d.toDateString() === now.toDateString();
                const sessions = data.filter(t => t.date === dateStr);
                const trained = sessions.length > 0;
                let statusText = '¬∑';
                if (trained) {
                    statusText = sessions.map(s => s.isCardio ? s.cardioIcon : '‚úì' + s.day).join(' ');
                }

                html += `<div class="dash-week-day ${isToday ? 'today' : ''} ${trained ? 'trained' : ''}">
                    <div class="day-label">${days[i]}</div>
                    <div class="day-status">${statusText}</div>
                </div>`;
            }
            el.innerHTML = html;
        }

        function renderDashNext() {
            const el = $('dash-next');
            // Bepaal welke dag als volgende aan de beurt is (alleen lifting, niet cardio)
            const dayOrder = ['A', 'B', 'C', 'D'];
            const lastTraining = data.find(t => !t.isCardio);
            let nextDay = 'A';

            if (lastTraining && lastTraining.day) {
                const lastDayIdx = dayOrder.indexOf(lastTraining.day);
                nextDay = dayOrder[(lastDayIdx + 1) % 4];
            }

            const template = SLOT_TEMPLATES[nextDay];
            const lastOfThisDay = data.find(t => t.day === nextDay);

            let topset = '-';
            if (lastOfThisDay) {
                const mainLift = lastOfThisDay.exercises.find(e => e.name === template.name || EXERCISES[template.mainLift]?.name === e.name);
                if (mainLift?.sets) {
                    const ws = mainLift.sets.filter(s => !s.warmup);
                    const last = ws[ws.length - 1];
                    if (last) topset = last.w + 'kg √ó ' + last.r;
                }
            }

            el.innerHTML = `
                <div class="dash-next-main">Dag ${nextDay} ‚Äî ${template.name}</div>
                <div class="dash-next-sub">
                    ${lastOfThisDay ? `Laatste: ${fmtDate(lastOfThisDay.date)} | Topset: ${topset}` : 'Nog niet gedaan'}
                </div>
                <button class="dash-next-btn" onclick="document.querySelector('[data-day=${nextDay}]').click(); document.querySelector('[data-screen=new]').click();">
                    Start training ‚Üí
                </button>
            `;
        }

        function renderDashStreak() {
            const el = $('dash-streak');
            // Bereken hoeveel weken er achter elkaar getraind is (minstens 1 training per week)
            const weeks = {};
            data.forEach(t => {
                const d = new Date(t.date);
                const weekStart = new Date(d);
                weekStart.setDate(d.getDate() - d.getDay() + 1);
                const weekKey = weekStart.toISOString().split('T')[0];
                weeks[weekKey] = true;
            });

            // Tel streak vanaf nu terug
            let streak = 0;
            const now = new Date();
            const currentWeekStart = new Date(now);
            currentWeekStart.setDate(now.getDate() - (now.getDay() === 0 ? 6 : now.getDay() - 1));
            currentWeekStart.setHours(0,0,0,0);

            for (let i = 0; i < 52; i++) {
                const weekCheck = new Date(currentWeekStart);
                weekCheck.setDate(currentWeekStart.getDate() - (i * 7));
                const weekKey = weekCheck.toISOString().split('T')[0];
                if (weeks[weekKey]) {
                    streak++;
                } else if (i > 0) {
                    break; // Alleen stoppen als het niet de huidige week is
                }
            }

            const goal = 12;
            const pct = Math.min(100, (streak / goal) * 100);

            el.innerHTML = `
                <div class="dash-streak-bar">
                    <div class="dash-streak-fill" style="width: ${pct}%"></div>
                </div>
                <div class="dash-streak-text"><strong>${streak}</strong> van ${goal} weken consistent</div>
            `;
        }

        function renderDashLifts() {
            const el = $('dash-lifts');
            const mainLifts = [
                { name: 'Back Squat', label: 'Squat' },
                { name: 'Bench Press', label: 'Bench' },
                { name: 'Conventional Deadlift', label: 'Deadlift' },
                { name: 'Push Press', label: 'Press' }
            ];

            let html = '';
            mainLifts.forEach(lift => {
                // Haal laatste 4 topsets op
                const trainings = data.filter(t => t.exercises.some(e => e.name === lift.name && !e.skipped));
                const vals = trainings.slice(0, 4).map(t => {
                    const ex = t.exercises.find(e => e.name === lift.name);
                    const ws = ex.sets?.filter(s => !s.warmup) || [];
                    return ws.length ? Math.max(...ws.map(s => parseFloat(s.w) || 0)) : 0;
                }).reverse();

                // Bepaal trend
                let trend = 'same';
                let trendIcon = '‚Üí';
                if (vals.length >= 2) {
                    const last = vals[vals.length - 1];
                    const prev = vals[vals.length - 2];
                    if (last > prev) { trend = 'up'; trendIcon = '‚Üë'; }
                    else if (last < prev) { trend = 'down'; trendIcon = '‚Üì'; }
                }

                html += `<div class="dash-lift-row">
                    <span class="dash-lift-name">${lift.label}</span>
                    <div class="dash-lift-vals">
                        ${vals.length ? vals.map((v, i) => `<span class="dash-lift-val ${i === vals.length - 1 ? 'latest' : ''}">${v}</span>`).join('') : '<span class="dash-lift-val">-</span>'}
                    </div>
                    <span class="dash-lift-trend ${trend}">${trendIcon}</span>
                </div>`;
            });

            el.innerHTML = html;
        }

        // Exercises Browser
        let exerciseFilter = 'all';
        let exerciseSearch = '';

        function renderExercises() {
            const grid = $('ex-grid');
            const countEl = $('ex-count');

            // Filter en zoek
            let exercises = Object.values(EXERCISES);

            if (exerciseFilter !== 'all') {
                exercises = exercises.filter(ex => ex.pattern === exerciseFilter);
            }

            if (exerciseSearch) {
                const search = exerciseSearch.toLowerCase();
                exercises = exercises.filter(ex =>
                    ex.name.toLowerCase().includes(search) ||
                    ex.pattern.toLowerCase().includes(search) ||
                    ex.hint?.toLowerCase().includes(search) ||
                    ex.muscles?.primary?.some(m => m.toLowerCase().includes(search))
                );
            }

            // Sorteer alfabetisch
            exercises.sort((a, b) => a.name.localeCompare(b.name));

            countEl.textContent = `${exercises.length} oefeningen`;

            // Pattern labels
            const patternLabels = {
                squat: 'Squat',
                hinge: 'Hinge',
                push_horizontal: 'Push H',
                push_vertical: 'Push V',
                pull_horizontal: 'Pull H',
                pull_vertical: 'Pull V',
                carry: 'Carry',
                activation: 'Activatie',
                isolation: 'Isolatie'
            };

            // Equipment labels
            const equipLabels = {
                barbell: 'BB',
                dumbbell: 'DB',
                kettlebell: 'KB',
                cable: 'Kabel',
                machine: 'Machine',
                bodyweight: 'BW',
                band: 'Band'
            };

            let html = '';
            exercises.forEach(ex => {
                const ytLink = ex.yt ? `https://youtube.com/watch?v=${ex.yt}` : '#';
                const patternLabel = patternLabels[ex.pattern] || ex.pattern;
                const equipTags = ex.equipment?.map(e => `<span class="ex-tile-tag equipment">${equipLabels[e] || e}</span>`).join('') || '';
                const muscleTags = ex.muscles?.primary?.slice(0, 2).map(m => `<span class="ex-tile-tag muscle">${m}</span>`).join('') || '';
                const unilateralTag = ex.unilateral ? '<span class="ex-tile-tag unilateral">Unilateral</span>' : '';
                const mainLiftTag = ex.isMainLift ? '<span class="ex-tile-tag pattern">‚≠ê Main Lift</span>' : '';

                html += `
                <div class="ex-tile">
                    <a href="${ytLink}" target="_blank" class="ex-tile-yt" ${!ex.yt ? 'style="background:#333;pointer-events:none"' : ''}>‚ñ∂</a>
                    <div class="ex-tile-info">
                        <div class="ex-tile-name">${ex.name}</div>
                        <div class="ex-tile-meta">
                            <span class="ex-tile-tag pattern">${patternLabel}</span>
                            ${mainLiftTag}
                            ${equipTags}
                            ${muscleTags}
                            ${unilateralTag}
                        </div>
                        ${ex.hint ? `<div class="ex-tile-hint">${ex.hint}</div>` : ''}
                    </div>
                </div>`;
            });

            grid.innerHTML = html || '<div class="empty">Geen oefeningen gevonden</div>';
        }

        // Exercises filter handlers
        document.querySelectorAll('.ex-filter').forEach(btn => {
            btn.onclick = () => {
                document.querySelectorAll('.ex-filter').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                exerciseFilter = btn.dataset.pattern;
                renderExercises();
            };
        });

        // Exercises search handler
        $('ex-search').oninput = (e) => {
            exerciseSearch = e.target.value;
            renderExercises();
        };

        // ICS Calendar Export
        function generateICS(trainings) {
            if (!trainings.length) return null;

            let ics = `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//LiftLog//Training//NL
CALSCALE:GREGORIAN
METHOD:PUBLISH
X-WR-CALNAME:LiftLog Trainingen
`;

            trainings.forEach(t => {
                const dateClean = t.date.replace(/-/g, '');
                const uid = `liftlog-${dateClean}-${t.day}@petermrman`;

                // Bouw beschrijving
                let desc = `Week ${t.week} | RPE 6-7\\n\\nOefeningen:\\n`;
                t.exercises.forEach(ex => {
                    if (ex.skipped) {
                        desc += `- ${ex.name}: overgeslagen\\n`;
                    } else if (ex.type === 'check') {
                        desc += `- ${ex.name}: ${ex.done ? '‚úì' : '‚óã'}\\n`;
                    } else if (ex.sets && ex.sets.length) {
                        const setsStr = ex.sets
                            .filter(s => !s.warmup)
                            .map(s => ex.type === 'timed' ? `${s.w}√ó${s.t}s` : `${s.w}√ó${s.r}`)
                            .join(', ');
                        desc += `- ${ex.name}: ${setsStr}\\n`;
                    }
                });

                // Escape special characters voor ICS
                desc = desc.replace(/,/g, '\\,').replace(/;/g, '\\;');

                ics += `BEGIN:VEVENT
UID:${uid}
DTSTART:${dateClean}T100000
DTEND:${dateClean}T110000
SUMMARY:üí™ Dag ${t.day} - ${t.lift}
DESCRIPTION:${desc}
STATUS:CONFIRMED
END:VEVENT
`;
            });

            ics += 'END:VCALENDAR';
            return ics;
        }

        function exportICS(filter, singleTraining) {
            let trainings;
            const now = new Date();

            if (filter === 'single' && singleTraining) {
                trainings = [singleTraining];
            } else {
                trainings = [...data];
                if (filter === 'week') {
                    const weekStart = new Date(now);
                    weekStart.setDate(now.getDate() - (now.getDay() === 0 ? 6 : now.getDay() - 1));
                    weekStart.setHours(0,0,0,0);
                    const weekEnd = new Date(weekStart);
                    weekEnd.setDate(weekStart.getDate() + 7);
                    trainings = trainings.filter(t => {
                        const d = new Date(t.date);
                        return d >= weekStart && d < weekEnd;
                    });
                } else if (filter === 'month') {
                    const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
                    const monthEnd = new Date(now.getFullYear(), now.getMonth() + 1, 0);
                    trainings = trainings.filter(t => {
                        const d = new Date(t.date);
                        return d >= monthStart && d <= monthEnd;
                    });
                }
            }

            if (!trainings.length) {
                showToast('Geen trainingen gevonden');
                return;
            }

            const ics = generateICS(trainings);
            const blob = new Blob([ics], { type: 'text/calendar;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filter === 'single' && singleTraining
                ? `liftlog_${singleTraining.date}_dag${singleTraining.day}.ics`
                : `liftlog_${filter || 'all'}_${now.toISOString().split('T')[0]}.ics`;
            a.click();
            URL.revokeObjectURL(url);
            showToast('Kalender ge√´xporteerd!');
        }

        // ICS Export button handlers
        $('ics-export-all').onclick = () => exportICS('all');
        $('ics-export-month').onclick = () => exportICS('month');
        $('ics-export-week').onclick = () => exportICS('week');

        // Apple Health CSV Import - Drop zone
        const dropZone = $('health-drop-zone');

        function handleHealthFile(file) {
            if (!file || !file.name.endsWith('.csv')) {
                $('health-import-result').innerHTML = '<span style="color:var(--danger)">Selecteer een CSV bestand</span>';
                return;
            }
            const reader = new FileReader();
            reader.onload = ev => {
                try {
                    const result = parseHealthCSV(ev.target.result);
                    $('health-import-result').innerHTML = result.html;
                    if (result.matched > 0) {
                        save();
                        showToast(`${result.matched} training(en) gekoppeld!`);
                    }
                } catch(err) {
                    console.error(err);
                    $('health-import-result').innerHTML = `<span style="color:var(--danger)">Fout: ${err.message}</span>`;
                }
            };
            reader.readAsText(file);
        }

        // Click to select
        dropZone.onclick = () => $('health-file-input').click();
        $('health-file-input').onchange = e => {
            handleHealthFile(e.target.files[0]);
            e.target.value = '';
        };

        // Drag and drop
        dropZone.ondragover = e => { e.preventDefault(); dropZone.classList.add('drag-over'); };
        dropZone.ondragleave = e => { e.preventDefault(); dropZone.classList.remove('drag-over'); };
        dropZone.ondrop = e => {
            e.preventDefault();
            dropZone.classList.remove('drag-over');
            const file = e.dataTransfer.files[0];
            handleHealthFile(file);
        };

        function parseHealthCSV(csvText) {
            const lines = csvText.split('\n').filter(l => l.trim());
            if (lines.length < 2) throw new Error('Leeg bestand');

            // Parse header to find column indices
            const header = lines[0].toLowerCase();
            const cols = header.split(',').map(c => c.trim().replace(/"/g, ''));

            // Find relevant columns (flexible matching)
            const findCol = (...names) => cols.findIndex(c => names.some(n => c.includes(n)));
            const dateCol = findCol('date', 'datum', 'start');
            const typeCol = findCol('type', 'workout', 'activity');
            const durationCol = findCol('duration', 'duur');
            const activeCalCol = findCol('active energy', 'active cal', 'actieve');
            const totalCalCol = findCol('total energy', 'total cal', 'totale');
            const avgHrCol = findCol('avg heart', 'average heart', 'gem hartslag', 'avg hr');
            const maxHrCol = findCol('max heart', 'maximum heart', 'max hartslag', 'max hr');

            if (dateCol === -1) throw new Error('Geen datum kolom gevonden');

            // Parse workouts
            const workouts = [];
            for (let i = 1; i < lines.length; i++) {
                const values = parseCSVLine(lines[i]);
                if (values.length <= dateCol) continue;

                const dateStr = values[dateCol];
                const workoutDate = parseHealthDate(dateStr);
                if (!workoutDate) continue;

                // Only strength training workouts
                const type = typeCol >= 0 ? values[typeCol]?.toLowerCase() || '' : '';
                if (type && !type.includes('strength') && !type.includes('training') && !type.includes('weight')) continue;

                workouts.push({
                    date: workoutDate,
                    type: values[typeCol] || 'Workout',
                    duration: durationCol >= 0 ? parseFloat(values[durationCol]) || 0 : 0,
                    activeCal: activeCalCol >= 0 ? parseFloat(values[activeCalCol]) || 0 : 0,
                    totalCal: totalCalCol >= 0 ? parseFloat(values[totalCalCol]) || 0 : 0,
                    avgHr: avgHrCol >= 0 ? parseFloat(values[avgHrCol]) || 0 : 0,
                    maxHr: maxHrCol >= 0 ? parseFloat(values[maxHrCol]) || 0 : 0
                });
            }

            if (workouts.length === 0) throw new Error('Geen workouts gevonden in CSV');

            // Match with trainings (¬±60 min buffer)
            const BUFFER_MS = 60 * 60 * 1000; // 60 minutes
            let matched = 0;
            let html = '';

            workouts.forEach(workout => {
                const match = data.find(t => {
                    if (!t.startTime) return false;
                    const trainingTime = new Date(t.startTime).getTime();
                    const workoutTime = workout.date.getTime();
                    return Math.abs(trainingTime - workoutTime) <= BUFFER_MS;
                });

                if (match) {
                    // Add health data to training
                    match.health = {
                        duration: workout.duration,
                        activeCal: workout.activeCal,
                        totalCal: workout.totalCal,
                        avgHr: workout.avgHr,
                        maxHr: workout.maxHr
                    };
                    matched++;
                    html += `<div style="color:var(--success)">‚úì ${fmtDate(match.date)} ${match.lift} gekoppeld</div>`;
                } else {
                    const d = workout.date;
                    html += `<div style="color:var(--text3)">‚óã ${d.getDate()}-${d.getMonth()+1} ${d.getHours()}:${String(d.getMinutes()).padStart(2,'0')} - geen match</div>`;
                }
            });

            html = `<div style="margin-bottom:0.5rem"><strong>${matched}/${workouts.length}</strong> workouts gekoppeld</div>` + html;
            return { matched, html };
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') inQuotes = !inQuotes;
                else if (char === ',' && !inQuotes) { result.push(current.trim()); current = ''; }
                else current += char;
            }
            result.push(current.trim());
            return result;
        }

        function parseHealthDate(dateStr) {
            if (!dateStr) return null;
            // Try various formats
            // ISO: 2025-12-30T14:30:00
            // US: 12/30/2025 2:30 PM
            // EU: 30-12-2025 14:30
            let d = new Date(dateStr);
            if (!isNaN(d.getTime())) return d;

            // Try DD-MM-YYYY HH:MM or DD/MM/YYYY HH:MM
            const match = dateStr.match(/(\d{1,2})[-\/](\d{1,2})[-\/](\d{4})\s*(\d{1,2}):(\d{2})/);
            if (match) {
                const [, day, month, year, hour, min] = match;
                return new Date(year, month - 1, day, hour, min);
            }
            return null;
        }

        // Export
        function updateWeekSelect() {
            const weeks = [...new Set(data.map(t => t.week))].sort((a,b) => a-b);
            $('week-select').innerHTML = '<option value="all">Alle weken</option>' + weeks.map(w => `<option value="${w}">Week ${w}</option>`).join('');
        }
        updateWeekSelect();

        $('export-btn').onclick = () => {
            if (!data.length) { showToast('Geen data'); return; }
            const wk = $('week-select').value;
            const exp = wk === 'all' ? data : data.filter(t => t.week == wk);
            if (!exp.length) { showToast('Geen data'); return; }
            let csv = 'Datum,Dag,Lift,Week,Oefening,Type,Set,Gewicht,Reps,Tijd,Warmup,Equipment,Skipped,Notes\n';
            exp.forEach(t => {
                t.exercises.forEach(ex => {
                    if (ex.type === 'check') csv += `${t.date},${t.day},${t.lift},${t.week},${ex.name},check,,,,,,${ex.skipped||false},"${(ex.notes||'').replace(/"/g,'""')}"\n`;
                    else if (ex.skipped) csv += `${t.date},${t.day},${t.lift},${t.week},${ex.name},${ex.type},,,,,,true,"${(ex.notes||'').replace(/"/g,'""')}"\n`;
                    else ex.sets?.forEach((s,i) => { csv += `${t.date},${t.day},${t.lift},${t.week},${ex.name},${ex.type},${i+1},${s.w||''},${s.r||''},${s.t||''},${s.warmup?'ja':'nee'},${ex.equip||''},false,"${(ex.notes||'').replace(/"/g,'""')}"\n`; });
                });
            });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(new Blob([csv], {type:'text/csv'}));
            a.download = `liftlog_${wk==='all'?'all':'week'+wk}_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            showToast('Ge√´xporteerd!');
        };

        // Import
        $('import-btn').onclick = () => $('file-input').click();
        $('file-input').onchange = e => {
            const file = e.target.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = ev => {
                try {
                    const lines = ev.target.result.split('\n').filter(l => l.trim());
                    if (lines.length < 2) { showToast('Leeg'); return; }
                    const imp = {};
                    for (let i = 1; i < lines.length; i++) {
                        const parts = lines[i].match(/(".*?"|[^,]+)/g) || [];
                        const [date,day,lift,week,exName,type,setNum,w,r,t,warmup,equip,skipped,notes] = parts.map(p => p.replace(/^"|"$/g, '').replace(/""/g, '"'));
                        const key = date+'_'+day;
                        if (!imp[key]) imp[key] = {id:Date.now()+i,date,day,lift,week:+week||1,exercises:[]};
                        let ex = imp[key].exercises.find(e => e.name === exName);
                        if (!ex) { ex = {name:exName,type,sets:[],done:false,skipped:skipped==='true',notes:notes||''}; if (equip) ex.equip = equip; imp[key].exercises.push(ex); }
                        if (type === 'check') ex.done = warmup==='true'||warmup==='ja';
                        else if (setNum && skipped !== 'true') ex.sets.push({w:w||'',r:r||'',t:t||'',warmup:warmup==='ja'});
                    }
                    const arr = Object.values(imp).sort((a,b) => new Date(b.date)-new Date(a.date));
                    if (!arr.length) { showToast('Geen data'); return; }
                    if (confirm(`${arr.length} trainingen.\n\nOK = Toevoegen\nAnnuleren = Vervangen`)) {
                        const keys = new Set(data.map(t => t.date+'_'+t.day));
                        data = [...data, ...arr.filter(t => !keys.has(t.date+'_'+t.day))].sort((a,b) => new Date(b.date)-new Date(a.date));
                    } else data = arr;
                    save(); showToast('Ge√Ømporteerd!'); updateWeekSelect(); updateDayButtons(); renderHistory();
                } catch(err) { console.error(err); showToast('Fout'); }
            };
            reader.readAsText(file);
            e.target.value = '';
        };

        // Reset optie (double-tap logo)
        let logoTaps = 0;
        document.querySelector('.logo').onclick = () => {
            logoTaps++;
            setTimeout(() => logoTaps = 0, 500);
            if (logoTaps >= 3) {
                if (confirm('LocalStorage resetten? Dit verwijdert alle trainingsdata!')) {
                    localStorage.removeItem('liftlog3');
                    location.reload();
                }
            }
        };

        // Init
        renderHistory();
    })();
    </script>
</body>
</html>
