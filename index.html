<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="LiftLog">
    <meta name="theme-color" content="#0a0a0a">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%230a0a0a' width='100' height='100' rx='20'/><text x='50' y='68' font-family='system-ui,sans-serif' font-size='48' font-weight='700' fill='%23f59e0b' text-anchor='middle'>LL</text></svg>">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%230a0a0a' width='100' height='100' rx='20'/><text x='50' y='68' font-family='system-ui,sans-serif' font-size='48' font-weight='700' fill='%23f59e0b' text-anchor='middle'>LL</text></svg>">
    <title>LiftLog</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        :root {
            --bg: #0a0a0a; --bg2: #141414; --bg3: #1e1e1e;
            --text: #f5f5f5; --text2: #a0a0a0; --text3: #606060;
            --border: #2a2a2a; --accent: #f59e0b; --success: #22c55e; --danger: #ef4444;
            --blue: #3b82f6; --red: #ef4444; --green: #22c55e; --purple: #a855f7;
            --skip: #6b7280;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; }
        
        /* Header */
        .header { position: sticky; top: 0; z-index: 100; background: var(--bg); border-bottom: 1px solid var(--border); padding: 1rem; }
        .header-content { display: flex; justify-content: space-between; align-items: center; max-width: 500px; margin: 0 auto; }
        .logo { font-size: 1.25rem; font-weight: 700; }
        .logo span { color: var(--accent); }
        .nav { display: flex; gap: 0.25rem; background: var(--bg2); padding: 0.25rem; border-radius: 0.5rem; }
        .nav button { padding: 0.5rem 0.75rem; border: none; background: transparent; color: var(--text2); font-size: 0.875rem; border-radius: 0.375rem; cursor: pointer; }
        .nav button.active { background: var(--bg3); color: var(--text); }
        
        /* Main */
        .main { max-width: 500px; margin: 0 auto; padding: 1rem; }
        .screen { display: none; }
        .screen.active { display: block; }
        
        /* Week & Day */
        .week-bar { text-align: center; padding: 0.75rem; margin-bottom: 1rem; background: var(--bg2); border-radius: 0.5rem; font-size: 0.875rem; }
        .week-bar span { color: var(--accent); font-weight: 600; }
        .days { display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.5rem; margin-bottom: 1rem; }
        .day-btn { padding: 0.75rem 0.5rem; border: 2px solid var(--border); background: var(--bg2); color: var(--text2); font-size: 0.75rem; font-weight: 600; border-radius: 0.75rem; cursor: pointer; text-align: center; }
        .day-btn span { font-size: 1.25rem; display: block; margin-bottom: 0.125rem; }
        .day-btn.active { border-color: var(--accent); color: var(--text); }
        .day-btn.has-data { border-color: var(--success); }
        
        /* Date */
        .date-row { margin-bottom: 1rem; }
        .date-row label { display: block; font-size: 0.75rem; color: var(--text2); margin-bottom: 0.375rem; }
        .date-input { width: 100%; padding: 0.75rem; background: var(--bg2); border: 1px solid var(--border); border-radius: 0.5rem; color: var(--text); font-size: 1rem; }
        .date-input.invalid { border-color: var(--danger); }
        
        /* Exercise Card */
        .ex-card { background: var(--bg2); border: 1px solid var(--border); border-radius: 0.75rem; padding: 1rem; margin-bottom: 0.75rem; }
        .ex-card.done { border-color: var(--success); }
        .ex-card.skipped { border-color: var(--skip); opacity: 0.6; }
        .ex-card.collapsed { padding: 0.75rem 1rem; }
        .ex-card.collapsed .ex-body { display: none; }
        .ex-card.collapsed .ex-head { margin-bottom: 0; }
        .ex-card.collapsed .ex-summary { display: flex; }
        .ex-head { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem; }
        .ex-summary { display: none; font-size: 0.75rem; color: var(--text2); margin-top: 0.25rem; }
        .ex-card.done .ex-summary { color: var(--success); }
        .collapse-btn { padding: 0.25rem 0.5rem; font-size: 0.625rem; background: transparent; border: 1px solid var(--border); border-radius: 0.25rem; color: var(--text3); cursor: pointer; min-width: 1.5rem; }
        .collapse-btn:hover { background: var(--bg3); }
        .ex-card.done .collapse-btn { border-color: var(--success); color: var(--success); }
        .ex-card.done .collapse-btn:hover { background: rgba(34,197,94,0.1); }
        .collapse-all-row { display: flex; justify-content: flex-end; margin-bottom: 0.5rem; }
        .collapse-all-btn { padding: 0.375rem 0.75rem; font-size: 0.75rem; background: var(--bg2); border: 1px solid var(--border); border-radius: 0.375rem; color: var(--text2); cursor: pointer; }
        .collapse-all-btn:hover { background: var(--bg3); }
        .ex-name { font-weight: 600; font-size: 0.9375rem; }
        .ex-rx { font-size: 0.75rem; color: var(--text2); background: var(--bg3); padding: 0.25rem 0.5rem; border-radius: 0.25rem; }
        .ex-hint { font-size: 0.75rem; color: var(--text3); margin-bottom: 0.5rem; }
        .ex-prev { font-size: 0.7rem; color: var(--text2); background: var(--bg3); padding: 0.375rem 0.5rem; border-radius: 0.375rem; margin-bottom: 0.75rem; }
        .ex-prev-date { color: var(--accent); font-weight: 500; }
        
        /* Skip & Swap buttons */
        .ex-btns { display: flex; gap: 0.25rem; margin-left: 0.5rem; }
        .skip-btn, .swap-btn { padding: 0.25rem 0.5rem; font-size: 0.625rem; background: transparent; border: 1px solid var(--border); border-radius: 0.25rem; color: var(--text3); cursor: pointer; }
        .yt-btn { display: inline-flex; align-items: center; justify-content: center; width: 1.25rem; height: 1.25rem; margin-left: 0.375rem; background: #ff0000; color: #fff; font-size: 0.5rem; border-radius: 0.25rem; text-decoration: none; vertical-align: middle; }
        .skip-btn.active { border-color: var(--skip); color: var(--skip); background: rgba(107,114,128,0.2); }
        .swap-btn { border-color: var(--blue); color: var(--blue); }
        .swap-menu { position: absolute; top: 100%; right: 0; background: var(--bg2); border: 1px solid var(--border); border-radius: 0.5rem; padding: 0.25rem; z-index: 50; min-width: 10rem; box-shadow: 0 4px 12px rgba(0,0,0,0.5); }
        .swap-menu button { display: block; width: 100%; padding: 0.5rem 0.75rem; border: none; background: transparent; color: var(--text); font-size: 0.75rem; text-align: left; cursor: pointer; border-radius: 0.25rem; }
        .swap-menu button:hover { background: var(--bg3); }
        .ex-head { position: relative; }

        /* Order buttons (reorder exercises) */
        .order-btns { display: flex; flex-direction: column; gap: 0.125rem; margin-right: 0.5rem; }
        .order-btn { padding: 0.125rem 0.375rem; font-size: 0.5rem; background: transparent; border: 1px solid var(--border); border-radius: 0.25rem; color: var(--text3); cursor: pointer; line-height: 1; }
        .order-btn:hover { background: var(--bg3); border-color: var(--accent); color: var(--accent); }
        .order-btn:disabled { opacity: 0.3; cursor: not-allowed; }

        /* Drag and drop */
        .ex-card[draggable="true"] { cursor: grab; }
        .ex-card.dragging { opacity: 0.4; }
        .ex-card.drag-over { border-top: 3px solid var(--accent); margin-top: -3px; }

        /* Add exercise button */
        .add-ex-btn { display: flex; align-items: center; justify-content: center; gap: 0.5rem; width: 100%; padding: 0.75rem; background: var(--bg2); border: 2px dashed var(--border); border-radius: 0.75rem; color: var(--text2); font-size: 0.875rem; cursor: pointer; margin-top: 0.5rem; }
        .add-ex-btn:hover { border-color: var(--accent); color: var(--accent); }

        /* Add exercise modal */
        .add-ex-modal { position: fixed; bottom: 0; left: 0; right: 0; background: var(--bg2); border-top: 1px solid var(--border); border-radius: 1rem 1rem 0 0; padding: 1rem; z-index: 100; max-height: 70vh; overflow-y: auto; box-shadow: 0 -4px 20px rgba(0,0,0,0.5); }
        .add-ex-modal-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .add-ex-modal-title { font-weight: 600; font-size: 1rem; }
        .add-ex-modal-close { background: none; border: none; color: var(--text2); font-size: 1.25rem; cursor: pointer; }
        .add-ex-search { width: 100%; padding: 0.75rem; background: var(--bg3); border: 1px solid var(--border); border-radius: 0.5rem; color: var(--text); font-size: 0.875rem; margin-bottom: 0.75rem; }
        .add-ex-results { max-height: 40vh; overflow-y: auto; }
        .add-ex-item { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: var(--bg3); border-radius: 0.5rem; margin-bottom: 0.5rem; cursor: pointer; }
        .add-ex-item:hover { background: var(--bg4, #3a3a3a); }
        .add-ex-item-name { font-weight: 500; }
        .add-ex-item-meta { font-size: 0.75rem; color: var(--text3); }
        .add-ex-custom { border-top: 1px solid var(--border); padding-top: 0.75rem; margin-top: 0.5rem; }
        .add-ex-custom-title { font-size: 0.75rem; color: var(--text3); margin-bottom: 0.5rem; }
        .add-ex-custom-row { display: flex; gap: 0.5rem; }
        .add-ex-custom-input { flex: 1; padding: 0.75rem; background: var(--bg3); border: 1px solid var(--border); border-radius: 0.5rem; color: var(--text); font-size: 0.875rem; }
        .add-ex-type-select { padding: 0.75rem; background: var(--bg3); border: 1px solid var(--border); border-radius: 0.5rem; color: var(--text); font-size: 0.875rem; }
        .add-ex-custom-btn { padding: 0.75rem 1rem; background: var(--accent); border: none; border-radius: 0.5rem; color: #000; font-weight: 600; cursor: pointer; }

        /* Equipment selector */
        .equip-row { display: flex; gap: 0.25rem; margin-bottom: 0.75rem; }
        .equip-btn { padding: 0.25rem 0.5rem; font-size: 0.625rem; background: var(--bg3); border: 1px solid var(--border); border-radius: 0.25rem; color: var(--text3); cursor: pointer; }
        .equip-btn.active { border-color: var(--accent); color: var(--accent); }
        
        /* Set Row */
        .set-row { display: flex; align-items: center; gap: 0.375rem; margin-bottom: 0.5rem; flex-wrap: wrap; }
        .set-num { width: 1.5rem; font-size: 0.75rem; color: var(--text3); }
        .set-input { width: 3.5rem; padding: 0.5rem 0.25rem; background: var(--bg3); border: 1px solid var(--border); border-radius: 0.375rem; color: var(--text); font-size: 0.875rem; text-align: center; }
        .set-input:focus { outline: none; border-color: var(--accent); }
        .set-input.warmup { border-style: dashed; opacity: 0.7; }
        .set-unit { font-size: 0.625rem; color: var(--text3); width: 1.5rem; }
        .warmup-btn { padding: 0.25rem 0.5rem; font-size: 0.625rem; background: transparent; border: 1px solid var(--border); border-radius: 0.25rem; color: var(--text3); cursor: pointer; }
        .warmup-btn.active { border-color: var(--accent); color: var(--accent); }
        .add-btn { width: 2.5rem; height: 2rem; border: 1px dashed var(--border); background: transparent; color: var(--text3); border-radius: 0.375rem; cursor: pointer; font-size: 1.25rem; margin-top: 0.25rem; }
        
        /* Notes */
        .notes-input { width: 100%; margin-top: 0.5rem; padding: 0.5rem; background: var(--bg3); border: 1px solid var(--border); border-radius: 0.375rem; color: var(--text); font-size: 0.75rem; resize: none; min-height: 2.5rem; }
        .notes-input::placeholder { color: var(--text3); }
        
        /* Check */
        .check-row { display: flex; align-items: center; gap: 0.75rem; }
        .check-btn { width: 2.5rem; height: 2.5rem; border: 2px solid var(--border); background: var(--bg3); border-radius: 0.5rem; cursor: pointer; font-size: 1.25rem; color: var(--text3); }
        .check-btn.checked { border-color: var(--success); background: rgba(34,197,94,0.2); color: var(--success); }
        
        /* Buttons */
        .save-btn { width: 100%; padding: 1rem; margin-top: 1rem; background: var(--accent); border: none; border-radius: 0.75rem; color: #000; font-size: 1rem; font-weight: 600; cursor: pointer; }
        .save-btn:disabled { opacity: 0.4; cursor: not-allowed; }
        .actions { display: flex; gap: 0.5rem; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border); }
        .action-btn { flex: 1; padding: 0.75rem; background: var(--bg2); border: 1px solid var(--border); border-radius: 0.5rem; color: var(--text2); font-size: 0.875rem; cursor: pointer; }
        .week-select { flex: 1; padding: 0.75rem; background: var(--bg2); border: 1px solid var(--border); border-radius: 0.5rem; color: var(--text); font-size: 0.875rem; }
        
        /* History */
        .hist-card { background: var(--bg2); border: 1px solid var(--border); border-radius: 0.75rem; padding: 1rem; margin-bottom: 0.75rem; cursor: pointer; }
        .hist-top { display: flex; justify-content: space-between; margin-bottom: 0.5rem; }
        .hist-date { font-size: 0.875rem; }
        .hist-day { font-size: 0.75rem; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-weight: 600; }
        .hist-day.A { background: rgba(59,130,246,0.2); color: var(--blue); }
        .hist-day.B { background: rgba(239,68,68,0.2); color: var(--red); }
        .hist-day.C { background: rgba(34,197,94,0.2); color: var(--green); }
        .hist-day.D { background: rgba(168,85,247,0.2); color: var(--purple); }
        .hist-lift { font-weight: 600; margin-bottom: 0.25rem; }
        .hist-summary { font-size: 0.75rem; color: var(--text2); }
        
        /* Progress */
        .prog-btns { display: flex; gap: 0.5rem; margin-bottom: 1rem; overflow-x: auto; }
        .prog-btn { padding: 0.5rem 0.75rem; background: var(--bg2); border: 1px solid var(--border); border-radius: 0.5rem; color: var(--text2); font-size: 0.875rem; cursor: pointer; white-space: nowrap; }
        .prog-btn.active { border-color: var(--accent); color: var(--text); }
        .prog-chart { background: var(--bg2); border: 1px solid var(--border); border-radius: 0.75rem; padding: 1rem; }
        .prog-title { font-size: 0.75rem; color: var(--text2); margin-bottom: 1rem; }
        .prog-row { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; }
        .prog-date { font-size: 0.625rem; color: var(--text3); width: 3rem; }
        .prog-bar-bg { flex: 1; height: 1.25rem; background: var(--bg3); border-radius: 0.25rem; overflow: hidden; }
        .prog-bar { height: 100%; background: var(--accent); border-radius: 0.25rem; }
        .prog-val { font-size: 0.75rem; width: 2.5rem; text-align: right; }
        
        /* Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.95); z-index: 200; overflow-y: auto; }
        .modal.show { display: block; }
        .modal-inner { max-width: 500px; margin: 1rem auto; padding: 1rem; }
        .modal-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border); }
        .modal-title { font-size: 1.125rem; font-weight: 600; }
        .modal-close { width: 2.5rem; height: 2.5rem; border: none; background: var(--bg2); color: var(--text); font-size: 1.25rem; border-radius: 0.5rem; cursor: pointer; }
        .modal-date { font-size: 0.875rem; color: var(--text2); margin-bottom: 1rem; }
        .modal-btns { display: flex; gap: 0.5rem; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border); }
        .modal-btn { flex: 1; padding: 0.75rem; border: none; border-radius: 0.5rem; font-size: 0.875rem; font-weight: 600; cursor: pointer; }
        .modal-btn.save { background: var(--accent); color: #000; }
        .modal-btn.delete { background: var(--danger); color: #fff; }
        .modal-btn.cancel { background: var(--bg2); color: var(--text2); border: 1px solid var(--border); }
        .modal-btn.ics { background: var(--blue); color: #fff; }
        
        /* Empty & Toast */
        .empty { text-align: center; padding: 3rem 1rem; color: var(--text2); }
        .toast { position: fixed; bottom: 2rem; left: 50%; transform: translateX(-50%) translateY(100px); background: var(--success); color: #000; padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-weight: 600; opacity: 0; transition: all 0.3s; z-index: 300; }
        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
        .file-input { display: none; }

        /* Mode Toggle */
        .mode-toggle { display: flex; gap: 0.5rem; margin-bottom: 1rem; }
        .mode-btn { flex: 1; padding: 0.75rem; border: 2px solid var(--border); background: var(--bg2); color: var(--text2); font-size: 0.875rem; font-weight: 600; border-radius: 0.5rem; cursor: pointer; text-align: center; }
        .mode-btn.active { border-color: var(--accent); color: var(--text); background: rgba(245,158,11,0.1); }

        /* Cardio */
        .cardio-types { display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.5rem; margin-bottom: 1rem; }
        .cardio-btn { padding: 0.75rem 0.5rem; border: 2px solid var(--border); background: var(--bg2); color: var(--text2); font-size: 0.75rem; font-weight: 600; border-radius: 0.75rem; cursor: pointer; text-align: center; }
        .cardio-btn span { font-size: 1.5rem; display: block; margin-bottom: 0.25rem; }
        .cardio-btn.active { border-color: var(--accent); color: var(--text); }
        .cardio-form { background: var(--bg2); border: 1px solid var(--border); border-radius: 0.75rem; padding: 1rem; }
        .cardio-row { display: flex; gap: 0.5rem; margin-bottom: 0.75rem; }
        .cardio-field { flex: 1; }
        .cardio-field label { display: block; font-size: 0.7rem; color: var(--text2); margin-bottom: 0.25rem; }
        .cardio-field input { width: 100%; padding: 0.625rem; background: var(--bg3); border: 1px solid var(--border); border-radius: 0.375rem; color: var(--text); font-size: 1rem; text-align: center; }
        .cardio-field input:focus { outline: none; border-color: var(--accent); }
        .intensity-btns { display: flex; gap: 0.25rem; }
        .intensity-btn { flex: 1; padding: 0.5rem; border: 1px solid var(--border); background: var(--bg3); color: var(--text2); font-size: 0.625rem; border-radius: 0.25rem; cursor: pointer; }
        .intensity-btn.active { border-color: var(--success); color: var(--success); background: rgba(34,197,94,0.2); }
        .intensity-btn.active.medium { border-color: var(--accent); color: var(--accent); background: rgba(245,158,11,0.2); }
        .intensity-btn.active.high { border-color: var(--danger); color: var(--danger); background: rgba(239,68,68,0.2); }
        .add-cardio-btn { width: 100%; padding: 0.75rem; margin-bottom: 0.75rem; background: var(--bg2); border: 2px dashed var(--border); border-radius: 0.75rem; color: var(--text2); font-size: 0.875rem; cursor: pointer; }
        .add-cardio-btn:hover { border-color: var(--accent); color: var(--accent); }
        .training-cardio-card { background: var(--bg2); border: 2px solid var(--accent); border-radius: 0.75rem; padding: 1rem; margin-bottom: 0.75rem; }
        .training-cardio-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem; }
        .training-cardio-title { font-weight: 600; color: var(--accent); }
        .training-cardio-remove { background: transparent; border: 1px solid var(--danger); color: var(--danger); padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.625rem; cursor: pointer; }

        /* Dashboard */
        .dash-section { background: var(--bg2); border: 1px solid var(--border); border-radius: 0.75rem; padding: 1rem; margin-bottom: 1rem; }
        .dash-title { font-size: 0.875rem; font-weight: 600; margin-bottom: 0.75rem; color: var(--text); }
        .dash-week { display: grid; grid-template-columns: repeat(7, 1fr); gap: 0.25rem; }
        .dash-week-day { text-align: center; padding: 0.5rem 0.25rem; background: var(--bg3); border-radius: 0.375rem; font-size: 0.625rem; }
        .dash-week-day .day-label { color: var(--text3); margin-bottom: 0.25rem; }
        .dash-week-day .day-status { font-size: 0.875rem; }
        .dash-week-day.today { border: 1px solid var(--accent); }
        .dash-week-day.trained { background: rgba(34,197,94,0.2); }
        .dash-week-day.trained .day-status { color: var(--success); }
        .dash-next { display: flex; flex-direction: column; gap: 0.5rem; }
        .dash-next-main { font-size: 1.125rem; font-weight: 600; color: var(--accent); }
        .dash-next-sub { font-size: 0.75rem; color: var(--text2); }
        .dash-next-btn { margin-top: 0.5rem; padding: 0.75rem; background: var(--accent); border: none; border-radius: 0.5rem; color: #000; font-weight: 600; cursor: pointer; }
        .dash-streak { display: flex; flex-direction: column; gap: 0.5rem; }
        .dash-streak-bar { height: 1.5rem; background: var(--bg3); border-radius: 0.5rem; overflow: hidden; position: relative; }
        .dash-streak-fill { height: 100%; background: linear-gradient(90deg, var(--accent), var(--success)); border-radius: 0.5rem; transition: width 0.5s; }
        .dash-streak-text { font-size: 0.875rem; color: var(--text2); }
        .dash-streak-text strong { color: var(--text); }
        .dash-lifts { display: flex; flex-direction: column; gap: 0.75rem; }
        .dash-lift-row { display: flex; align-items: center; gap: 0.5rem; }
        .dash-lift-name { width: 5rem; font-size: 0.75rem; color: var(--text2); }
        .dash-lift-vals { flex: 1; display: flex; gap: 0.375rem; font-size: 0.75rem; }
        .dash-lift-val { background: var(--bg3); padding: 0.25rem 0.5rem; border-radius: 0.25rem; }
        .dash-lift-val.latest { background: var(--accent); color: #000; font-weight: 600; }
        .dash-lift-trend { font-size: 0.875rem; }
        .dash-lift-trend.up { color: var(--success); }
        .dash-lift-trend.down { color: var(--danger); }
        .dash-lift-trend.same { color: var(--text3); }
        .dash-export { display: flex; flex-direction: column; gap: 0.75rem; }
        .dash-export-desc { font-size: 0.75rem; color: var(--text2); margin: 0; }
        .dash-export-btns { display: flex; gap: 0.5rem; }
        .dash-export-btn { flex: 1; padding: 0.625rem; background: var(--bg3); border: 1px solid var(--border); border-radius: 0.5rem; color: var(--text); font-size: 0.75rem; cursor: pointer; }
        .drop-zone { border: 2px dashed var(--border); border-radius: 0.75rem; padding: 1.5rem; text-align: center; cursor: pointer; transition: all 0.2s; }
        .drop-zone:hover, .drop-zone.drag-over { border-color: var(--accent); background: rgba(245,158,11,0.1); }
        .drop-zone-icon { font-size: 2rem; margin-bottom: 0.5rem; }
        .drop-zone-text { font-size: 0.75rem; color: var(--text2); }
        .dash-export-btn:hover { background: var(--accent); color: #000; border-color: var(--accent); }

        /* Exercises Browser */
        .ex-browser { padding-bottom: 1rem; }
        .ex-search-row { margin-bottom: 0.75rem; }
        .ex-search { width: 100%; padding: 0.75rem 1rem; background: var(--bg2); border: 1px solid var(--border); border-radius: 0.5rem; color: var(--text); font-size: 0.875rem; }
        .ex-search:focus { outline: none; border-color: var(--accent); }
        .ex-search::placeholder { color: var(--text3); }
        .ex-filters { display: flex; gap: 0.375rem; flex-wrap: wrap; margin-bottom: 0.75rem; }
        .ex-filter { padding: 0.375rem 0.625rem; background: var(--bg2); border: 1px solid var(--border); border-radius: 0.375rem; color: var(--text2); font-size: 0.6875rem; cursor: pointer; white-space: nowrap; }
        .ex-filter.active { background: var(--accent); color: #000; border-color: var(--accent); }
        .ex-count { font-size: 0.75rem; color: var(--text3); margin-bottom: 0.75rem; }
        .ex-grid { display: flex; flex-direction: column; gap: 0.5rem; }
        .ex-tile { background: var(--bg2); border: 1px solid var(--border); border-radius: 0.75rem; padding: 0.875rem; display: flex; align-items: flex-start; gap: 0.75rem; }
        .ex-tile-yt { flex-shrink: 0; width: 2.5rem; height: 2.5rem; background: #ff0000; border-radius: 0.5rem; display: flex; align-items: center; justify-content: center; color: #fff; font-size: 1rem; text-decoration: none; }
        .ex-tile-yt:hover { background: #cc0000; transform: scale(1.05); }
        .ex-tile-info { flex: 1; min-width: 0; }
        .ex-tile-name { font-weight: 600; font-size: 0.9375rem; margin-bottom: 0.25rem; color: var(--text); }
        .ex-tile-meta { display: flex; flex-wrap: wrap; gap: 0.375rem; margin-bottom: 0.375rem; }
        .ex-tile-tag { padding: 0.125rem 0.375rem; background: var(--bg3); border-radius: 0.25rem; font-size: 0.625rem; color: var(--text2); }
        .ex-tile-tag.pattern { background: rgba(245,158,11,0.2); color: var(--accent); }
        .ex-tile-tag.equipment { background: rgba(59,130,246,0.2); color: var(--blue); }
        .ex-tile-tag.muscle { background: rgba(34,197,94,0.2); color: var(--success); }
        .ex-tile-tag.unilateral { background: rgba(168,85,247,0.2); color: var(--purple); }
        .ex-tile-hint { font-size: 0.75rem; color: var(--text3); font-style: italic; }

        /* Health Match Modal */
        .health-match-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 250; display: flex; align-items: center; justify-content: center; padding: 1rem; }
        .health-match-modal { background: var(--bg2); border: 1px solid var(--border); border-radius: 1rem; padding: 1.5rem; max-width: 400px; width: 100%; }
        .health-match-header { display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1rem; }
        .health-match-icon { font-size: 2rem; }
        .health-match-title { font-weight: 600; font-size: 1rem; }
        .health-match-subtitle { font-size: 0.75rem; color: var(--text2); }
        .health-match-stats { background: var(--bg3); border-radius: 0.75rem; padding: 1rem; margin-bottom: 1rem; }
        .health-match-stat { display: flex; justify-content: space-between; padding: 0.375rem 0; border-bottom: 1px solid var(--border); }
        .health-match-stat:last-child { border-bottom: none; }
        .health-match-stat-label { font-size: 0.75rem; color: var(--text2); }
        .health-match-stat-value { font-size: 0.875rem; font-weight: 600; }
        .health-match-training { background: rgba(245,158,11,0.1); border: 1px solid var(--accent); border-radius: 0.75rem; padding: 1rem; margin-bottom: 1rem; }
        .health-match-training-label { font-size: 0.625rem; color: var(--accent); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.25rem; }
        .health-match-training-name { font-weight: 600; font-size: 1rem; }
        .health-match-training-date { font-size: 0.75rem; color: var(--text2); }
        .health-match-btns { display: flex; gap: 0.5rem; }
        .health-match-btn { flex: 1; padding: 0.875rem; border: none; border-radius: 0.5rem; font-size: 0.875rem; font-weight: 600; cursor: pointer; }
        .health-match-btn.confirm { background: var(--success); color: #000; }
        .health-match-btn.skip { background: var(--bg3); color: var(--text2); }
        .health-match-btn.other { background: var(--blue); color: #fff; }
        .health-match-progress { font-size: 0.625rem; color: var(--text3); text-align: center; margin-bottom: 0.75rem; }
        .health-match-select { width: 100%; padding: 0.75rem; background: var(--bg3); border: 1px solid var(--border); border-radius: 0.5rem; color: var(--text); font-size: 0.875rem; margin-bottom: 0.75rem; }

        /* Apple Health badge in history */
        .health-badge { display: inline-flex; align-items: center; gap: 0.25rem; background: rgba(239,68,68,0.15); color: var(--danger); padding: 0.125rem 0.375rem; border-radius: 0.25rem; font-size: 0.625rem; font-weight: 600; }
    </style>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <!-- Config (not in git) -->
    <script src="config.js"></script>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="logo">LIFT<span>LOG</span> <small style="font-size:0.5rem;color:#666">v4.0</small> <span id="sync-status" style="font-size:0.5rem;color:#666"></span><span id="sheets-status" style="font-size:0.5rem;color:#666;margin-left:2px"></span></div>
            <nav class="nav">
                <button data-screen="dashboard">Home</button>
                <button class="active" data-screen="new">Nieuw</button>
                <button data-screen="history">Log</button>
                <button data-screen="exercises">Gym</button>
                <button data-screen="progress">Stats</button>
            </nav>
        </div>
    </header>

    <main class="main">
        <section id="screen-new" class="screen active">
            <div class="mode-toggle">
                <button class="mode-btn active" data-mode="lifting">üèãÔ∏è Lifting</button>
                <button class="mode-btn" data-mode="cardio">üèÉ Cardio</button>
            </div>
            <div id="lifting-section">
                <div class="week-bar">Week <span id="week-num">1</span> | RPE 6-7</div>
                <div class="days" id="day-btns">
                    <button class="day-btn" data-day="A"><span>A</span>Squat</button>
                    <button class="day-btn" data-day="B"><span>B</span>Bench</button>
                    <button class="day-btn" data-day="C"><span>C</span>Deadlift</button>
                    <button class="day-btn" data-day="D"><span>D</span>Push Press</button>
                </div>
            </div>
            <div id="cardio-section" style="display:none;">
                <div class="cardio-types" id="cardio-types">
                    <button class="cardio-btn" data-type="running"><span>üèÉ</span>Hardlopen</button>
                    <button class="cardio-btn" data-type="cycling"><span>üö¥</span>Fietsen</button>
                    <button class="cardio-btn" data-type="rowing"><span>üö£</span>Roeien</button>
                    <button class="cardio-btn" data-type="hiit"><span>‚ö°</span>HIIT</button>
                    <button class="cardio-btn" data-type="walking"><span>üö∂</span>Wandelen</button>
                    <button class="cardio-btn" data-type="other"><span>üí™</span>Anders</button>
                </div>
                <div id="cardio-form-container"></div>
            </div>
            <div class="date-row">
                <label>Datum & Starttijd</label>
                <div style="display:flex;gap:0.5rem;">
                    <input type="text" class="date-input" id="date-input" placeholder="30-12-2025" inputmode="numeric" style="flex:1;">
                    <input type="text" class="date-input" id="time-input" placeholder="09:00" inputmode="numeric" style="width:5rem;text-align:center;">
                </div>
            </div>
            <div class="collapse-all-row" id="collapse-all-row" style="display:none;">
                <button class="collapse-all-btn" id="collapse-all-btn">‚ñº Alles inklappen</button>
            </div>
            <div id="exercises"></div>
            <div id="training-cardio"></div>
            <button class="add-cardio-btn" id="add-cardio-btn" style="display:none;">‚ûï Cardio toevoegen</button>
            <button class="save-btn" id="save-btn" disabled>Training Opslaan</button>
            <div class="actions">
                <select class="week-select" id="week-select"><option value="all">Alle weken</option></select>
                <button class="action-btn" id="export-btn">üì§ Export</button>
                <button class="action-btn" id="import-btn">üì• Import</button>
            </div>
            <input type="file" class="file-input" id="file-input" accept=".csv">
        </section>

        <section id="screen-history" class="screen">
            <div id="history"></div>
        </section>

        <section id="screen-progress" class="screen">
            <div class="prog-btns">
                <button class="prog-btn active" data-lift="Back Squat">Squat</button>
                <button class="prog-btn" data-lift="Bench Press">Bench</button>
                <button class="prog-btn" data-lift="Conventional Deadlift">Deadlift</button>
                <button class="prog-btn" data-lift="Push Press">Push Press</button>
            </div>
            <div class="prog-chart">
                <div class="prog-title">Topset Progressie (kg)</div>
                <div id="progress"></div>
            </div>
        </section>

        <section id="screen-dashboard" class="screen">
            <div class="dash-section">
                <div class="dash-title">üìÖ Deze week</div>
                <div class="dash-week" id="dash-week"></div>
            </div>
            <div class="dash-section">
                <div class="dash-title">‚è≠Ô∏è Volgende training</div>
                <div class="dash-next" id="dash-next"></div>
            </div>
            <div class="dash-section">
                <div class="dash-title">üî• Consistentie</div>
                <div class="dash-streak" id="dash-streak"></div>
            </div>
            <div class="dash-section">
                <div class="dash-title">üìä Hoofdlifts (laatste 4)</div>
                <div class="dash-lifts" id="dash-lifts"></div>
            </div>
            <div class="dash-section">
                <div class="dash-title">üìÜ Kalender Export</div>
                <div class="dash-export">
                    <p class="dash-export-desc">Exporteer trainingen naar Apple Calendar</p>
                    <div class="dash-export-btns">
                        <button class="dash-export-btn" id="ics-export-all">Alles</button>
                        <button class="dash-export-btn" id="ics-export-month">Deze maand</button>
                        <button class="dash-export-btn" id="ics-export-week">Deze week</button>
                    </div>
                </div>
            </div>
            <div class="dash-section">
                <div class="dash-title">‚ù§Ô∏è Apple Health Import</div>
                <div class="drop-zone" id="health-drop-zone">
                    <div class="drop-zone-content">
                        <div class="drop-zone-icon">üì•</div>
                        <div class="drop-zone-text">Sleep CSV hier of klik om te selecteren</div>
                    </div>
                    <input type="file" class="file-input" id="health-file-input" accept=".csv">
                </div>
                <div id="health-import-result" style="margin-top:0.75rem;font-size:0.75rem;"></div>
                <div id="health-overview" style="margin-top:1rem;"></div>
            </div>
        </section>

        <section id="screen-exercises" class="screen">
            <div class="ex-browser">
                <div class="ex-search-row">
                    <input type="text" class="ex-search" id="ex-search" placeholder="üîç Zoek oefening...">
                </div>
                <div class="ex-filters" id="ex-filters">
                    <button class="ex-filter active" data-pattern="all">Alles</button>
                    <button class="ex-filter" data-pattern="squat">Squat</button>
                    <button class="ex-filter" data-pattern="hinge">Hinge</button>
                    <button class="ex-filter" data-pattern="push_horizontal">Push H</button>
                    <button class="ex-filter" data-pattern="push_vertical">Push V</button>
                    <button class="ex-filter" data-pattern="pull_horizontal">Pull H</button>
                    <button class="ex-filter" data-pattern="pull_vertical">Pull V</button>
                    <button class="ex-filter" data-pattern="carry">Carry</button>
                    <button class="ex-filter" data-pattern="activation">Activatie</button>
                    <button class="ex-filter" data-pattern="isolation">Isolatie</button>
                </div>
                <div class="ex-count" id="ex-count"></div>
                <div class="ex-grid" id="ex-grid"></div>
            </div>
        </section>
    </main>

    <div class="modal" id="modal">
        <div class="modal-inner">
            <div class="modal-head">
                <span class="modal-title" id="modal-title"></span>
                <button class="modal-close" id="modal-close">‚úï</button>
            </div>
            <div class="modal-date" id="modal-date"></div>
            <div id="modal-body"></div>
            <div class="modal-btns">
                <button class="modal-btn ics" id="btn-ics">üìÜ</button>
                <button class="modal-btn cancel" id="btn-cancel">Annuleren</button>
                <button class="modal-btn delete" id="btn-delete">Verwijder</button>
                <button class="modal-btn save" id="btn-save">Opslaan</button>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <!-- Health Match Modal -->
    <div class="health-match-overlay" id="health-match-overlay" style="display:none;">
        <div class="health-match-modal">
            <div class="health-match-progress" id="health-match-progress"></div>
            <div class="health-match-header">
                <div class="health-match-icon">‚åö</div>
                <div>
                    <div class="health-match-title">Apple Watch workout gevonden</div>
                    <div class="health-match-subtitle" id="health-match-time"></div>
                </div>
            </div>
            <div class="health-match-stats" id="health-match-stats"></div>
            <div class="health-match-training" id="health-match-training"></div>
            <select class="health-match-select" id="health-match-select" style="display:none;"></select>
            <div class="health-match-btns">
                <button class="health-match-btn skip" id="health-match-skip">Overslaan</button>
                <button class="health-match-btn other" id="health-match-other">Andere...</button>
                <button class="health-match-btn confirm" id="health-match-confirm">Koppelen</button>
            </div>
        </div>
    </div>

    <!-- Add Exercise Modal -->
    <div class="add-ex-modal" id="add-ex-modal" style="display:none;">
        <div class="add-ex-modal-head">
            <span class="add-ex-modal-title">Oefening toevoegen</span>
            <button class="add-ex-modal-close" id="add-ex-modal-close">‚úï</button>
        </div>
        <input type="text" class="add-ex-search" id="add-ex-search" placeholder="üîç Zoek oefening...">
        <div class="add-ex-results" id="add-ex-results"></div>
        <div class="add-ex-custom">
            <div class="add-ex-custom-title">Of voer handmatig in:</div>
            <div class="add-ex-custom-row">
                <input type="text" class="add-ex-custom-input" id="add-ex-custom-name" placeholder="Naam (bijv. Touwtje springen)">
                <select class="add-ex-type-select" id="add-ex-custom-type">
                    <option value="weight">Gewicht</option>
                    <option value="timed">Tijd</option>
                    <option value="check">Check</option>
                </select>
                <button class="add-ex-custom-btn" id="add-ex-custom-add">+</button>
            </div>
        </div>
    </div>

    <script>
    (function() {
        'use strict';

        // ===========================================
        // FIREBASE CONFIGURATION
        // ===========================================
        const firebaseConfig = {
            apiKey: "AIzaSyC9kFOUsF7VQ7moskmuFcuZ8qtPAesVXB0",
            authDomain: "liftlog-2e359.firebaseapp.com",
            databaseURL: "https://liftlog-2e359-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "liftlog-2e359",
            storageBucket: "liftlog-2e359.firebasestorage.app",
            messagingSenderId: "671831248974",
            appId: "1:671831248974:web:fcc25f76c60741fd27b31f"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();
        let firebaseUid = null;
        let isOnline = navigator.onLine;
        let pendingSync = false;
        let firebaseReady = false;

        // Firebase sync functions
        function updateSyncStatus(status) {
            const el = document.getElementById('sync-status');
            if (el) {
                if (status === 'syncing') el.textContent = '‚è≥';
                else if (status === 'synced') el.textContent = '‚òÅÔ∏è';
                else if (status === 'offline') el.textContent = 'üì¥';
                else if (status === 'error') el.textContent = '‚ö†Ô∏è';
                else el.textContent = '';
            }
        }

        function syncToFirebase() {
            if (!firebaseUid || !isOnline) {
                pendingSync = true;
                updateSyncStatus('offline');
                return;
            }
            updateSyncStatus('syncing');
            const localData = JSON.parse(localStorage.getItem('liftlog3')) || [];
            const healthData = JSON.parse(localStorage.getItem('liftlog_health_imports')) || [];

            db.ref('users/' + firebaseUid).set({
                trainings: localData,
                healthImports: healthData,
                lastUpdated: Date.now()
            }).then(() => {
                console.log('Synced to Firebase');
                pendingSync = false;
                updateSyncStatus('synced');
            }).catch(err => {
                console.error('Firebase sync error:', err);
                pendingSync = true;
                updateSyncStatus('error');
            });
        }

        // Google Sheets sync (URL from config.js)
        const SHEETS_WEBHOOK_URL = (typeof LIFTLOG_CONFIG !== 'undefined' && LIFTLOG_CONFIG.SHEETS_WEBHOOK_URL) || null;
        let sheetsQueue = JSON.parse(localStorage.getItem('liftlog_sheets_queue')) || [];

        function updateSheetsStatus(status) {
            const el = document.getElementById('sheets-status');
            if (el) {
                if (status === 'syncing') el.textContent = 'üìä‚è≥';
                else if (status === 'synced') el.textContent = 'üìä‚úì';
                else if (status === 'queued') el.textContent = 'üìäüì¥';
                else if (status === 'error') el.textContent = 'üìä‚ö†Ô∏è';
                else el.textContent = '';
                // Clear success indicator after 3 seconds
                if (status === 'synced') {
                    setTimeout(() => { if (el.textContent === 'üìä‚úì') el.textContent = ''; }, 3000);
                }
            }
        }

        function formatTrainingForSheets(training) {
            // Convert internal format to Sheets webhook format
            const datum = training.date;
            const startTime = training.startTime ? new Date(training.startTime).toLocaleTimeString('nl-NL', {hour:'2-digit', minute:'2-digit'}) : '';

            // Build sets array
            const sets = [];
            if (training.exercises) {
                training.exercises.forEach(ex => {
                    if (ex.skipped || !ex.sets) return;
                    ex.sets.forEach((set, idx) => {
                        sets.push({
                            oefening: ex.name,
                            setNr: idx + 1,
                            gewicht: set.w || 0,
                            reps: set.r || 0,
                            rpe: set.rpe || null,
                            type: set.warmup ? 'warmup' : (idx === ex.sets.filter(s => !s.warmup).length - 1 ? 'topset' : 'werk')
                        });
                    });
                });
            }

            return {
                type: training.isCardio ? 'cardio' : 'training',
                id: training.id,
                datum: datum,
                training: training.day || (training.isCardio ? 'Cardio' : ''),
                starttijd: startTime,
                eindtijd: '',
                week: training.week || null,
                fase: '',
                rpeTarget: null,
                rpeWerkelijk: null,
                notities: training.notes || '',
                sets: sets,
                // Cardio specific
                cardioType: training.cardioType || null,
                cardioName: training.cardioName || null,
                duration: training.duration || null
            };
        }

        function syncToGoogleSheets(training) {
            // Skip if no webhook URL configured
            if (!SHEETS_WEBHOOK_URL) {
                console.log('Sheets sync skipped: no webhook URL configured');
                return;
            }

            const payload = formatTrainingForSheets(training);

            // DEBUG: Log wat naar Sheets wordt gestuurd
            console.log('=== SHEETS PAYLOAD ===');
            console.log('Sets being sent:', JSON.stringify(payload.sets, null, 2));

            if (!isOnline) {
                // Queue for later
                sheetsQueue.push(payload);
                localStorage.setItem('liftlog_sheets_queue', JSON.stringify(sheetsQueue));
                updateSheetsStatus('queued');
                console.log('Sheets sync queued (offline)');
                return;
            }

            updateSheetsStatus('syncing');

            fetch(SHEETS_WEBHOOK_URL, {
                method: 'POST',
                mode: 'no-cors', // Google Apps Script requires no-cors
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            }).then(() => {
                console.log('Synced to Google Sheets');
                updateSheetsStatus('synced');
            }).catch(err => {
                console.error('Sheets sync error:', err);
                // Queue for retry
                sheetsQueue.push(payload);
                localStorage.setItem('liftlog_sheets_queue', JSON.stringify(sheetsQueue));
                updateSheetsStatus('error');
            });
        }

        function processGoogleSheetsQueue() {
            if (!isOnline || sheetsQueue.length === 0) return;

            updateSheetsStatus('syncing');
            const queue = [...sheetsQueue];
            sheetsQueue = [];
            localStorage.setItem('liftlog_sheets_queue', JSON.stringify(sheetsQueue));

            // Send all queued items
            Promise.all(queue.map(payload =>
                fetch(SHEETS_WEBHOOK_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                })
            )).then(() => {
                console.log(`Processed ${queue.length} queued Sheets syncs`);
                updateSheetsStatus('synced');
            }).catch(err => {
                console.error('Sheets queue processing error:', err);
                // Re-queue failed items
                sheetsQueue = [...sheetsQueue, ...queue];
                localStorage.setItem('liftlog_sheets_queue', JSON.stringify(sheetsQueue));
                updateSheetsStatus('error');
            });
        }

        function loadFromFirebase() {
            if (!firebaseUid) return Promise.resolve(null);

            return db.ref('users/' + firebaseUid).once('value').then(snapshot => {
                const fbData = snapshot.val();
                if (fbData && fbData.trainings) {
                    // Merge: Firebase wins if newer, otherwise keep local
                    const localData = JSON.parse(localStorage.getItem('liftlog3')) || [];
                    const localTimestamp = parseInt(localStorage.getItem('liftlog3_timestamp')) || 0;

                    if (fbData.lastUpdated > localTimestamp || localData.length === 0) {
                        localStorage.setItem('liftlog3', JSON.stringify(fbData.trainings));
                        localStorage.setItem('liftlog3_timestamp', fbData.lastUpdated.toString());
                        if (fbData.healthImports) {
                            localStorage.setItem('liftlog_health_imports', JSON.stringify(fbData.healthImports));
                        }
                        return fbData.trainings;
                    }
                }
                return null;
            }).catch(err => {
                console.error('Firebase load error:', err);
                return null;
            });
        }

        // Anonymous auth
        auth.signInAnonymously().catch(err => {
            console.error('Auth error:', err);
        });

        auth.onAuthStateChanged(user => {
            if (user) {
                firebaseUid = user.uid;
                console.log('Firebase auth ready:', firebaseUid);


                // Load from Firebase and merge
                loadFromFirebase().then(fbData => {
                    firebaseReady = true;
                    if (fbData) {
                        data = fbData;
                        healthImports = JSON.parse(localStorage.getItem('liftlog_health_imports')) || [];
                        renderHistory();
                        showToast('Data gesynchroniseerd');
                    } else if (pendingSync) {
                        syncToFirebase();
                    }
                });
            }
        });

        // Online/offline detection
        window.addEventListener('online', () => {
            isOnline = true;
            if (pendingSync && firebaseUid) {
                syncToFirebase();
                showToast('Online - data gesynchroniseerd');
            }
            // Process queued Sheets syncs
            if (sheetsQueue.length > 0) {
                processGoogleSheetsQueue();
            }
        });

        window.addEventListener('offline', () => {
            isOnline = false;
        });

        // ===========================================
        // EXERCISES DATABASE (met YouTube links)
        // ===========================================
        // EXERCISES wordt geladen uit /data/exercises.json
        let EXERCISES = {};

        // ===========================================
        // TRAINING TEMPLATES (slot-based)
        // ===========================================
        const SLOT_TEMPLATES = {
            A: {
                name: 'Squat',
                mainLift: 'back_squat',
                slots: [
                    { order: 1, role: 'main', exerciseId: 'back_squat', sets: 4, reps: 5 },
                    { order: 2, role: 'accessory', pattern: 'hinge', sets: 3, reps: 10, exclude: ['conventional_deadlift'] },
                    { order: 3, role: 'accessory', pattern: 'push_horizontal', angle: 'incline', sets: 3, reps: 10 },
                    { order: 4, role: 'accessory', pattern: 'pull_horizontal', sets: 3, reps: 10 },
                    { order: 5, role: 'finisher', pattern: 'carry', sets: 1, isTimed: true }
                ]
            },
            B: {
                name: 'Bench Press',
                mainLift: 'bench_press',
                slots: [
                    { order: 1, role: 'activation', exerciseId: 'scapula_retractions', sets: 2, reps: 15 },
                    { order: 2, role: 'main', exerciseId: 'bench_press', sets: 4, reps: 5 },
                    { order: 3, role: 'accessory', pattern: 'pull_horizontal', sets: 3, reps: 10 },
                    { order: 4, role: 'accessory', pattern: 'squat', prefer: 'unilateral', sets: 3, reps: 10 },
                    { order: 5, role: 'accessory', exerciseId: 'face_pulls', sets: 2, reps: 15 },
                    { order: 6, role: 'finisher', exerciseId: 'btbbh', sets: 2, isTimed: true }
                ]
            },
            C: {
                name: 'Deadlift',
                mainLift: 'conventional_deadlift',
                slots: [
                    { order: 1, role: 'activation', exerciseId: 'hip_hinge_stick', sets: 2, reps: 8 },
                    { order: 2, role: 'main', exerciseId: 'conventional_deadlift', sets: 4, reps: 5 },
                    { order: 3, role: 'accessory', pattern: 'squat', prefer: 'unilateral', sets: 3, reps: 10 },
                    { order: 4, role: 'accessory', pattern: 'pull_horizontal', prefer: 'unilateral', sets: 3, reps: 10 },
                    { order: 5, role: 'accessory', pattern: 'push_horizontal', sets: 3, reps: 10 },
                    { order: 6, role: 'finisher', exerciseId: 'dead_hang', sets: 1, isTimed: true }
                ]
            },
            D: {
                name: 'Push Press',
                mainLift: 'push_press',
                slots: [
                    { order: 1, role: 'activation', exerciseId: 'scapula_retractions', sets: 2, reps: 15 },
                    { order: 2, role: 'main', exerciseId: 'push_press', sets: 4, reps: 5 },
                    { order: 3, role: 'accessory', pattern: 'pull_vertical', sets: 3, reps: 10 },
                    { order: 4, role: 'accessory', pattern: 'squat', exclude: ['back_squat', 'front_squat'], sets: 3, reps: 10 },
                    { order: 5, role: 'accessory', pattern: 'pull_horizontal', sets: 3, reps: 10 },
                    { order: 6, role: 'finisher', exerciseId: 'btbbh', sets: 2, isTimed: true }
                ]
            }
        };

        // Initial data
        const INIT = [
            { id: 1, date: '2025-12-22', day: 'D', lift: 'Push Press', week: 2, exercises: [
                { name: 'Scapula Retractions', type: 'check', done: true },
                { name: 'Push Press', type: 'weight', sets: [{w:'20',r:'10',warmup:true},{w:'30',r:'10',warmup:true},{w:'40',r:'5'},{w:'45',r:'5'},{w:'50',r:'5'}]},
                { name: 'Lat Pulldown', type: 'weight', sets: [{w:'75',r:'10'},{w:'85',r:'10'},{w:'95',r:'10'}]},
                { name: 'Goblet Squat', type: 'weight', sets: [{w:'20',r:'10'},{w:'28',r:'10'},{w:'32',r:'10'}], equip: 'KB'},
                { name: 'Seated Cable Row', type: 'weight', sets: [{w:'75',r:'10'},{w:'85',r:'10'},{w:'95',r:'10'}]},
                { name: 'BTBBH', type: 'timed', sets: [], skipped: true, skipReason: 'Geen mogelijkheid in gym'}
            ]},
            { id: 2, date: '2025-12-20', day: 'C', lift: 'Deadlift', week: 1, exercises: [
                { name: 'Hip Hinge met stok', type: 'check', done: true },
                { name: 'Conventional Deadlift', type: 'weight', sets: [{w:'70',r:'5',warmup:true},{w:'90',r:'5'},{w:'100',r:'5'},{w:'110',r:'5'}]},
                { name: 'Leg Press uni', type: 'weight', sets: [{w:'40',r:'10'},{w:'60',r:'10'},{w:'70',r:'10'}]},
                { name: 'Dumbbell Row', type: 'weight', sets: [{w:'24',r:'10'},{w:'26',r:'10'},{w:'28',r:'10'}]},
                { name: 'Dips', type: 'weight', sets: [{w:'BW',r:'10'},{w:'BW',r:'10'},{w:'BW',r:'10'}]},
                { name: 'Dead Hang', type: 'timed', sets: [{w:'BW',t:'50'}]}
            ]},
            { id: 3, date: '2025-12-17', day: 'B', lift: 'Bench Press', week: 1, exercises: [
                { name: 'Scapula Retractions', type: 'check', done: true },
                { name: 'Bench Press', type: 'weight', sets: [{w:'20',r:'5',warmup:true},{w:'50',r:'5'},{w:'70',r:'5'},{w:'80',r:'5'},{w:'85',r:'5'},{w:'90',r:'5'}]},
                { name: 'Chest Supported Row', type: 'weight', sets: [{w:'30',r:'10'},{w:'40',r:'10'},{w:'50',r:'10'}]},
                { name: 'Bulgarian Split Squat', type: 'weight', sets: [{w:'20',r:'10'},{w:'20',r:'10'},{w:'20',r:'10'}]},
                { name: 'Face Pulls', type: 'weight', sets: [{w:'40',r:'15'},{w:'45',r:'15'}]},
                { name: 'BTBBH', type: 'timed', sets: [{w:'60',t:'60'},{w:'60',t:'40'}]}
            ]},
            { id: 4, date: '2025-12-15', day: 'A', lift: 'Squat', week: 1, exercises: [
                { name: 'Back Squat', type: 'weight', sets: [{w:'20',r:'5',warmup:true},{w:'40',r:'5'},{w:'50',r:'5'},{w:'60',r:'5'}]},
                { name: 'Romanian Deadlift', type: 'weight', sets: [{w:'20',r:'10',warmup:true},{w:'50',r:'10'},{w:'70',r:'10'},{w:'80',r:'10'}]},
                { name: 'Incline DB Press', type: 'weight', sets: [{w:'48',r:'10'},{w:'56',r:'10'},{w:'60',r:'10'}]},
                { name: 'Cable Row', type: 'weight', sets: [{w:'75',r:'10'},{w:'85',r:'10'},{w:'95',r:'10'}]},
                { name: 'Dead Hang', type: 'timed', sets: [{w:'BW',t:'20'}]}
            ]}
        ];

        // Cardio types
        const CARDIO_TYPES = {
            running: { id: 'running', name: 'Hardlopen', icon: 'üèÉ', hasDistance: true, unit: 'km' },
            cycling: { id: 'cycling', name: 'Fietsen', icon: 'üö¥', hasDistance: true, unit: 'km' },
            rowing: { id: 'rowing', name: 'Roeien', icon: 'üö£', hasDistance: true, unit: 'm' },
            hiit: { id: 'hiit', name: 'HIIT', icon: '‚ö°', hasDistance: false, hasIntervals: true },
            walking: { id: 'walking', name: 'Wandelen', icon: 'üö∂', hasDistance: true, unit: 'km' },
            other: { id: 'other', name: 'Anders', icon: 'üí™', hasDistance: false }
        };

        // State
        let data = JSON.parse(localStorage.getItem('liftlog3')) || INIT;
        if (!localStorage.getItem('liftlog3')) localStorage.setItem('liftlog3', JSON.stringify(INIT));
        let selectedDay = null;
        let current = null;
        let editIdx = null;
        let editData = null;
        let globalCollapsed = false;
        let currentMode = 'lifting';
        let selectedCardioType = null;
        let cardioData = null;
        let trainingCardio = []; // Cardio binnen een lifting training
        let healthImports = JSON.parse(localStorage.getItem('liftlog_health_imports')) || [];

        // DOM
        const $ = id => document.getElementById(id);
        const exEl = $('exercises');
        const saveBtn = $('save-btn');
        const dateInput = $('date-input');
        const timeInput = $('time-input');
        const modal = $('modal');
        const modalBody = $('modal-body');
        const toast = $('toast');
        const collapseAllRow = $('collapse-all-row');
        const collapseAllBtn = $('collapse-all-btn');

        // Date helpers
        const toDisplayDate = d => { const p = d.split('-'); return p[2] + '-' + p[1] + '-' + p[0]; }; // YYYY-MM-DD -> DD-MM-YYYY
        const toISODate = d => { const p = d.split('-'); return p[2] + '-' + p[1] + '-' + p[0]; }; // DD-MM-YYYY -> YYYY-MM-DD
        const isValidDate = d => { const p = d.split('-'); if (p.length !== 3) return false; const [dd,mm,yyyy] = p.map(Number); if (!dd||!mm||!yyyy) return false; const dt = new Date(yyyy,mm-1,dd); return dt.getDate()===dd && dt.getMonth()===mm-1 && dt.getFullYear()===yyyy; };
        const isValidTime = t => { const p = t.split(':'); if (p.length !== 2) return false; const [hh,mm] = p.map(Number); return !isNaN(hh) && !isNaN(mm) && hh >= 0 && hh <= 23 && mm >= 0 && mm <= 59; };
        const toISOTimestamp = (dateStr, timeStr) => { const isoDate = toISODate(dateStr); return `${isoDate}T${timeStr}:00`; };

        // Init
        const today = new Date();
        dateInput.value = today.getDate().toString().padStart(2,'0') + '-' + (today.getMonth()+1).toString().padStart(2,'0') + '-' + today.getFullYear();
        timeInput.value = today.getHours().toString().padStart(2,'0') + ':' + today.getMinutes().toString().padStart(2,'0');
        const wk = Math.max(1, Math.ceil((new Date() - new Date('2025-12-15')) / 604800000));
        $('week-num').textContent = wk;

        // Date input validation
        dateInput.oninput = () => {
            let v = dateInput.value.replace(/[^\d-]/g, '');
            // Auto-insert dashes
            if (v.length === 2 && !v.includes('-')) v += '-';
            if (v.length === 5 && v.split('-').length === 2) v += '-';
            dateInput.value = v;
            dateInput.classList.toggle('invalid', v.length >= 10 && !isValidDate(v));
        };

        // Time input validation
        timeInput.oninput = () => {
            let v = timeInput.value.replace(/[^\d:]/g, '');
            // Auto-insert colon
            if (v.length === 2 && !v.includes(':')) v += ':';
            timeInput.value = v;
            timeInput.classList.toggle('invalid', v.length >= 5 && !isValidTime(v));
        };

        // Helpers
        const showToast = msg => { toast.textContent = msg; toast.classList.add('show'); setTimeout(() => toast.classList.remove('show'), 2000); };
        const fmtDate = d => { const dt = new Date(d); return ['Zo','Ma','Di','Wo','Do','Vr','Za'][dt.getDay()] + ' ' + dt.getDate() + '-' + (dt.getMonth()+1); };
        const getPrev = (day, name) => { const t = data.find(x => x.day === day); return t ? t.exercises.find(e => e.name === name) : null; };
        const getPrevWithDate = name => {
            for (const t of data) {
                const ex = t.exercises.find(e => e.name === name && !e.skipped);
                if (ex && (ex.done || (ex.sets && ex.sets.length))) return { date: t.date, ex };
            }
            return null;
        };
        const save = () => {
            localStorage.setItem('liftlog3', JSON.stringify(data));
            localStorage.setItem('liftlog3_timestamp', Date.now().toString());
            syncToFirebase();
        };

        // ===========================================
        // SMART SELECTION LOGIC
        // ===========================================
        function getRecentExerciseIds(days = 3) {
            const cutoff = new Date();
            cutoff.setDate(cutoff.getDate() - days);
            return data
                .filter(t => new Date(t.date) >= cutoff)
                .flatMap(t => t.exercises.map(ex => ex.id || ex.name))
                .filter(Boolean);
        }

        function selectExerciseForSlot(slot) {
            // 1. Als slot een vast exerciseId heeft, gebruik die
            if (slot.exerciseId) {
                return EXERCISES[slot.exerciseId];
            }

            // 2. Filter oefeningen op pattern
            let candidates = Object.values(EXERCISES)
                .filter(ex => ex.pattern === slot.pattern);

            // 3. Filter op angle indien gespecificeerd
            if (slot.angle) {
                const withAngle = candidates.filter(ex => ex.angle === slot.angle);
                if (withAngle.length > 0) candidates = withAngle;
            }

            // 4. Filter op unilateral indien preferred
            if (slot.prefer === 'unilateral') {
                const unilateral = candidates.filter(ex => ex.unilateral);
                if (unilateral.length > 0) candidates = unilateral;
            }

            // 5. Exclude specifieke oefeningen
            if (slot.exclude) {
                candidates = candidates.filter(ex => !slot.exclude.includes(ex.id));
            }

            // 6. Exclude main lifts voor accessory slots
            if (slot.role === 'accessory') {
                candidates = candidates.filter(ex => !ex.isMainLift);
            }

            // 7. Exclude recent gedane oefeningen (laatste 3 trainingen)
            const recentIds = getRecentExerciseIds(7);
            const notRecent = candidates.filter(ex => !recentIds.includes(ex.id) && !recentIds.includes(ex.name));

            // 8. Als er niet-recente opties zijn, gebruik die
            if (notRecent.length > 0) {
                candidates = notRecent;
            }

            // 9. Return random uit overgebleven candidates
            if (candidates.length === 0) return null;
            return candidates[Math.floor(Math.random() * candidates.length)];
        }

        function getAlternativesForExercise(exercise) {
            // Vind alternatieven met hetzelfde pattern
            // Voor activation oefeningen: toon andere activation oefeningen
            // Voor reguliere oefeningen: toon geen activation oefeningen
            const isActivation = EXERCISES[exercise.id]?.isActivation || exercise.pattern === 'activation';
            return Object.values(EXERCISES)
                .filter(ex => {
                    if (ex.id === exercise.id) return false;
                    if (ex.isMainLift) return false;
                    if (isActivation) {
                        // Toon alleen activation oefeningen
                        return ex.isActivation || ex.pattern === 'activation';
                    } else {
                        // Toon alleen oefeningen van hetzelfde pattern, geen activation
                        return ex.pattern === exercise.pattern && !ex.isActivation;
                    }
                })
                .sort((a, b) => a.name.localeCompare(b.name));
        }

        // Update day buttons to show which have data
        function updateDayButtons() {
            const daysWithData = new Set(data.map(t => t.day));
            document.querySelectorAll('.day-btn').forEach(btn => {
                btn.classList.toggle('has-data', daysWithData.has(btn.dataset.day));
            });
        }
        updateDayButtons();

        // Nav
        document.querySelectorAll('.nav button').forEach(btn => {
            btn.onclick = () => {
                document.querySelectorAll('.nav button').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                $('screen-' + btn.dataset.screen).classList.add('active');
                if (btn.dataset.screen === 'history') renderHistory();
                if (btn.dataset.screen === 'progress') renderProgress();
                if (btn.dataset.screen === 'dashboard') renderDashboard();
                if (btn.dataset.screen === 'exercises') renderExercises();
            };
        });

        // Mode toggle (Lifting / Cardio)
        document.querySelectorAll('.mode-btn').forEach(btn => {
            btn.onclick = () => {
                document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentMode = btn.dataset.mode;
                $('lifting-section').style.display = currentMode === 'lifting' ? 'block' : 'none';
                $('cardio-section').style.display = currentMode === 'cardio' ? 'block' : 'none';
                $('exercises').style.display = currentMode === 'lifting' ? 'block' : 'none';
                $('collapse-all-row').style.display = currentMode === 'lifting' && current ? 'flex' : 'none';
                updateSave();
            };
        });

        // Cardio type selection
        document.querySelectorAll('.cardio-btn').forEach(btn => {
            btn.onclick = () => {
                document.querySelectorAll('.cardio-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                selectedCardioType = btn.dataset.type;
                buildCardioForm();
            };
        });

        function buildCardioForm() {
            if (!selectedCardioType) { $('cardio-form-container').innerHTML = ''; return; }
            const type = CARDIO_TYPES[selectedCardioType];
            cardioData = { type: selectedCardioType, duration: '', notes: '' };

            let html = '<div class="cardio-form">';
            html += '<div class="cardio-field" style="margin-bottom:0.75rem;"><label>Duur (min)</label><input type="text" inputmode="numeric" id="cardio-duration" placeholder="30" style="font-size:1.25rem;"></div>';
            html += '<div class="cardio-field"><label>Notities (optioneel)</label><textarea class="notes-input" id="cardio-notes" placeholder=""></textarea></div>';
            html += '<div style="font-size:0.7rem;color:var(--text3);margin-top:0.5rem;">üí° Kcal en hartslag komen via Apple Health import</div>';
            html += '</div>';

            $('cardio-form-container').innerHTML = html;

            // Event listeners
            $('cardio-duration').oninput = e => { cardioData.duration = e.target.value; updateSave(); };
            $('cardio-notes').oninput = e => { cardioData.notes = e.target.value; };

            updateSave();
        }

        // Day selection
        document.querySelectorAll('.day-btn').forEach(btn => {
            btn.onclick = () => {
                document.querySelectorAll('.day-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                selectedDay = btn.dataset.day;
                buildForm();
            };
        });

        // Build form using smart selection
        function buildForm() {
            if (!selectedDay) { exEl.innerHTML = ''; return; }
            const tmpl = SLOT_TEMPLATES[selectedDay];

            current = {
                day: selectedDay,
                lift: tmpl.name,
                exercises: tmpl.slots.map(slot => {
                    // Selecteer oefening voor deze slot
                    const exercise = selectExerciseForSlot(slot);
                    if (!exercise) return null;

                    // Bepaal type
                    const type = exercise.isCheck || exercise.isActivation && exercise.isCheck ? 'check' :
                                 exercise.isTimed || slot.isTimed ? 'timed' : 'weight';

                    // Zoek vorige data voor deze oefening
                    const prev = getPrev(selectedDay, exercise.name);

                    // Basis exercise object
                    const ex = {
                        id: exercise.id,
                        name: exercise.name,
                        pattern: exercise.pattern,
                        sets: slot.sets,
                        reps: slot.reps || null,
                        type: type,
                        hint: exercise.hint || '',
                        role: slot.role,
                        canSwap: slot.role === 'accessory' || slot.role === 'finisher' || slot.role === 'activation',
                        skipped: false,
                        collapsed: globalCollapsed, // Gebruik globale collapsed state
                        notes: ''
                    };

                    // Equipment opties
                    if (exercise.equipment && exercise.equipment.length > 1) {
                        ex.hasEquip = true;
                        ex.equipOptions = exercise.equipment;
                        ex.equip = prev?.equip || '';
                    }

                    // Sets data - altijd leeg starten (clean slate)
                    if (type === 'check') {
                        ex.done = false;
                    } else if (type === 'timed') {
                        ex.setsData = Array(slot.sets).fill().map(() => ({w:'',t:''}));
                    } else {
                        ex.setsData = Array(slot.sets).fill().map(() => ({w:'',r:'',warmup:false}));
                    }
                    console.log('buildForm:', ex.name, 'type:', type, 'setsData:', JSON.stringify(ex.setsData), 'done:', ex.done);

                    return ex;
                }).filter(Boolean)
            };
            trainingCardio = []; // Reset cardio bij nieuwe training
            renderForm();
            $('add-cardio-btn').style.display = 'block';
            $('training-cardio').innerHTML = '';
        }

        // Swap exercise
        function swapExercise(ei, newExerciseId, isOriginal) {
            const ex = current.exercises[ei];
            const newExercise = EXERCISES[newExerciseId];
            if (!newExercise) return;

            if (isOriginal) {
                // Terug naar origineel
                ex.id = ex.originalId;
                ex.name = ex.originalName;
                ex.pattern = ex.originalPattern;
                ex.hint = EXERCISES[ex.originalId]?.hint || '';
                delete ex.originalId;
                delete ex.originalName;
                delete ex.originalPattern;
            } else {
                // Sla origineel op als nog niet gedaan
                if (!ex.originalId) {
                    ex.originalId = ex.id;
                    ex.originalName = ex.name;
                    ex.originalPattern = ex.pattern;
                }
                // Wissel naar nieuwe oefening
                ex.id = newExercise.id;
                ex.name = newExercise.name;
                ex.pattern = newExercise.pattern;
                ex.hint = newExercise.hint || '';
            }

            // Update equipment opties
            const exercise = EXERCISES[ex.id];
            if (exercise?.equipment?.length > 1) {
                ex.hasEquip = true;
                ex.equipOptions = exercise.equipment;
            } else {
                ex.hasEquip = false;
                delete ex.equipOptions;
            }
            ex.equip = '';

            // Reset sets data
            ex.setsData = Array(ex.sets).fill().map(() => ex.type === 'timed' ? {w:'',t:''} : {w:'',r:ex.reps||'',warmup:false});
            renderForm();
        }

        // Move exercise up or down
        function moveExercise(index, direction) {
            const newIndex = index + direction;
            if (newIndex < 0 || newIndex >= current.exercises.length) return;
            const exercises = current.exercises;
            [exercises[index], exercises[newIndex]] = [exercises[newIndex], exercises[index]];
            renderForm();
            updateSave();
        }

        // Reorder exercise (drag and drop)
        function reorderExercise(fromIdx, toIdx) {
            const exercises = current.exercises;
            const [moved] = exercises.splice(fromIdx, 1);
            exercises.splice(toIdx, 0, moved);
            renderForm();
            updateSave();
        }

        // Render form
        function renderForm() {
            let html = '';
            current.exercises.forEach((ex, ei) => {
                const done = ex.skipped ? false : (ex.type === 'check' ? ex.done : ex.setsData?.some(s => s.w || s.t));
                const isCollapsed = ex.collapsed && !ex.skipped;
                const cardClass = (ex.skipped ? 'skipped' : (done ? 'done' : '')) + (isCollapsed ? ' collapsed' : '');
                console.log('renderForm:', ex.name, 'done:', done, 'class:', cardClass, 'setsData:', JSON.stringify(ex.setsData));

                // Summary voor ingeklapte weergave
                let summaryText = '';
                if (!ex.skipped) {
                    if (ex.type === 'check') {
                        summaryText = ex.done ? '‚úì' : '‚óã';
                    } else if (ex.setsData) {
                        const filledSets = ex.setsData.filter(s => s.w || s.t);
                        if (filledSets.length > 0) {
                            if (ex.type === 'timed') {
                                summaryText = filledSets.map(s => `${s.w}√ó${s.t}s`).join(' / ');
                            } else {
                                summaryText = filledSets.filter(s => !s.warmup).map(s => `${s.w}√ó${s.r}`).join(' / ');
                            }
                        } else {
                            summaryText = `${ex.sets}√ó${ex.reps || 'max'} (leeg)`;
                        }
                    }
                }

                const prev = getPrevWithDate(ex.name);
                let prevHtml = '';
                if (prev) {
                    if (prev.ex.type === 'check') {
                        prevHtml = `<div class="ex-prev"><span class="ex-prev-date">${fmtDate(prev.date)}</span> ‚úì</div>`;
                    } else if (prev.ex.sets && prev.ex.sets.length) {
                        const setsStr = prev.ex.sets.map(s => s.warmup ? '' : (prev.ex.type === 'timed' ? `${s.w}√ó${s.t}s` : `${s.w}√ó${s.r}`)).filter(Boolean).join(' / ');
                        prevHtml = `<div class="ex-prev"><span class="ex-prev-date">${fmtDate(prev.date)}</span> ${setsStr}</div>`;
                    }
                }

                const swapHtml = ex.canSwap ? `<button class="swap-btn" data-ei="${ei}">‚áÑ</button>` : '';
                const collapseBtn = !ex.skipped ? `<button class="collapse-btn" data-ei="${ei}">${ex.collapsed ? '‚ñ∂' : '‚ñº'}</button>` : '';
                const exercise = EXERCISES[ex.id];
                const ytBtn = exercise?.yt ? `<a href="https://youtube.com/watch?v=${exercise.yt}" target="_blank" class="yt-btn">‚ñ∂</a>` : '';

                const isFirst = ei === 0;
                const isLast = ei === current.exercises.length - 1;
                const orderBtns = `<span class="order-btns"><button class="order-btn up" data-ei="${ei}" ${isFirst?'disabled':''}>‚ñ≤</button><button class="order-btn down" data-ei="${ei}" ${isLast?'disabled':''}>‚ñº</button></span>`;

                html += `<div class="ex-card ${cardClass}" data-ei="${ei}" draggable="true">`;
                html += `<div class="ex-head"><div>${orderBtns}<span class="ex-name">${ex.name}</span>${ytBtn}<span class="ex-btns"><button class="skip-btn ${ex.skipped?'active':''}" data-ei="${ei}">${ex.skipped?'‚è≠Ô∏è Overgeslagen':'Skip'}</button>${swapHtml}${collapseBtn}</span></div><span class="ex-rx">${ex.sets}x${ex.reps||'max'}</span></div>`;
                html += `<div class="ex-summary">${summaryText}</div>`;

                // Body wrapper voor collapse
                html += `<div class="ex-body">`;
                html += `<div class="ex-hint">${ex.hint}</div>${prevHtml}`;

                if (!ex.skipped) {
                    // Equipment selector for applicable exercises
                    if (ex.hasEquip && ex.equipOptions) {
                        html += `<div class="equip-row">`;
                        ex.equipOptions.forEach(eq => {
                            const eqLabel = eq === 'dumbbell' ? 'DB' : eq === 'kettlebell' ? 'KB' : eq === 'barbell' ? 'BB' : eq;
                            html += `<button class="equip-btn ${ex.equip===eq?'active':''}" data-ei="${ei}" data-eq="${eq}">${eqLabel}</button>`;
                        });
                        html += `</div>`;
                    }

                    if (ex.type === 'check') {
                        html += `<div class="check-row"><button class="check-btn ${ex.done?'checked':''}" data-ei="${ei}">${ex.done?'‚úì':''}</button><span>Tik als gedaan</span></div>`;
                    } else if (ex.type === 'timed') {
                        ex.setsData.forEach((s, si) => {
                            html += `<div class="set-row"><span class="set-num">${si+1}:</span><input type="text" inputmode="decimal" class="set-input" data-ei="${ei}" data-si="${si}" data-f="w" placeholder="${ex.phW||'BW'}" value="${s.w||''}"><span class="set-unit">kg</span><input type="text" inputmode="numeric" class="set-input" data-ei="${ei}" data-si="${si}" data-f="t" placeholder="${ex.phT||''}" value="${s.t||''}"><span class="set-unit">sec</span></div>`;
                        });
                    } else {
                        ex.setsData.forEach((s, si) => {
                            html += `<div class="set-row"><span class="set-num">${si+1}:</span><input type="text" inputmode="decimal" class="set-input ${s.warmup?'warmup':''}" data-ei="${ei}" data-si="${si}" data-f="w" placeholder="${ex.ph||''}" value="${s.w||''}"><span class="set-unit">kg</span><input type="text" inputmode="numeric" class="set-input ${s.warmup?'warmup':''}" data-ei="${ei}" data-si="${si}" data-f="r" placeholder="${ex.reps||''}" value="${s.r||''}"><span class="set-unit">reps</span><button class="warmup-btn ${s.warmup?'active':''}" data-ei="${ei}" data-si="${si}">w-up</button></div>`;
                        });
                        html += `<button class="add-btn" data-ei="${ei}">+</button>`;
                    }
                }

                // Notes field
                html += `<textarea class="notes-input" data-ei="${ei}" placeholder="Notities...">${ex.notes||''}</textarea>`;
                html += '</div></div>'; // close ex-body and ex-card
            });

            // Add exercise button
            html += `<button class="add-ex-btn" id="add-ex-trigger">‚ûï Oefening toevoegen</button>`;

            exEl.innerHTML = html;
            
            // Listeners
            exEl.querySelectorAll('.set-input').forEach(inp => {
                inp.oninput = () => { 
                    // Only allow numbers, decimal point, and BW
                    let val = inp.value.toUpperCase();
                    if (val !== 'BW' && val !== 'B') {
                        val = val.replace(/[^0-9.,]/g, '').replace(',', '.');
                    }
                    inp.value = val;
                    current.exercises[+inp.dataset.ei].setsData[+inp.dataset.si][inp.dataset.f] = val; 
                    updateSave(); 
                };
                inp.onfocus = () => inp.select();
            });
            exEl.querySelectorAll('.check-btn').forEach(btn => {
                btn.onclick = () => { current.exercises[+btn.dataset.ei].done = !current.exercises[+btn.dataset.ei].done; renderForm(); };
            });
            exEl.querySelectorAll('.warmup-btn').forEach(btn => {
                btn.onclick = () => { current.exercises[+btn.dataset.ei].setsData[+btn.dataset.si].warmup = !current.exercises[+btn.dataset.ei].setsData[+btn.dataset.si].warmup; renderForm(); };
            });
            exEl.querySelectorAll('.add-btn').forEach(btn => {
                btn.onclick = () => { const ex = current.exercises[+btn.dataset.ei]; ex.setsData.push({w:'',r:ex.reps||'',warmup:false}); renderForm(); };
            });
            exEl.querySelectorAll('.skip-btn').forEach(btn => {
                btn.onclick = () => { current.exercises[+btn.dataset.ei].skipped = !current.exercises[+btn.dataset.ei].skipped; renderForm(); };
            });
            exEl.querySelectorAll('.swap-btn').forEach(btn => {
                btn.onclick = e => {
                    e.stopPropagation();
                    document.querySelectorAll('.swap-menu').forEach(m => m.remove());
                    const ei = +btn.dataset.ei;
                    const ex = current.exercises[ei];
                    const currentExercise = EXERCISES[ex.id];
                    const alts = getAlternativesForExercise(currentExercise);
                    const recentIds = getRecentExerciseIds(7);

                    const menu = document.createElement('div');
                    menu.className = 'swap-menu';

                    // Add original option if swapped
                    if (ex.originalId) {
                        const origBtn = document.createElement('button');
                        origBtn.textContent = `‚Ü© ${ex.originalName}`;
                        origBtn.onclick = () => { swapExercise(ei, ex.originalId, true); menu.remove(); };
                        menu.appendChild(origBtn);
                    }

                    // Add alternatives
                    alts.forEach(alt => {
                        if (alt.id === ex.id) return;
                        const altBtn = document.createElement('button');
                        const isRecent = recentIds.includes(alt.id) || recentIds.includes(alt.name);
                        altBtn.textContent = alt.name;
                        altBtn.style.color = isRecent ? 'var(--text3)' : '';
                        altBtn.onclick = () => { swapExercise(ei, alt.id, false); menu.remove(); };
                        menu.appendChild(altBtn);
                    });

                    btn.closest('.ex-head').appendChild(menu);
                    const closeMenu = e2 => { if (!menu.contains(e2.target)) { menu.remove(); document.removeEventListener('click', closeMenu); } };
                    setTimeout(() => document.addEventListener('click', closeMenu), 0);
                };
            });
            exEl.querySelectorAll('.equip-btn').forEach(btn => {
                btn.onclick = () => { current.exercises[+btn.dataset.ei].equip = btn.dataset.eq; renderForm(); };
            });
            exEl.querySelectorAll('.notes-input').forEach(inp => {
                inp.oninput = () => { current.exercises[+inp.dataset.ei].notes = inp.value; };
            });
            // Collapse/expand knop handler
            exEl.querySelectorAll('.collapse-btn').forEach(btn => {
                btn.onclick = (e) => {
                    e.stopPropagation();
                    const ei = +btn.dataset.ei;
                    current.exercises[ei].collapsed = !current.exercises[ei].collapsed;
                    renderForm();
                };
            });

            // Klik op ingeklapte card om uit te klappen
            exEl.querySelectorAll('.ex-card.collapsed').forEach(card => {
                card.onclick = (e) => {
                    // Niet uitklappen als we op een button klikken
                    if (e.target.closest('button')) return;
                    const ei = +card.dataset.ei;
                    current.exercises[ei].collapsed = false;
                    renderForm();
                };
                card.style.cursor = 'pointer';
            });

            // Order buttons (move up/down)
            exEl.querySelectorAll('.order-btn').forEach(btn => {
                btn.onclick = (e) => {
                    e.stopPropagation();
                    const ei = +btn.dataset.ei;
                    const direction = btn.classList.contains('up') ? -1 : 1;
                    moveExercise(ei, direction);
                };
            });

            // Drag and drop handlers
            exEl.querySelectorAll('.ex-card').forEach(card => {
                card.ondragstart = (e) => {
                    card.classList.add('dragging');
                    e.dataTransfer.effectAllowed = 'move';
                    e.dataTransfer.setData('text/plain', card.dataset.ei);
                };
                card.ondragend = () => {
                    card.classList.remove('dragging');
                    exEl.querySelectorAll('.ex-card').forEach(c => c.classList.remove('drag-over'));
                };
                card.ondragover = (e) => {
                    e.preventDefault();
                    const dragging = exEl.querySelector('.dragging');
                    if (dragging !== card) {
                        card.classList.add('drag-over');
                    }
                };
                card.ondragleave = () => {
                    card.classList.remove('drag-over');
                };
                card.ondrop = (e) => {
                    e.preventDefault();
                    card.classList.remove('drag-over');
                    const fromIdx = +e.dataTransfer.getData('text/plain');
                    const toIdx = +card.dataset.ei;
                    if (fromIdx !== toIdx) {
                        reorderExercise(fromIdx, toIdx);
                    }
                };
            });

            // Add exercise button handler
            const addExTrigger = $('add-ex-trigger');
            if (addExTrigger) {
                addExTrigger.onclick = () => openAddExerciseModal();
            }

            // Update collapse-all knop
            updateCollapseAllBtn();
            updateSave();
        }

        function updateCollapseAllBtn() {
            if (!current) { collapseAllRow.style.display = 'none'; return; }
            // Toon knop als er oefeningen zijn (behalve overgeslagen)
            const collapsableExercises = current.exercises.filter(ex => !ex.skipped);
            if (collapsableExercises.length === 0) {
                collapseAllRow.style.display = 'none';
                return;
            }
            collapseAllRow.style.display = 'flex';
            const allCollapsed = collapsableExercises.every(ex => ex.collapsed);
            collapseAllBtn.textContent = allCollapsed ? '‚ñ∂ Alles uitklappen' : '‚ñº Alles inklappen';
        }

        collapseAllBtn.onclick = () => {
            if (!current) return;
            const collapsableExercises = current.exercises.filter(ex => !ex.skipped);
            const allCollapsed = collapsableExercises.every(ex => ex.collapsed);
            // Toggle: als alles ingeklapt is, klap uit. Anders klap in.
            globalCollapsed = !allCollapsed; // Onthoudt voor nieuwe dagen
            current.exercises.forEach(ex => {
                if (!ex.skipped) ex.collapsed = globalCollapsed;
            });
            renderForm();
        };

        // Add Exercise Modal
        const addExModal = $('add-ex-modal');
        const addExSearch = $('add-ex-search');
        const addExResults = $('add-ex-results');

        function openAddExerciseModal() {
            addExModal.style.display = 'block';
            addExSearch.value = '';
            addExSearch.focus();
            renderAddExResults('');
        }

        function closeAddExerciseModal() {
            addExModal.style.display = 'none';
        }

        function renderAddExResults(query) {
            const q = query.toLowerCase().trim();
            let exercises = Object.values(EXERCISES)
                .filter(ex => !ex.isActivation)
                .sort((a, b) => a.name.localeCompare(b.name));

            if (q) {
                exercises = exercises.filter(ex =>
                    ex.name.toLowerCase().includes(q) ||
                    ex.pattern?.toLowerCase().includes(q)
                );
            }

            // Limit to 15 results
            exercises = exercises.slice(0, 15);

            const patternLabels = {
                squat: 'Squat', hinge: 'Hinge', push_horizontal: 'Push H',
                push_vertical: 'Push V', pull_horizontal: 'Pull H',
                pull_vertical: 'Pull V', carry: 'Carry', isolation: 'Isolatie'
            };

            addExResults.innerHTML = exercises.map(ex => `
                <div class="add-ex-item" data-id="${ex.id}">
                    <div>
                        <div class="add-ex-item-name">${ex.name}</div>
                        <div class="add-ex-item-meta">${patternLabels[ex.pattern] || ex.pattern}</div>
                    </div>
                </div>
            `).join('') || '<div style="color:var(--text3);padding:1rem;text-align:center;">Geen resultaten</div>';

            // Add click handlers
            addExResults.querySelectorAll('.add-ex-item').forEach(item => {
                item.onclick = () => {
                    addExerciseFromDatabase(item.dataset.id);
                    closeAddExerciseModal();
                };
            });
        }

        function addExerciseFromDatabase(exerciseId) {
            const exercise = EXERCISES[exerciseId];
            if (!exercise || !current) return;

            const type = exercise.isTimed ? 'timed' : (exercise.isCheck ? 'check' : 'weight');
            const sets = 3;
            const reps = type === 'timed' ? null : 10;

            const newEx = {
                id: exercise.id,
                name: exercise.name,
                pattern: exercise.pattern,
                sets: sets,
                reps: reps,
                type: type,
                hint: exercise.hint || '',
                setsData: type === 'check' ? [] :
                    Array(sets).fill().map(() => type === 'timed' ? {w:'',t:''} : {w:'',r:'',warmup:false}),
                done: false,
                skipped: false,
                collapsed: globalCollapsed,
                notes: '',
                canSwap: true,
                isCustom: false
            };

            // Equipment opties
            if (exercise.equipment?.length > 1) {
                newEx.hasEquip = true;
                newEx.equipOptions = exercise.equipment;
                newEx.equip = '';
            }

            current.exercises.push(newEx);
            renderForm();
            updateSave();
            showToast(`${exercise.name} toegevoegd`);
        }

        function addCustomExercise(name, type) {
            if (!name.trim() || !current) return;

            const sets = type === 'check' ? 1 : 3;
            const reps = type === 'weight' ? 10 : null;

            const newEx = {
                id: 'custom_' + Date.now(),
                name: name.trim(),
                pattern: 'custom',
                sets: sets,
                reps: reps,
                type: type,
                hint: '',
                setsData: type === 'check' ? [] :
                    Array(sets).fill().map(() => type === 'timed' ? {w:'',t:''} : {w:'',r:'',warmup:false}),
                done: false,
                skipped: false,
                collapsed: globalCollapsed,
                notes: '',
                canSwap: false,
                isCustom: true
            };

            current.exercises.push(newEx);
            renderForm();
            updateSave();
            showToast(`${name.trim()} toegevoegd`);
        }

        // Modal event handlers
        $('add-ex-modal-close').onclick = closeAddExerciseModal;
        addExSearch.oninput = () => renderAddExResults(addExSearch.value);
        $('add-ex-custom-add').onclick = () => {
            const name = $('add-ex-custom-name').value;
            const type = $('add-ex-custom-type').value;
            if (name.trim()) {
                addCustomExercise(name, type);
                closeAddExerciseModal();
                $('add-ex-custom-name').value = '';
            }
        };

        // Close modal on backdrop click
        addExModal.onclick = (e) => {
            if (e.target === addExModal) closeAddExerciseModal();
        };

        // Add cardio to training
        $('add-cardio-btn').onclick = () => {
            if (!current) return;
            trainingCardio.push({
                id: Date.now(),
                type: 'running',
                duration: ''
            });
            renderTrainingCardio();
            updateSave();
        };

        function renderTrainingCardio() {
            const el = $('training-cardio');
            if (!trainingCardio.length) { el.innerHTML = ''; return; }

            el.innerHTML = trainingCardio.map((c, ci) => {
                const type = CARDIO_TYPES[c.type];
                return `
                <div class="training-cardio-card">
                    <div class="training-cardio-head">
                        <span class="training-cardio-title">üèÉ Cardio</span>
                        <button class="training-cardio-remove" data-ci="${ci}">‚úï Verwijder</button>
                    </div>
                    <div class="cardio-types" style="margin-bottom:0.75rem;">
                        ${Object.values(CARDIO_TYPES).map(t => `
                            <button class="cardio-btn ${c.type === t.id ? 'active' : ''}" data-ci="${ci}" data-ctype="${t.id}">
                                <span>${t.icon}</span>${t.name}
                            </button>
                        `).join('')}
                    </div>
                    <div class="cardio-field">
                        <label>Duur (min)</label>
                        <input type="text" inputmode="numeric" class="tc-duration" data-ci="${ci}" value="${c.duration}" placeholder="30">
                    </div>
                </div>`;
            }).join('');

            // Event listeners
            el.querySelectorAll('.training-cardio-remove').forEach(btn => {
                btn.onclick = () => {
                    trainingCardio.splice(+btn.dataset.ci, 1);
                    renderTrainingCardio();
                    updateSave();
                };
            });
            el.querySelectorAll('.cardio-btn').forEach(btn => {
                btn.onclick = () => {
                    trainingCardio[+btn.dataset.ci].type = btn.dataset.ctype;
                    renderTrainingCardio();
                };
            });
            el.querySelectorAll('.tc-duration').forEach(inp => {
                inp.oninput = () => { trainingCardio[+inp.dataset.ci].duration = inp.value; updateSave(); };
            });
        }

        function updateSave() {
            if (currentMode === 'cardio') {
                // Cardio mode: need type selected and duration filled
                saveBtn.disabled = !selectedCardioType || !cardioData?.duration;
                saveBtn.textContent = 'Cardio Opslaan';
                return;
            }
            // Lifting mode
            saveBtn.textContent = 'Training Opslaan';
            if (!current) { saveBtn.disabled = true; return; }
            const hasData = current.exercises.some(ex => {
                if (ex.skipped) return true;
                if (ex.type === 'check') return ex.done;
                return ex.setsData?.some(s => s.w || s.t);
            });
            saveBtn.disabled = !hasData;
        }

        // Save
        saveBtn.onclick = () => {
            if (!isValidDate(dateInput.value)) { showToast('Ongeldige datum'); return; }
            if (!isValidTime(timeInput.value)) { showToast('Ongeldige tijd'); return; }

            if (currentMode === 'cardio') {
                // Save cardio session
                if (!selectedCardioType || !cardioData?.duration) return;
                const type = CARDIO_TYPES[selectedCardioType];
                const session = {
                    id: Date.now(),
                    date: toISODate(dateInput.value),
                    startTime: toISOTimestamp(dateInput.value, timeInput.value),
                    isCardio: true,
                    cardioType: selectedCardioType,
                    cardioName: type.name,
                    cardioIcon: type.icon,
                    duration: +cardioData.duration || 0,
                    notes: cardioData.notes || ''
                };
                data.unshift(session);
                save();
                syncToGoogleSheets(session);
                showToast('Cardio opgeslagen!');
                // Reset
                document.querySelectorAll('.cardio-btn').forEach(b => b.classList.remove('active'));
                selectedCardioType = null; cardioData = null;
                $('cardio-form-container').innerHTML = '';
                saveBtn.disabled = true;
                return;
            }

            // Save lifting session
            if (!current) return;
            const training = {
                id: Date.now(),
                date: toISODate(dateInput.value),
                startTime: toISOTimestamp(dateInput.value, timeInput.value),
                day: current.day,
                lift: current.lift,
                week: +$('week-num').textContent,
                exercises: current.exercises.map(ex => {
                    if (ex.type === 'check') return { id: ex.id, name: ex.name, type: 'check', done: ex.done, skipped: ex.skipped, notes: ex.notes };
                    const result = {
                        id: ex.id,
                        name: ex.name,
                        type: ex.type,
                        sets: ex.skipped ? [] : ex.setsData.filter(s => s.w || s.r || s.t).map(s => ex.type === 'timed' ? {w:s.w,t:s.t} : {w:s.w,r:s.r,warmup:s.warmup}),
                        skipped: ex.skipped,
                        notes: ex.notes
                    };
                    if (ex.equip) result.equip = ex.equip;
                    return result;
                }).filter(ex => ex.skipped || (ex.type === 'check' ? ex.done : ex.sets?.length))
            };
            // Add cardio if present
            if (trainingCardio.length) {
                training.cardio = trainingCardio.filter(c => c.duration).map(c => ({
                    type: c.type,
                    name: CARDIO_TYPES[c.type].name,
                    icon: CARDIO_TYPES[c.type].icon,
                    duration: +c.duration
                }));
            }
            // DEBUG: Log wat wordt opgeslagen
            console.log('=== SAVING TRAINING ===');
            console.log('setsData before save:', current.exercises.map(ex => ({name: ex.name, setsData: ex.setsData})));
            console.log('training.exercises after transform:', training.exercises.map(ex => ({name: ex.name, sets: ex.sets})));

            data.unshift(training);
            save();
            syncToGoogleSheets(training);
            showToast('Opgeslagen!');
            updateWeekSelect();
            updateDayButtons();
            document.querySelectorAll('.day-btn').forEach(b => b.classList.remove('active'));
            selectedDay = null; current = null; exEl.innerHTML = ''; saveBtn.disabled = true;
            trainingCardio = []; $('training-cardio').innerHTML = ''; $('add-cardio-btn').style.display = 'none';
        };

        // History
        function renderHistory() {
            const el = $('history');
            if (!data.length) { el.innerHTML = '<div class="empty">Nog geen trainingen</div>'; return; }
            el.innerHTML = data.map((t, i) => {
                // Support both old 'health' and new 'appleHealth'
                const h = t.appleHealth || t.health;
                const healthBadge = h ? ' <span class="health-badge">‚ù§Ô∏è</span>' : '';

                // Cardio session
                if (t.isCardio) {
                    let summary = `${t.duration} min`;
                    const kcal = h?.activeEnergy || h?.totalCal;
                    if (kcal) summary += ` ¬∑ ${Math.round(kcal)} kcal`;
                    return `<div class="hist-card" data-idx="${i}"><div class="hist-top"><span class="hist-date">${fmtDate(t.date)}${healthBadge}</span><span class="hist-day" style="background:rgba(245,158,11,0.2);color:var(--accent);">Cardio</span></div><div class="hist-lift">${t.cardioIcon} ${t.cardioName}</div><div class="hist-summary">${summary}</div></div>`;
                }

                // Lifting session
                const main = t.exercises?.find(e => ['Back Squat','Bench Press','Conventional Deadlift','Push Press'].includes(e.name));
                let top = '-';
                if (main?.sets && main.sets.length) {
                    const ws = main.sets.filter(s => !s.warmup);
                    const last = ws[ws.length-1];
                    if (last) top = last.w + 'kg' + (last.r ? ' x '+last.r : '');
                }
                const cardioBadge = t.cardio?.length ? ' üèÉ' : '';
                return `<div class="hist-card" data-idx="${i}"><div class="hist-top"><span class="hist-date">${fmtDate(t.date)}${healthBadge}${cardioBadge}</span><span class="hist-day ${t.day}">Dag ${t.day}</span></div><div class="hist-lift">${t.lift}</div><div class="hist-summary">Topset: ${top}</div></div>`;
            }).join('');
            el.querySelectorAll('.hist-card').forEach(c => { c.onclick = () => openModal(+c.dataset.idx); });
        }

        // Modal
        function openModal(idx) {
            editIdx = idx;
            editData = JSON.parse(JSON.stringify(data[idx]));

            // DEBUG: Log wat wordt geladen
            console.log('=== LOADING TRAINING IN MODAL ===');
            console.log('Raw data[idx]:', data[idx]);
            console.log('editData.exercises:', editData.exercises?.map(ex => ({name: ex.name, sets: ex.sets})));

            // Support both old 'health' and new 'appleHealth'
            const h = editData.appleHealth || editData.health;

            if (editData.isCardio) {
                // Cardio modal
                $('modal-title').textContent = editData.cardioIcon + ' ' + editData.cardioName;
                let dateInfo = fmtDate(editData.date);
                if (h) {
                    const parts = [];
                    const avgHr = h.avgHeartRate || h.avgHr;
                    const kcal = h.activeEnergy || h.totalCal;
                    if (avgHr) parts.push(`‚ù§Ô∏è ${Math.round(avgHr)} bpm`);
                    if (kcal) parts.push(`üî• ${Math.round(kcal)} kcal`);
                    if (parts.length) dateInfo += '<br><span style="color:var(--accent)">' + parts.join(' ¬∑ ') + '</span>';
                }
                $('modal-date').innerHTML = dateInfo;
                renderCardioModal();
            } else {
                // Lifting modal
                $('modal-title').textContent = editData.lift + ' ‚Äî Dag ' + editData.day;
                let dateInfo = fmtDate(editData.date) + ' | Week ' + editData.week;
                if (h) {
                    const avgHr = h.avgHeartRate || h.avgHr;
                    const maxHr = h.maxHeartRate || h.maxHr;
                    const kcal = h.activeEnergy || h.totalCal;
                    const duration = h.duration;
                    let parts = [];
                    if (avgHr) parts.push(`‚ù§Ô∏è Gem: ${Math.round(avgHr)} bpm`);
                    if (maxHr) parts.push(`Max: ${Math.round(maxHr)} bpm`);
                    if (duration) parts.push(`‚è±Ô∏è ${duration}`);
                    if (kcal) parts.push(`üî• ${Math.round(kcal)} kcal`);
                    if (parts.length) dateInfo += '<br><span style="color:var(--danger)">' + parts.join(' | ') + '</span>';
                }
                $('modal-date').innerHTML = dateInfo;
                renderModal();
            }
            modal.classList.add('show');
        }

        function renderCardioModal() {
            // Support both old 'health' and new 'appleHealth'
            const h = editData.appleHealth || editData.health;

            let html = '<div class="cardio-form">';
            html += `<div class="cardio-field" style="margin-bottom:0.75rem;"><label>Duur</label><div style="font-size:1.5rem;font-weight:600;">${editData.duration} min</div></div>`;
            if (h) {
                const kcal = h.activeEnergy || h.totalCal;
                const avgHr = h.avgHeartRate || h.avgHr;
                const maxHr = h.maxHeartRate || h.maxHr;
                html += '<div class="cardio-row">';
                if (kcal) html += `<div class="cardio-field"><label>Calorie√´n</label><div style="font-size:1.25rem;font-weight:600;color:var(--accent);">${Math.round(kcal)} kcal</div></div>`;
                if (avgHr) html += `<div class="cardio-field"><label>Gem. hartslag</label><div style="font-size:1.25rem;font-weight:600;color:var(--danger);">${Math.round(avgHr)} bpm</div></div>`;
                if (maxHr) html += `<div class="cardio-field"><label>Max. hartslag</label><div style="font-size:1.25rem;font-weight:600;color:var(--danger);">${Math.round(maxHr)} bpm</div></div>`;
                html += '</div>';
            }
            if (editData.notes) {
                html += `<div class="cardio-field"><label>Notities</label><div style="font-size:0.875rem;color:var(--text2);font-style:italic;">${editData.notes}</div></div>`;
            }
            html += '</div>';
            modalBody.innerHTML = html;
        }

        function renderModal() {
            let html = '';
            editData.exercises.forEach((ex, ei) => {
                const cardClass = ex.skipped ? 'skipped' : '';
                html += `<div class="ex-card ${cardClass}"><div class="ex-head"><span class="ex-name">${ex.name}</span>${ex.equip ? `<span class="ex-rx">${ex.equip}</span>` : ''}</div>`;
                if (ex.skipped) {
                    html += `<div style="color:var(--skip);font-size:0.75rem;">‚è≠Ô∏è Overgeslagen</div>`;
                } else if (ex.type === 'check') {
                    html += `<div class="check-row"><button class="check-btn ${ex.done?'checked':''}" data-mei="${ei}">${ex.done?'‚úì':''}</button><span>${ex.done?'Gedaan':'Niet gedaan'}</span></div>`;
                } else if (ex.sets && ex.sets.length) {
                    ex.sets.forEach((s, si) => {
                        if (ex.type === 'timed') {
                            html += `<div class="set-row"><span class="set-num">${si+1}:</span><input type="text" inputmode="decimal" class="set-input" data-mei="${ei}" data-msi="${si}" data-mf="w" value="${s.w||''}"><span class="set-unit">kg</span><input type="text" inputmode="numeric" class="set-input" data-mei="${ei}" data-msi="${si}" data-mf="t" value="${s.t||''}"><span class="set-unit">sec</span></div>`;
                        } else {
                            html += `<div class="set-row"><span class="set-num">${si+1}:</span><input type="text" inputmode="decimal" class="set-input ${s.warmup?'warmup':''}" data-mei="${ei}" data-msi="${si}" data-mf="w" value="${s.w||''}"><span class="set-unit">kg</span><input type="text" inputmode="numeric" class="set-input ${s.warmup?'warmup':''}" data-mei="${ei}" data-msi="${si}" data-mf="r" value="${s.r||''}"><span class="set-unit">reps</span><button class="warmup-btn ${s.warmup?'active':''}" data-mei="${ei}" data-msi="${si}">w-up</button></div>`;
                        }
                    });
                }
                if (ex.notes) {
                    html += `<div style="font-size:0.75rem;color:var(--text2);margin-top:0.5rem;font-style:italic;">${ex.notes}</div>`;
                }
                html += '</div>';
            });

            // Show cardio if present in training
            if (editData.cardio?.length) {
                html += '<div style="margin-top:1rem;padding-top:1rem;border-top:1px solid var(--border);">';
                html += '<div style="font-weight:600;color:var(--accent);margin-bottom:0.5rem;">üèÉ Cardio</div>';
                editData.cardio.forEach(c => {
                    html += `<div style="background:var(--bg3);padding:0.5rem;border-radius:0.375rem;margin-bottom:0.5rem;">`;
                    html += `<span style="font-weight:600;">${c.icon} ${c.name}</span> ¬∑ ${c.duration} min`;
                    html += '</div>';
                });
                html += '</div>';
            }

            modalBody.innerHTML = html;
            
            modalBody.querySelectorAll('.set-input').forEach(inp => {
                inp.oninput = () => { 
                    // Only allow numbers, decimal point, and BW
                    let val = inp.value.toUpperCase();
                    if (val !== 'BW' && val !== 'B') {
                        val = val.replace(/[^0-9.,]/g, '').replace(',', '.');
                    }
                    inp.value = val;
                    editData.exercises[+inp.dataset.mei].sets[+inp.dataset.msi][inp.dataset.mf] = val; 
                };
                inp.onfocus = () => inp.select();
            });
            modalBody.querySelectorAll('.check-btn').forEach(btn => {
                btn.onclick = () => { editData.exercises[+btn.dataset.mei].done = !editData.exercises[+btn.dataset.mei].done; renderModal(); };
            });
            modalBody.querySelectorAll('.warmup-btn').forEach(btn => {
                btn.onclick = () => { editData.exercises[+btn.dataset.mei].sets[+btn.dataset.msi].warmup = !editData.exercises[+btn.dataset.mei].sets[+btn.dataset.msi].warmup; renderModal(); };
            });
        }

        function closeModal() { modal.classList.remove('show'); editIdx = null; editData = null; }
        $('modal-close').onclick = closeModal;
        $('btn-cancel').onclick = closeModal;
        $('btn-save').onclick = () => { data[editIdx] = editData; save(); showToast('Gewijzigd!'); closeModal(); renderHistory(); };
        $('btn-delete').onclick = () => {
            if (confirm('Training verwijderen?\n\n' + editData.lift + ' ‚Äî ' + fmtDate(editData.date))) {
                data.splice(editIdx, 1);
                save();
                showToast('Verwijderd!');
                closeModal();
                renderHistory();
                updateWeekSelect();
                updateDayButtons();
            }
        };
        $('btn-ics').onclick = () => {
            if (!editData) return;
            exportICS('single', editData);
        };
        modal.onclick = e => { if (e.target === modal) closeModal(); };

        // Progress
        document.querySelectorAll('.prog-btn').forEach(btn => {
            btn.onclick = () => { document.querySelectorAll('.prog-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active'); renderProgress(btn.dataset.lift); };
        });

        function renderProgress(lift = 'Back Squat') {
            const el = $('progress');
            const rows = data.filter(t => t.exercises.some(e => e.name === lift && !e.skipped)).map(t => {
                const ex = t.exercises.find(e => e.name === lift);
                const ws = ex.sets?.filter(s => !s.warmup) || [];
                const max = ws.length ? Math.max(...ws.map(s => parseFloat(s.w)||0)) : 0;
                return { date: t.date, val: max };
            }).reverse().slice(-8);
            if (!rows.length) { el.innerHTML = '<div class="empty">Geen data</div>'; return; }
            const max = Math.max(...rows.map(r => r.val));
            el.innerHTML = rows.map(r => `<div class="prog-row"><span class="prog-date">${r.date.slice(5)}</span><div class="prog-bar-bg"><div class="prog-bar" style="width:${(r.val/max)*100}%"></div></div><span class="prog-val">${r.val}</span></div>`).join('');
        }

        // Dashboard
        function renderDashboard() {
            renderDashWeek();
            renderDashNext();
            renderDashStreak();
            renderDashLifts();
        }

        function renderDashWeek() {
            const el = $('dash-week');
            const now = new Date();
            const dayOfWeek = now.getDay(); // 0 = zondag
            const monday = new Date(now);
            monday.setDate(now.getDate() - (dayOfWeek === 0 ? 6 : dayOfWeek - 1));
            monday.setHours(0,0,0,0);

            const days = ['Ma','Di','Wo','Do','Vr','Za','Zo'];
            let html = '';

            for (let i = 0; i < 7; i++) {
                const d = new Date(monday);
                d.setDate(monday.getDate() + i);
                const dateStr = d.toISOString().split('T')[0];
                const isToday = d.toDateString() === now.toDateString();
                const sessions = data.filter(t => t.date === dateStr);
                const trained = sessions.length > 0;
                let statusText = '¬∑';
                if (trained) {
                    statusText = sessions.map(s => s.isCardio ? s.cardioIcon : '‚úì' + s.day).join(' ');
                }

                html += `<div class="dash-week-day ${isToday ? 'today' : ''} ${trained ? 'trained' : ''}">
                    <div class="day-label">${days[i]}</div>
                    <div class="day-status">${statusText}</div>
                </div>`;
            }
            el.innerHTML = html;
        }

        function renderDashNext() {
            const el = $('dash-next');
            // Bepaal welke dag als volgende aan de beurt is (alleen lifting, niet cardio)
            const dayOrder = ['A', 'B', 'C', 'D'];
            const lastTraining = data.find(t => !t.isCardio);
            let nextDay = 'A';

            if (lastTraining && lastTraining.day) {
                const lastDayIdx = dayOrder.indexOf(lastTraining.day);
                nextDay = dayOrder[(lastDayIdx + 1) % 4];
            }

            const template = SLOT_TEMPLATES[nextDay];
            const lastOfThisDay = data.find(t => t.day === nextDay);

            let topset = '-';
            if (lastOfThisDay) {
                const mainLift = lastOfThisDay.exercises.find(e => e.name === template.name || EXERCISES[template.mainLift]?.name === e.name);
                if (mainLift?.sets) {
                    const ws = mainLift.sets.filter(s => !s.warmup);
                    const last = ws[ws.length - 1];
                    if (last) topset = last.w + 'kg √ó ' + last.r;
                }
            }

            el.innerHTML = `
                <div class="dash-next-main">Dag ${nextDay} ‚Äî ${template.name}</div>
                <div class="dash-next-sub">
                    ${lastOfThisDay ? `Laatste: ${fmtDate(lastOfThisDay.date)} | Topset: ${topset}` : 'Nog niet gedaan'}
                </div>
                <button class="dash-next-btn" onclick="document.querySelector('[data-day=${nextDay}]').click(); document.querySelector('[data-screen=new]').click();">
                    Start training ‚Üí
                </button>
            `;
        }

        function renderDashStreak() {
            const el = $('dash-streak');
            // Bereken hoeveel weken er achter elkaar getraind is (minstens 1 training per week)
            const weeks = {};
            data.forEach(t => {
                const d = new Date(t.date);
                const weekStart = new Date(d);
                weekStart.setDate(d.getDate() - d.getDay() + 1);
                const weekKey = weekStart.toISOString().split('T')[0];
                weeks[weekKey] = true;
            });

            // Tel streak vanaf nu terug
            let streak = 0;
            const now = new Date();
            const currentWeekStart = new Date(now);
            currentWeekStart.setDate(now.getDate() - (now.getDay() === 0 ? 6 : now.getDay() - 1));
            currentWeekStart.setHours(0,0,0,0);

            for (let i = 0; i < 52; i++) {
                const weekCheck = new Date(currentWeekStart);
                weekCheck.setDate(currentWeekStart.getDate() - (i * 7));
                const weekKey = weekCheck.toISOString().split('T')[0];
                if (weeks[weekKey]) {
                    streak++;
                } else if (i > 0) {
                    break; // Alleen stoppen als het niet de huidige week is
                }
            }

            const goal = 12;
            const pct = Math.min(100, (streak / goal) * 100);

            el.innerHTML = `
                <div class="dash-streak-bar">
                    <div class="dash-streak-fill" style="width: ${pct}%"></div>
                </div>
                <div class="dash-streak-text"><strong>${streak}</strong> van ${goal} weken consistent</div>
            `;
        }

        function renderDashLifts() {
            const el = $('dash-lifts');
            const mainLifts = [
                { name: 'Back Squat', label: 'Squat' },
                { name: 'Bench Press', label: 'Bench' },
                { name: 'Conventional Deadlift', label: 'Deadlift' },
                { name: 'Push Press', label: 'Press' }
            ];

            let html = '';
            mainLifts.forEach(lift => {
                // Haal laatste 4 topsets op
                const trainings = data.filter(t => t.exercises.some(e => e.name === lift.name && !e.skipped));
                const vals = trainings.slice(0, 4).map(t => {
                    const ex = t.exercises.find(e => e.name === lift.name);
                    const ws = ex.sets?.filter(s => !s.warmup) || [];
                    return ws.length ? Math.max(...ws.map(s => parseFloat(s.w) || 0)) : 0;
                }).reverse();

                // Bepaal trend
                let trend = 'same';
                let trendIcon = '‚Üí';
                if (vals.length >= 2) {
                    const last = vals[vals.length - 1];
                    const prev = vals[vals.length - 2];
                    if (last > prev) { trend = 'up'; trendIcon = '‚Üë'; }
                    else if (last < prev) { trend = 'down'; trendIcon = '‚Üì'; }
                }

                html += `<div class="dash-lift-row">
                    <span class="dash-lift-name">${lift.label}</span>
                    <div class="dash-lift-vals">
                        ${vals.length ? vals.map((v, i) => `<span class="dash-lift-val ${i === vals.length - 1 ? 'latest' : ''}">${v}</span>`).join('') : '<span class="dash-lift-val">-</span>'}
                    </div>
                    <span class="dash-lift-trend ${trend}">${trendIcon}</span>
                </div>`;
            });

            el.innerHTML = html;
        }

        // Exercises Browser
        let exerciseFilter = 'all';
        let exerciseSearch = '';

        function renderExercises() {
            const grid = $('ex-grid');
            const countEl = $('ex-count');

            // Filter en zoek
            let exercises = Object.values(EXERCISES);

            if (exerciseFilter !== 'all') {
                exercises = exercises.filter(ex => ex.pattern === exerciseFilter);
            }

            if (exerciseSearch) {
                const search = exerciseSearch.toLowerCase();
                exercises = exercises.filter(ex =>
                    ex.name.toLowerCase().includes(search) ||
                    ex.pattern.toLowerCase().includes(search) ||
                    ex.hint?.toLowerCase().includes(search) ||
                    ex.muscles?.primary?.some(m => m.toLowerCase().includes(search))
                );
            }

            // Sorteer alfabetisch
            exercises.sort((a, b) => a.name.localeCompare(b.name));

            countEl.textContent = `${exercises.length} oefeningen`;

            // Pattern labels
            const patternLabels = {
                squat: 'Squat',
                hinge: 'Hinge',
                push_horizontal: 'Push H',
                push_vertical: 'Push V',
                pull_horizontal: 'Pull H',
                pull_vertical: 'Pull V',
                carry: 'Carry',
                activation: 'Activatie',
                isolation: 'Isolatie'
            };

            // Equipment labels
            const equipLabels = {
                barbell: 'BB',
                dumbbell: 'DB',
                kettlebell: 'KB',
                cable: 'Kabel',
                machine: 'Machine',
                bodyweight: 'BW',
                band: 'Band'
            };

            let html = '';
            exercises.forEach(ex => {
                const ytLink = ex.yt ? `https://youtube.com/watch?v=${ex.yt}` : '#';
                const patternLabel = patternLabels[ex.pattern] || ex.pattern;
                const equipTags = ex.equipment?.map(e => `<span class="ex-tile-tag equipment">${equipLabels[e] || e}</span>`).join('') || '';
                const muscleTags = ex.muscles?.primary?.slice(0, 2).map(m => `<span class="ex-tile-tag muscle">${m}</span>`).join('') || '';
                const unilateralTag = ex.unilateral ? '<span class="ex-tile-tag unilateral">Unilateral</span>' : '';
                const mainLiftTag = ex.isMainLift ? '<span class="ex-tile-tag pattern">‚≠ê Main Lift</span>' : '';

                html += `
                <div class="ex-tile">
                    <a href="${ytLink}" target="_blank" class="ex-tile-yt" ${!ex.yt ? 'style="background:#333;pointer-events:none"' : ''}>‚ñ∂</a>
                    <div class="ex-tile-info">
                        <div class="ex-tile-name">${ex.name}</div>
                        <div class="ex-tile-meta">
                            <span class="ex-tile-tag pattern">${patternLabel}</span>
                            ${mainLiftTag}
                            ${equipTags}
                            ${muscleTags}
                            ${unilateralTag}
                        </div>
                        ${ex.hint ? `<div class="ex-tile-hint">${ex.hint}</div>` : ''}
                    </div>
                </div>`;
            });

            grid.innerHTML = html || '<div class="empty">Geen oefeningen gevonden</div>';
        }

        // Exercises filter handlers
        document.querySelectorAll('.ex-filter').forEach(btn => {
            btn.onclick = () => {
                document.querySelectorAll('.ex-filter').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                exerciseFilter = btn.dataset.pattern;
                renderExercises();
            };
        });

        // Exercises search handler
        $('ex-search').oninput = (e) => {
            exerciseSearch = e.target.value;
            renderExercises();
        };

        // ICS Calendar Export
        function generateICS(trainings) {
            if (!trainings.length) return null;

            let ics = `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//LiftLog//Training//NL
CALSCALE:GREGORIAN
METHOD:PUBLISH
X-WR-CALNAME:LiftLog Trainingen
`;

            trainings.forEach(t => {
                const dateClean = t.date.replace(/-/g, '');
                const uid = `liftlog-${dateClean}-${t.day}@petermrman`;

                // Bouw beschrijving
                let desc = `Week ${t.week} | RPE 6-7\\n\\nOefeningen:\\n`;
                t.exercises.forEach(ex => {
                    if (ex.skipped) {
                        desc += `- ${ex.name}: overgeslagen\\n`;
                    } else if (ex.type === 'check') {
                        desc += `- ${ex.name}: ${ex.done ? '‚úì' : '‚óã'}\\n`;
                    } else if (ex.sets && ex.sets.length) {
                        const setsStr = ex.sets
                            .filter(s => !s.warmup)
                            .map(s => ex.type === 'timed' ? `${s.w}√ó${s.t}s` : `${s.w}√ó${s.r}`)
                            .join(', ');
                        desc += `- ${ex.name}: ${setsStr}\\n`;
                    }
                });

                // Escape special characters voor ICS
                desc = desc.replace(/,/g, '\\,').replace(/;/g, '\\;');

                ics += `BEGIN:VEVENT
UID:${uid}
DTSTART:${dateClean}T100000
DTEND:${dateClean}T110000
SUMMARY:üí™ Dag ${t.day} - ${t.lift}
DESCRIPTION:${desc}
STATUS:CONFIRMED
END:VEVENT
`;
            });

            ics += 'END:VCALENDAR';
            return ics;
        }

        function exportICS(filter, singleTraining) {
            let trainings;
            const now = new Date();

            if (filter === 'single' && singleTraining) {
                trainings = [singleTraining];
            } else {
                trainings = [...data];
                if (filter === 'week') {
                    const weekStart = new Date(now);
                    weekStart.setDate(now.getDate() - (now.getDay() === 0 ? 6 : now.getDay() - 1));
                    weekStart.setHours(0,0,0,0);
                    const weekEnd = new Date(weekStart);
                    weekEnd.setDate(weekStart.getDate() + 7);
                    trainings = trainings.filter(t => {
                        const d = new Date(t.date);
                        return d >= weekStart && d < weekEnd;
                    });
                } else if (filter === 'month') {
                    const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
                    const monthEnd = new Date(now.getFullYear(), now.getMonth() + 1, 0);
                    trainings = trainings.filter(t => {
                        const d = new Date(t.date);
                        return d >= monthStart && d <= monthEnd;
                    });
                }
            }

            if (!trainings.length) {
                showToast('Geen trainingen gevonden');
                return;
            }

            const ics = generateICS(trainings);
            const blob = new Blob([ics], { type: 'text/calendar;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filter === 'single' && singleTraining
                ? `liftlog_${singleTraining.date}_dag${singleTraining.day}.ics`
                : `liftlog_${filter || 'all'}_${now.toISOString().split('T')[0]}.ics`;
            a.click();
            URL.revokeObjectURL(url);
            showToast('Kalender ge√´xporteerd!');
        }

        // ICS Export button handlers
        $('ics-export-all').onclick = () => exportICS('all');
        $('ics-export-month').onclick = () => exportICS('month');
        $('ics-export-week').onclick = () => exportICS('week');

        // Apple Health CSV Import - Drop zone
        const dropZone = $('health-drop-zone');

        function handleHealthFile(file) {
            if (!file || !file.name.endsWith('.csv')) {
                $('health-import-result').innerHTML = '<span style="color:var(--danger)">Selecteer een CSV bestand</span>';
                return;
            }
            const reader = new FileReader();
            reader.onload = ev => {
                try {
                    const result = parseHealthCSV(ev.target.result);
                    $('health-import-result').innerHTML = result.html;
                    if (result.matched > 0) {
                        save();
                        showToast(`${result.matched} training(en) gekoppeld!`);
                    }
                } catch(err) {
                    console.error(err);
                    $('health-import-result').innerHTML = `<span style="color:var(--danger)">Fout: ${err.message}</span>`;
                }
            };
            reader.readAsText(file);
        }

        // Click to select
        dropZone.onclick = () => $('health-file-input').click();
        $('health-file-input').onchange = e => {
            handleHealthFile(e.target.files[0]);
            e.target.value = '';
        };

        // Drag and drop
        dropZone.ondragover = e => { e.preventDefault(); dropZone.classList.add('drag-over'); };
        dropZone.ondragleave = e => { e.preventDefault(); dropZone.classList.remove('drag-over'); };
        dropZone.ondrop = e => {
            e.preventDefault();
            dropZone.classList.remove('drag-over');
            const file = e.dataTransfer.files[0];
            handleHealthFile(file);
        };

        // Render health data overview
        function renderHealthOverview() {
            const container = $('health-overview');
            if (!container) return;

            // Find trainings with health data (support both old 'health' and new 'appleHealth')
            const withHealth = data.filter(t => {
                const h = t.appleHealth || t.health;
                return h && (h.avgHeartRate || h.avgHr || h.activeEnergy || h.totalCal);
            });

            if (withHealth.length === 0) {
                container.innerHTML = '';
                return;
            }

            let html = '<div style="border-top:1px solid var(--border);padding-top:0.75rem;margin-top:0.5rem;">';
            html += `<div style="font-weight:600;margin-bottom:0.5rem;">‚ù§Ô∏è ${withHealth.length} training(en) met health data</div>`;
            html += '<div style="font-size:0.75rem;">';

            withHealth.slice(0, 10).forEach(t => {
                const h = t.appleHealth || t.health;
                let stats = [];
                const avgHr = h.avgHeartRate || h.avgHr;
                const kcal = h.activeEnergy || h.totalCal;
                if (avgHr) stats.push(`‚ù§Ô∏è ${Math.round(avgHr)} bpm`);
                if (kcal) stats.push(`üî• ${Math.round(kcal)} kcal`);
                html += `<div style="display:flex;justify-content:space-between;padding:0.25rem 0;border-bottom:1px solid var(--border);">`;
                html += `<span>${fmtDate(t.date)} ${t.lift || t.day}</span>`;
                html += `<span style="color:var(--text3);">${stats.join(' ¬∑ ')}</span>`;
                html += `</div>`;
            });

            if (withHealth.length > 10) {
                html += `<div style="color:var(--text3);padding-top:0.25rem;">...en ${withHealth.length - 10} meer</div>`;
            }

            html += '</div></div>';
            container.innerHTML = html;
        }

        // ===========================================
        // APPLE HEALTH IMPORT WITH FUZZY MATCHING UI
        // ===========================================

        let healthMatchQueue = [];
        let healthMatchIndex = 0;
        let healthMatchResults = { matched: 0, skipped: 0, total: 0 };

        function parseHealthCSV(csvText) {
            const lines = csvText.split('\n').filter(l => l.trim());
            if (lines.length < 2) throw new Error('Leeg bestand');

            // Parse header to find column indices
            const headerLine = lines[0];
            const cols = parseCSVLine(headerLine).map(c => c.toLowerCase().trim());

            // Find relevant columns (flexible matching for Auto Health Export)
            const findCol = (...names) => cols.findIndex(c => names.some(n => c.includes(n)));

            const typeCol = findCol('workout type', 'type', 'activity');
            const startCol = findCol('start');
            const endCol = findCol('end');
            const durationCol = findCol('duration', 'duur');
            const avgHrCol = findCol('avg. heart rate', 'avg heart', 'average heart', 'gem hartslag');
            const maxHrCol = findCol('max. heart rate', 'max heart', 'maximum heart', 'max hartslag');
            const activeCalCol = findCol('active energy', 'active cal', 'actieve energie');

            // Fallback: use 'start' or first date-like column
            const dateCol = startCol >= 0 ? startCol : findCol('date', 'datum');
            if (dateCol === -1) throw new Error('Geen datum/start kolom gevonden');

            // Parse workouts
            const workouts = [];
            for (let i = 1; i < lines.length; i++) {
                const values = parseCSVLine(lines[i]);
                if (values.length <= dateCol) continue;

                const startStr = values[dateCol];
                const startDate = parseHealthDate(startStr);
                if (!startDate) continue;

                const type = typeCol >= 0 ? values[typeCol] || '' : '';

                // Filter for strength training (case insensitive)
                const typeLower = type.toLowerCase();
                if (type && !typeLower.includes('strength') && !typeLower.includes('training') && !typeLower.includes('weight') && !typeLower.includes('functional')) {
                    continue;
                }

                // Parse end time
                let endDate = null;
                if (endCol >= 0 && values[endCol]) {
                    endDate = parseHealthDate(values[endCol]);
                }

                // Parse duration (can be "00:57:33" or minutes as number)
                let durationStr = durationCol >= 0 ? values[durationCol] || '' : '';

                workouts.push({
                    startTime: startDate,
                    endTime: endDate,
                    duration: durationStr,
                    type: type || 'Strength Training',
                    avgHeartRate: avgHrCol >= 0 ? parseFloat(values[avgHrCol]) || 0 : 0,
                    maxHeartRate: maxHrCol >= 0 ? parseFloat(values[maxHrCol]) || 0 : 0,
                    activeEnergy: activeCalCol >= 0 ? parseFloat(values[activeCalCol]) || 0 : 0
                });
            }

            if (workouts.length === 0) throw new Error('Geen strength workouts gevonden in CSV');

            // Find potential matches for each workout
            const BUFFER_MS = 60 * 60 * 1000; // 60 minutes

            healthMatchQueue = workouts.map(workout => {
                // Find best match
                const matches = data
                    .map((t, idx) => {
                        if (!t.startTime || t.isCardio) return null;
                        const trainingTime = new Date(t.startTime).getTime();
                        const workoutTime = workout.startTime.getTime();
                        const diff = Math.abs(trainingTime - workoutTime);
                        if (diff <= BUFFER_MS) {
                            return { training: t, index: idx, diff };
                        }
                        return null;
                    })
                    .filter(Boolean)
                    .sort((a, b) => a.diff - b.diff);

                // Also find same-day trainings as alternatives
                const sameDay = data
                    .map((t, idx) => {
                        if (!t.date || t.isCardio) return null;
                        const workoutDateStr = `${workout.startTime.getFullYear()}-${String(workout.startTime.getMonth()+1).padStart(2,'0')}-${String(workout.startTime.getDate()).padStart(2,'0')}`;
                        if (t.date === workoutDateStr) {
                            return { training: t, index: idx };
                        }
                        return null;
                    })
                    .filter(Boolean);

                return {
                    workout,
                    bestMatch: matches[0] || null,
                    alternatives: sameDay
                };
            });

            healthMatchIndex = 0;
            healthMatchResults = { matched: 0, skipped: 0, total: workouts.length };

            // Start interactive matching
            if (healthMatchQueue.length > 0) {
                showHealthMatchModal();
            }

            return { matched: 0, html: `<div>üîÑ ${workouts.length} workout(s) gevonden, bezig met matchen...</div>` };
        }

        function showHealthMatchModal() {
            if (healthMatchIndex >= healthMatchQueue.length) {
                // Done matching
                finishHealthMatching();
                return;
            }

            const item = healthMatchQueue[healthMatchIndex];
            const workout = item.workout;
            const overlay = $('health-match-overlay');

            // Progress
            $('health-match-progress').textContent = `Workout ${healthMatchIndex + 1} van ${healthMatchQueue.length}`;

            // Time info
            const startTime = workout.startTime;
            const timeStr = `${startTime.getDate()}-${startTime.getMonth()+1}-${startTime.getFullYear()} ${String(startTime.getHours()).padStart(2,'0')}:${String(startTime.getMinutes()).padStart(2,'0')}`;
            $('health-match-time').textContent = timeStr;

            // Stats
            let statsHtml = '';
            if (workout.duration) {
                statsHtml += `<div class="health-match-stat"><span class="health-match-stat-label">Duur</span><span class="health-match-stat-value">‚è±Ô∏è ${workout.duration}</span></div>`;
            }
            if (workout.avgHeartRate) {
                statsHtml += `<div class="health-match-stat"><span class="health-match-stat-label">Gem. hartslag</span><span class="health-match-stat-value">‚ù§Ô∏è ${Math.round(workout.avgHeartRate)} bpm</span></div>`;
            }
            if (workout.maxHeartRate) {
                statsHtml += `<div class="health-match-stat"><span class="health-match-stat-label">Max. hartslag</span><span class="health-match-stat-value">üíì ${Math.round(workout.maxHeartRate)} bpm</span></div>`;
            }
            if (workout.activeEnergy) {
                statsHtml += `<div class="health-match-stat"><span class="health-match-stat-label">Actieve energie</span><span class="health-match-stat-value">üî• ${Math.round(workout.activeEnergy)} kcal</span></div>`;
            }
            $('health-match-stats').innerHTML = statsHtml;

            // Training match
            const trainingDiv = $('health-match-training');
            const selectEl = $('health-match-select');

            if (item.bestMatch) {
                const t = item.bestMatch.training;
                trainingDiv.innerHTML = `
                    <div class="health-match-training-label">Koppelen aan</div>
                    <div class="health-match-training-name">${t.lift || 'Training'} ‚Äî Dag ${t.day}</div>
                    <div class="health-match-training-date">${fmtDate(t.date)} ${t.startTime ? new Date(t.startTime).toLocaleTimeString('nl-NL', {hour:'2-digit', minute:'2-digit'}) : ''}</div>
                `;
                trainingDiv.style.display = 'block';
                selectEl.style.display = 'none';
            } else if (item.alternatives.length > 0) {
                trainingDiv.innerHTML = `
                    <div class="health-match-training-label">Geen exacte match</div>
                    <div class="health-match-training-name" style="color:var(--text2)">Kies een training van dezelfde dag</div>
                `;
                trainingDiv.style.display = 'block';

                // Show select with alternatives
                selectEl.innerHTML = '<option value="">-- Selecteer training --</option>' +
                    item.alternatives.map(alt =>
                        `<option value="${alt.index}">${alt.training.lift || 'Training'} ‚Äî Dag ${alt.training.day} (${fmtDate(alt.training.date)})</option>`
                    ).join('');
                selectEl.style.display = 'block';
            } else {
                trainingDiv.innerHTML = `
                    <div class="health-match-training-label" style="color:var(--danger)">Geen match gevonden</div>
                    <div class="health-match-training-name" style="color:var(--text2)">Geen training op deze datum</div>
                `;
                trainingDiv.style.display = 'block';
                selectEl.style.display = 'none';
            }

            overlay.style.display = 'flex';
        }

        function applyHealthMatch(trainingIndex) {
            const item = healthMatchQueue[healthMatchIndex];
            const workout = item.workout;
            const training = data[trainingIndex];

            if (training) {
                // Save as appleHealth object
                training.appleHealth = {
                    startTime: workout.startTime.toISOString(),
                    endTime: workout.endTime ? workout.endTime.toISOString() : null,
                    duration: workout.duration,
                    avgHeartRate: workout.avgHeartRate,
                    maxHeartRate: workout.maxHeartRate,
                    activeEnergy: workout.activeEnergy,
                    matchedAt: new Date().toISOString()
                };
                healthMatchResults.matched++;
            }
        }

        function finishHealthMatching() {
            $('health-match-overlay').style.display = 'none';

            const results = healthMatchResults;
            let html = `<div style="margin-bottom:0.5rem"><strong>${results.matched}/${results.total}</strong> workout(s) gekoppeld</div>`;

            if (results.matched > 0) {
                html += `<div style="color:var(--success)">‚úì ${results.matched} training(en) bijgewerkt met Apple Health data</div>`;

                // Save and sync
                save();
                renderHealthOverview();
                showToast(`${results.matched} training(en) gekoppeld!`);

                // Record import
                healthImports.push({
                    importDate: new Date().toISOString(),
                    matched: results.matched,
                    total: results.total
                });
                localStorage.setItem('liftlog_health_imports', JSON.stringify(healthImports));
            }

            if (results.skipped > 0) {
                html += `<div style="color:var(--text3)">‚óã ${results.skipped} overgeslagen</div>`;
            }

            $('health-import-result').innerHTML = html;
        }

        // Health match modal buttons
        $('health-match-confirm').onclick = () => {
            const item = healthMatchQueue[healthMatchIndex];
            const selectEl = $('health-match-select');

            if (item.bestMatch) {
                applyHealthMatch(item.bestMatch.index);
            } else if (selectEl.style.display !== 'none' && selectEl.value) {
                applyHealthMatch(parseInt(selectEl.value));
            }

            healthMatchIndex++;
            showHealthMatchModal();
        };

        $('health-match-skip').onclick = () => {
            healthMatchResults.skipped++;
            healthMatchIndex++;
            showHealthMatchModal();
        };

        $('health-match-other').onclick = () => {
            const item = healthMatchQueue[healthMatchIndex];
            const selectEl = $('health-match-select');
            const trainingDiv = $('health-match-training');

            // Show all trainings from same week as options
            const workoutDate = item.workout.startTime;
            const weekStart = new Date(workoutDate);
            weekStart.setDate(workoutDate.getDate() - workoutDate.getDay());
            const weekEnd = new Date(weekStart);
            weekEnd.setDate(weekStart.getDate() + 7);

            const weekTrainings = data
                .map((t, idx) => {
                    if (t.isCardio) return null;
                    const tDate = new Date(t.date);
                    if (tDate >= weekStart && tDate <= weekEnd) {
                        return { training: t, index: idx };
                    }
                    return null;
                })
                .filter(Boolean);

            if (weekTrainings.length > 0) {
                trainingDiv.innerHTML = `
                    <div class="health-match-training-label">Selecteer training</div>
                    <div class="health-match-training-name" style="color:var(--text2)">Trainingen van deze week</div>
                `;
                selectEl.innerHTML = '<option value="">-- Selecteer training --</option>' +
                    weekTrainings.map(wt =>
                        `<option value="${wt.index}">${wt.training.lift || 'Training'} ‚Äî ${fmtDate(wt.training.date)}</option>`
                    ).join('');
                selectEl.style.display = 'block';
            } else {
                showToast('Geen trainingen in deze week');
            }
        };

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') inQuotes = !inQuotes;
                else if (char === ',' && !inQuotes) { result.push(current.trim()); current = ''; }
                else current += char;
            }
            result.push(current.trim());
            return result;
        }

        function parseHealthDate(dateStr) {
            if (!dateStr) return null;
            // Try various formats
            // ISO: 2025-12-30T14:30:00
            // Auto Health Export: "2025-12-30 15:04"
            // US: 12/30/2025 2:30 PM
            // EU: 30-12-2025 14:30
            let d = new Date(dateStr);
            if (!isNaN(d.getTime())) return d;

            // Try DD-MM-YYYY HH:MM or DD/MM/YYYY HH:MM
            const match = dateStr.match(/(\d{1,2})[-\/](\d{1,2})[-\/](\d{4})\s*(\d{1,2}):(\d{2})/);
            if (match) {
                const [, day, month, year, hour, min] = match;
                return new Date(year, month - 1, day, hour, min);
            }
            return null;
        }

        // Export
        function updateWeekSelect() {
            const weeks = [...new Set(data.map(t => t.week))].sort((a,b) => a-b);
            $('week-select').innerHTML = '<option value="all">Alle weken</option>' + weeks.map(w => `<option value="${w}">Week ${w}</option>`).join('');
        }
        updateWeekSelect();

        $('export-btn').onclick = () => {
            if (!data.length) { showToast('Geen data'); return; }
            const wk = $('week-select').value;
            const exp = wk === 'all' ? data : data.filter(t => t.week == wk);
            if (!exp.length) { showToast('Geen data'); return; }
            let csv = 'Datum,Dag,Lift,Week,Oefening,Type,Set,Gewicht,Reps,Tijd,Warmup,Equipment,Skipped,Notes\n';
            exp.forEach(t => {
                t.exercises.forEach(ex => {
                    if (ex.type === 'check') csv += `${t.date},${t.day},${t.lift},${t.week},${ex.name},check,,,,,,${ex.skipped||false},"${(ex.notes||'').replace(/"/g,'""')}"\n`;
                    else if (ex.skipped) csv += `${t.date},${t.day},${t.lift},${t.week},${ex.name},${ex.type},,,,,,true,"${(ex.notes||'').replace(/"/g,'""')}"\n`;
                    else ex.sets?.forEach((s,i) => { csv += `${t.date},${t.day},${t.lift},${t.week},${ex.name},${ex.type},${i+1},${s.w||''},${s.r||''},${s.t||''},${s.warmup?'ja':'nee'},${ex.equip||''},false,"${(ex.notes||'').replace(/"/g,'""')}"\n`; });
                });
            });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(new Blob([csv], {type:'text/csv'}));
            a.download = `liftlog_${wk==='all'?'all':'week'+wk}_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            showToast('Ge√´xporteerd!');
        };

        // Import
        $('import-btn').onclick = () => $('file-input').click();
        $('file-input').onchange = e => {
            const file = e.target.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = ev => {
                try {
                    const lines = ev.target.result.split('\n').filter(l => l.trim());
                    if (lines.length < 2) { showToast('Leeg'); return; }
                    const imp = {};
                    for (let i = 1; i < lines.length; i++) {
                        const parts = lines[i].match(/(".*?"|[^,]+)/g) || [];
                        const [date,day,lift,week,exName,type,setNum,w,r,t,warmup,equip,skipped,notes] = parts.map(p => p.replace(/^"|"$/g, '').replace(/""/g, '"'));
                        const key = date+'_'+day;
                        if (!imp[key]) imp[key] = {id:Date.now()+i,date,day,lift,week:+week||1,exercises:[]};
                        let ex = imp[key].exercises.find(e => e.name === exName);
                        if (!ex) { ex = {name:exName,type,sets:[],done:false,skipped:skipped==='true',notes:notes||''}; if (equip) ex.equip = equip; imp[key].exercises.push(ex); }
                        if (type === 'check') ex.done = warmup==='true'||warmup==='ja';
                        else if (setNum && skipped !== 'true') ex.sets.push({w:w||'',r:r||'',t:t||'',warmup:warmup==='ja'});
                    }
                    const arr = Object.values(imp).sort((a,b) => new Date(b.date)-new Date(a.date));
                    if (!arr.length) { showToast('Geen data'); return; }
                    if (confirm(`${arr.length} trainingen.\n\nOK = Toevoegen\nAnnuleren = Vervangen`)) {
                        const keys = new Set(data.map(t => t.date+'_'+t.day));
                        data = [...data, ...arr.filter(t => !keys.has(t.date+'_'+t.day))].sort((a,b) => new Date(b.date)-new Date(a.date));
                    } else data = arr;
                    save(); showToast('Ge√Ømporteerd!'); updateWeekSelect(); updateDayButtons(); renderHistory();
                } catch(err) { console.error(err); showToast('Fout'); }
            };
            reader.readAsText(file);
            e.target.value = '';
        };

        // Logo taps: 3x = kopieer UID, 5x = reset
        let logoTaps = 0;
        document.querySelector('.logo').onclick = () => {
            logoTaps++;
            setTimeout(() => logoTaps = 0, 600);
            if (logoTaps === 3 && firebaseUid) {
                navigator.clipboard.writeText(firebaseUid).then(() => {
                    showToast('UID gekopieerd: ' + firebaseUid);
                });
            } else if (logoTaps >= 5) {
                if (confirm('LocalStorage resetten? Dit verwijdert alle trainingsdata!')) {
                    localStorage.removeItem('liftlog3');
                    location.reload();
                }
            }
        };

        // Load exercises from JSON and init
        async function loadExercises() {
            try {
                const response = await fetch('data/exercises.json');
                const json = await response.json();
                // Filter out comment fields
                Object.keys(json).forEach(key => {
                    if (!key.startsWith('_')) {
                        EXERCISES[key] = json[key];
                    }
                });
                console.log(`Loaded ${Object.keys(EXERCISES).length} exercises`);
            } catch (err) {
                console.error('Failed to load exercises:', err);
                showToast('Kon oefeningen niet laden');
            }
        }

        // Init
        loadExercises().then(() => {
            renderHistory();
            renderExercises();
            renderHealthOverview();
        });
    })();
    </script>
</body>
</html>
